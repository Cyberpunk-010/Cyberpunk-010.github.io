---
title:  "TIL: ptmalloc2 ğŸ—ƒï¸ "
excerpt: "2022.08.19 TIL âœ"
toc: true
toc_sticky: true

categories:
  - TIL
  - Hacking
---
[https://dreamhack.io/lecture/courses/98](https://dreamhack.io/lecture/courses/98)

## ptmalloc2

**ptmalloc2**ëŠ” Linuxì˜ **Memory Allocator**ì´ë‹¤. ptmalloc2ëŠ” memoryë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì•„ë˜ ì„¸ ê°€ì§€ íŠ¹ì§•ì„ ê°–ëŠ”ë‹¤:

1. Memory ë‚­ë¹„ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ memory allocation ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ìš°ì„  **freeëœ block ì¤‘ì—ì„œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” blockì´ ìˆëŠ”ì§€ í™•ì¸**í•œë‹¤.
2. **tcache**ì™€ **bin**ì´ë¼ëŠ” linked listì— **freeëœ blockë“¤ì˜ ì •ë³´ë¥¼ ì €ì¥**í•œë‹¤. 
3. Fragmentationì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ **alignment, coalescence, split**ì„ ì‚¬ìš©í•œë‹¤. 64 bit machineì—ì„œ ptmalloc2ëŠ” memory ê³µê°„ì„ **16 byte ë‹¨ìœ„ë¡œ í• ë‹¹**í•œë‹¤.

### Chunk

**Chunk**ëŠ” ptmallocì´ allocateí•˜ê³  freeí•˜ëŠ” **block**ì„ ì˜ë¯¸í•œë‹¤. Headerì™€ dataë¡œ êµ¬ì„±ë˜ëŠ”ë°, **header**ëŠ” ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ëœë‹¤.

<p align="center">
	<a href="/assets/images/TIL220819/Untitled.png">
		<img src="/assets/images/TIL220819/Untitled.png" width="500">
   	</a>
</p>
### bin

**bin**ì€ **freed chunkê°€ ì €ì¥ë˜ëŠ” ì—°ê²° ë¦¬ìŠ¤íŠ¸**ë“¤ì´ë‹¤. ptmallocì—ëŠ” ì´ **128ê°œì˜ bin**ë“¤ì´ ì •ì˜ë˜ì–´ ìˆëŠ”ë°, ì´ ì¤‘ 62ê°œëŠ” **smallbin**, 63ê°œëŠ” **largebin**, 1ê°œëŠ” **unsortedbin**ì´ê³ , ë‚˜ë¨¸ì§€ 2ê°œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

<p align="center">
	<a href="/assets/images/TIL220819/Untitled (1).png">
		<img src="/assets/images/TIL220819/Untitled (1).png" width="400">
   	</a>
</p>

### smallbin

- **32 byte ~ 1008 byte** í¬ê¸°ì˜ chunkê°€ ì €ì¥ë¨.
- ê° bin ë³„ë¡œ **ì •í•´ì§„ í¬ê¸°ì˜ chunkë§Œì´ ì €ì¥**ë˜ë©°, indexê°€ ì¦ê°€í•¨ì— ë”°ë¼ ì €ì¥ë˜ëŠ” chunkì˜ í¬ê¸°ëŠ” 16 byteì”© ì¦ê°€í•œë‹¤. (smallbin[0]ì—ëŠ” 32 byte, smallbin[61]ì—ëŠ” 1008 byteì˜ chunkê°€ ì €ì¥ëœë‹¤.)
- **Circular doubly linked list**ì´ë©°, **FIFO** ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤. (ë¨¼ì € freeëœ chunkê°€ ë¨¼ì € allocationì„ ìœ„í•´ ì‚¬ìš©ëœë‹¤.) (FIFOëŠ” ì†ë„, fragmentation ë‘˜ ë‹¤ ì¤‘ê°„)
- **coalescence**ê°€ ì¼ì–´ë‚œë‹¤. ptmalloc2ì—ì„œëŠ” **consolidation**ì´ë¼ëŠ” ìš©ì–´ë¥¼ ì‚¬ìš©í•œë‹¤.

### fastbin

- smallbin, largebin, unsortedbinê³¼ëŠ” ë³„ë„ë¡œ ì¡´ì¬í•˜ëŠ” binìœ¼ë¡œ, ì‘ì€ chunkê°€ ë°˜ë³µì ìœ¼ë¡œ allocate ë° freeë  ë•Œ **ë¹ ë¥´ê²Œ** ì‘ë™í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ ì¡´ì¬í•œë‹¤.
- **32 byte ~ 176 byte** í¬ê¸°ì˜ chunkê°€ ì €ì¥ë¨. 16 byteì”© ëŠì–´ ì´ 10ê°œì˜ fastbinì´ ì¡´ì¬í•˜ëŠ”ë°, linuxëŠ” ì´ ì¤‘ **ì‘ì€ í¬ê¸°ë¶€í„° 7ê°œë§Œì„ ì‚¬ìš©**í•œë‹¤. ì¦‰, 32 byte ~ 128 byteì˜ chunkë“¤ì„ ì €ì¥í•œë‹¤.
- **Singly linked list**ì´ë©°, **LIFO** ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤. (LIFOëŠ” ì†ë„ëŠ” ë¹ ë¥´ì§€ë§Œ fragmentationì´ ì‹¬í•˜ë‹¤.)
- **NO coalescence**

### largebin

- **1024 byte ì´ìƒ**ì˜ í¬ê¸°ë¥¼ ê°–ëŠ” chunkê°€ ì €ì¥ëœë‹¤.
- ê° binì— **ì¼ì • ë²”ìœ„ ì•ˆì˜ í¬ê¸°ë¥¼ ê°–ëŠ” ëª¨ë“  chunkê°€ ì €ì¥**ëœë‹¤. ì´ ë²”ìœ„ëŠ” indexê°€ ì¦ê°€í• ìˆ˜ë¡ **ë¡œê·¸ì **ìœ¼ë¡œ ì¦ê°€í•œë‹¤. (largebin[0]ëŠ” 1024 ~ 1088 byte, largebin[32]ëŠ” 3072 ~ 3584 byte)
- **Circular doubly linked list**ì´ë©°, **best-fit** ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤. (ì†ë„ê°€ ëŠë¦¬ì§€ë§Œ fragmentationì´ ê°€ì¥ ì ìŒ)
- **coalescence**ê°€ ì¼ì–´ë‚œë‹¤.

### unsortedbin

- **ë¶„ë¥˜ë˜ì§€ ì•Šì€ chunkë“¤**ì„ ë³´ê´€í•˜ëŠ” binì´ë‹¤. **í•˜ë‚˜ë§Œ ì¡´ì¬**í•˜ë©°, fastbinì— ë“¤ì–´ê°€ì§€ ì•ŠëŠ” ëª¨ë“  chunkë“¤ì€ ì´ binì— ë³´ê´€ëœë‹¤.
- **Circular doubly linked list**ì´ë©°, ë‚´ë¶€ëŠ” **ì •ë ¬ë˜ì–´ ìˆì§€ ì•Šë‹¤**.
- **smallbin** í¬ê¸°ì— í•´ë‹¹í•˜ëŠ” ì²­í¬ë¥¼ í• ë‹¹ ìš”ì²­í•˜ë©´, ptmallocì€ **fastbin ë˜ëŠ” smallbinì„ íƒìƒ‰**í•œ ë’¤ **unsortedbinì„ íƒìƒ‰**í•œë‹¤.
- **largebin** í¬ê¸°ì— í•´ë‹¹í•˜ëŠ” chunkëŠ” unsortedbinì„ ë¨¼ì € íƒìƒ‰í•œë‹¤. ì´ ê³¼ì •ì—ì„œ **íƒìƒ‰ëœ chunkë“¤ì€ ê°ìì˜ í¬ê¸°ì— ë”°ë¼ ì ì ˆí•œ binìœ¼ë¡œ ì´ë™**ëœë‹¤.
- ë¶ˆí•„ìš”í•œ ì—°ì‚°ì„ ì¤„ì´ê¸° ìœ„í•´ ì¡´ì¬í•œë‹¤.

### arena

**arena**ëŠ” **fastbin, smallbin, largebinë“±ì˜ ì •ë³´ë¥¼ ëª¨ë‘ ë‹´ê³  ìˆëŠ” ê°ì²´**ì´ë‹¤. 

**Multi thread** í™˜ê²½ì—ì„œ **race condition**ì„ ë§‰ê¸° ìœ„í•´ **arena**ì— **lock**ì„ ì ìš©í•˜ëŠ”ë° (mutex ê°™ì€), ì´ ë°©ì‹ì€ ì†ë„ë¥¼ ì €í•˜ì‹œí‚¤ë¯€ë¡œ **ìµœëŒ€ 64ê°œì˜ arenaë¥¼ ìƒì„±**í•  ìˆ˜ ìˆë„ë¡ ë˜ì–´ ìˆë‹¤. ê·¸ëŸ¬ë‚˜, ì´ë³´ë‹¤ ê³¼ë„í•œ multi thread í™˜ê²½ì—ì„œëŠ” 64ê°œì˜ arenaë„ ë¶€ì¡±í•˜ë¯€ë¡œ ì†ë„ ì €í•˜ê°€ ì¼ì–´ë‚œë‹¤. â‡’ **GLibc 2.26ì—ì„œëŠ” tcacheë¥¼ ì¶”ê°€ë¡œ ë„ì…**í–ˆë‹¤.

### tcache

- **Thread local cache**ì˜ ì•½ìì´ë‹¤. **ê° threadì— ë…ë¦½ì ìœ¼ë¡œ í• ë‹¹ë˜ëŠ” cache ì €ì¥ì†Œ**ì´ë‹¤.
- ê° threadëŠ” **64ê°œì˜ tcache**ë¥¼ ê°–ëŠ”ë‹¤. í•˜ë‚˜ì˜ tcacheëŠ” **ê°™ì€ í¬ê¸°ì˜ chunkë§Œì„ ì €ì¥**í•œë‹¤. ê°ê° **ìµœëŒ€ 7ê°œì˜ chunk**ë¥¼ ë„£ì„ ìˆ˜ ìˆë‹¤.
- **32 byte ~ 1040 byte** í¬ê¸°ì˜ chunkë“¤ì´ ë³´ê´€ëœë‹¤. ì´ ë²”ìœ„ì˜ chunkë“¤ì€ **allocate ë° freeë  ë•Œ tcacheë¥¼ ê°€ì¥ ë¨¼ì € ì¡°íšŒ**í•œë‹¤. chunkê°€ ê°€ë“ ì°¼ì„ ë• binì„ ì‚¬ìš©í•œë‹¤.
- **Singly linked list**ì´ë©°, **LIFO** ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.
- ê° thread ë³„ë¡œ ê°–ëŠ” cacheì´ë¯€ë¡œ **arenaì˜ binì„ ì‚¬ìš©í•  ì¼ì´ ì¤„ì–´ë“ ë‹¤**. â†’ **arena ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ì†ë„ ì €í•˜ê°€ ì¤„ì–´ë“ ë‹¤**.