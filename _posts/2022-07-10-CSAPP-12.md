---
title:  "CS:APP Chapter 12 Summary 🧙"
excerpt: "Chatper 12 - Concurrent Program"
toc: true
classes: wide

categories:
  - CSAPP

---
Recently, I've been studying CS:APP - I'm posting my own summary of chapter 12 that I wrote up using [Notion](https://cw00h.notion.site/CS-APP-6d3c5c01e6e1456ca51f594a80b5c1f0).

<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Chapter 12 : Concurrent Programming</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */

.Notion strong {
    font-weight: 600;
}

.Notion a,
.Notion a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

.Notion h1,
.Notion h2,
.Notion h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
    display: flex;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

.Notion h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

.Notion h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

.Notion h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

.Notion figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

.Notion figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

.Notion mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

.Notion hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

.Notion img {
	max-width: 100%;
}

@media only print {
	.Notion img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

.Notion table,
.Notion th,
.Notion td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

.Notion table {
	border-left: none;
	border-right: none;
}

.Notion th,
.Notion td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

.Notion th {
	color: rgba(55, 53, 47, 0.6);
}

.Notion ol,
.Notion ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

.Notion li > ol:first-child,
.Notion li > ul:first-child {
	margin-block-start: 0.6em;
}

.Notion ul > li {
	list-style: disc;
}

.Notion ul.to-do-list {
	text-indent: -1.7em;
}

.Notion ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

.Notion ul.toggle > li {
	list-style: none;
}

.Notion ul {
	padding-inline-start: 1.7em;
}

.Notion ul > li {
	padding-left: 0.1em;
}

.Notion ol {
	padding-inline-start: 1.6em;
}

.Notion ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

.Notion time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

.Notion img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

.Notion p > .user {
	opacity: 0.5;
}

.Notion td > .user,
.Notion td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

.Notion p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
.Notion code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

.Notion code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

.Notion blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="c3d42996-d973-4c1a-a02c-e2151cfbe2f2" class="page sans Notion" style="width: 100%; padding: 0px;"><div class="page-body"><h2 id="631ec54f-ee58-4d8b-839d-b7362cf03567" class=""><details open=""><summary><mark class="highlight-blue">12.1</mark> Concurrent Programming with Processes</summary></details></h2><div class="indented"><p id="e0d8fbff-dc9c-4f60-80d4-b4ee839422d6" class="">We can build a <strong>concurrent program</strong> with <strong>processes</strong>, using familiar functions such as <code>fork</code>, <code>exec</code>, and <code>waitpid</code>.</p><p id="f0abd144-33d5-462d-b0b5-c41d767e56ad" class="">(<em>example : accepting client connection requests in the parent and then creating a new child process to </em><strong><em>service each new client</em></strong><em>.</em>)</p><pre id="7af9ab5e-373b-4092-bb28-4fe645b4bdd7" class="code"><code>#include &quot;csapp.h&quot;

void echo(int connfd);

void sigchld_handler(int sig) {
  while (waitpid(-1, 0, WNOHANG) &gt; 0) ;
  return;
}

int main(int argc, char **argv) {
  int listenfd, connfd;
  socklen_t clientlen;
  sockaddr_storage clientaddr;

  if (argc != 2) {
    fprintf(stderr, &quot;usage: %s &lt;port&gt;\n&quot;, argv[0]);
    exit(0);
  }
  
  Signal(SIGCHLD, sigchld_handler);
  listenfd = Open_listenfd(argv[1]);
  while (1) {
    clientlen = sizeof(sockaddr_storage);
    connfd = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);
    if (Fork() == 0) {
      Close(listenfd); /* Child closes its listening socket */
      echo(connfd); /* Child services client */
      Close(connfd); /* Child closes connection with client */
      exit(0); /* Child exits */
    }
    Close(connfd); /* Parent closes connected socket */
  }
}</code></pre><ul id="2f169500-3101-4277-bcd5-123d0523fa49" class="bulleted-list"><li style="list-style-type:disc">After accepting the connection request, the <strong>child</strong> <strong>closes </strong>its copy of <strong>listening descriptor</strong>, and the <strong>parent closes </strong>its copy of <strong>connected descriptor</strong>, since they are no longer needed.</li></ul><ul id="a48429b7-ef88-4149-982a-60008621c714" class="bulleted-list"><li style="list-style-type:disc">We must include a <strong>SIGCHLD handler</strong> that reaps zombie children. Since Linux signals are <strong>not queued</strong>, the handler must be able to <strong>reap multiple zombie children</strong>.</li></ul><ul id="8535a50b-0c6b-46fd-867c-ce056a04cc4d" class="bulleted-list"><li style="list-style-type:disc"><strong>The parent and the child must close their respective copies of </strong><strong><code>connfd</code></strong><strong> respectively.</strong></li></ul><ul id="10e0aa24-2c35-4da7-a928-a71ef954825c" class="bulleted-list"><li style="list-style-type:disc"><strong>Pros and Cons of Concurrent Programming Using Processes</strong><ul id="377348b7-0fab-4370-9c26-03962fe8e430" class="bulleted-list"><li style="list-style-type:circle">Pros - It’s <strong>impossible </strong>for one process to <strong>overwrite </strong>the virtual memory of another process.</li></ul><ul id="f8b753de-c1a6-44d8-aa84-e6ad834056b7" class="bulleted-list"><li style="list-style-type:circle">Cons - It’s difficult for <strong>processes </strong>to <strong>share state information</strong>. To share information, they must use explicit <strong>IPC mechanisms</strong>.</li></ul><ul id="fbfff115-c3ef-4fd1-ae6c-1f354644fe3e" class="bulleted-list"><li style="list-style-type:circle">Cons - Process-based designs tend to be <strong>slower </strong>because the <strong>overhead for process control and IPC is high</strong>. </li></ul></li></ul></div><h2 id="d3fe79d6-0456-43c9-b1e1-1fe8a6d5d3b9" class=""><details open=""><summary><mark class="highlight-blue">12.2</mark> Concurrent Programming with I/O Multiplexing</summary></details></h2><div class="indented"><ul id="db28a49e-be62-4bf7-a621-73cefab40fc1" class="toggle"><li><details open=""><summary><strong>I/O Multiplexing</strong></summary><ul id="d010e113-888a-4310-ac8b-de594d20d1bd" class="bulleted-list"><li style="list-style-type:disc"><strong>I/O multiplexing</strong>’s basic idea is to use the <strong><code>select</code></strong><strong> function </strong>to ask the kernel to <strong>suspend the process</strong>, returning control to the application only after one or more <strong>I/O events have occurred</strong>, as in the following examples: <ul id="4d459961-4be6-40b5-87dd-8dbad911d1a2" class="bulleted-list"><li style="list-style-type:circle">Return when any descriptor in the set {0, 4} is <strong>ready for reading</strong>.</li></ul><ul id="a813d0f5-3d12-454f-b133-fe19c6c84ea9" class="bulleted-list"><li style="list-style-type:circle">Return when any descriptor in the set {1, 2, 7} is <strong>ready for writing</strong>.</li></ul><ul id="224db76a-80f6-4566-b8d7-7cf01e10edef" class="bulleted-list"><li style="list-style-type:circle"><strong>Time out </strong>if 152.13 seconds have elapsed waiting for an I/O event to occur.</li></ul></li></ul><ul id="6c9eeaa2-44a4-4007-b053-8a65a86ed9af" class="bulleted-list"><li style="list-style-type:disc"><strong><code>Select</code></strong><ul id="f2274200-edd0-455a-a94c-b0dffe146fa1" class="bulleted-list"><li style="list-style-type:circle">We will only discuss the first scenario : <strong>waiting for a set of descriptor to be ready for reading</strong>.</li></ul><pre id="969f363e-94e8-48cd-8f25-bdf24fd12de2" class="code"><code>#include &lt;sys/select.h&gt;

int select(int n, fd_set *fdset, NULL, NULL, NULL);

/* Macros for manipulating descriptor sets */
FD_ZERO(fd_set *fdset);
FD_CLR(int fd, fd_set *fdset);
FD_SET(int fd, fd_set *fdset);
FD_ISSET(int fd, fd_set *fdset);</code></pre><ul id="7efb7215-14c0-48e6-8fbf-95a4a8106938" class="bulleted-list"><li style="list-style-type:circle"><strong>Descriptor set </strong><strong><code>fd_set</code></strong><strong> </strong>is a <strong>bit vector </strong>of size <code>n</code>: <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_{n-1},...,b_1,b_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> - Each bit <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">b_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> corresponds to <strong>descriptor </strong><strong><em>k</em></strong>. Descriptor <em>k</em> is a <strong>member </strong>of the set if and only if <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>k</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">b_k=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span><span>﻿</span></span>.</li></ul><ul id="81a2452d-d5d3-40a4-ae00-3aa43d1cb6f0" class="bulleted-list"><li style="list-style-type:circle"><code>select</code> takes <strong>2 inputs</strong>: <code>fdset</code> called the <strong>read set</strong>, and the <strong>cardinality (</strong><strong><code>n</code></strong><strong>) of the read set</strong>.</li></ul><ul id="da4ed0e1-0558-418a-8608-1e86d3981dde" class="bulleted-list"><li style="list-style-type:circle"><code>select</code> <strong>blocks </strong>until at least one descriptor in the read set is <strong>ready for reading </strong>(= a request to read 1 byte from that descriptor wouldn’t block).</li></ul><ul id="f726ecf0-ca02-4982-bca2-633a92b3ad78" class="bulleted-list"><li style="list-style-type:circle"><code>select</code> <strong>modifies the argument </strong><strong><code>fdset</code></strong><strong> </strong>to indicate a subset of the read set called the <strong>ready set</strong>, consisting of the descriptors in the read set that are <strong>ready for reading</strong>.</li></ul></li></ul><ul id="0f080112-42a4-4cfc-b9c6-91577385de68" class="bulleted-list"><li style="list-style-type:disc"><strong>Example Code - An iterative echo server that uses I/O multiplexing</strong><pre id="71645838-60c7-4d24-b5a8-ce9c854455f4" class="code"><code>#include &quot;csapp.h&quot;
void echo(int connfd);
void command(void);

int main(int argc, char **argv) {
	int listenfd, connfd;
  socklen_t clientlen;
  struct sockaddr_storage clientaddr;
  fd_set read_set, ready_set;

  if (argc != 2) {
		fprintf(stderr, &quot;usage: %s &lt;port&gt;\n&quot;, argv[0]);
    exit(0);
  }
  listenfd = Open_listenfd(argv[1]);
  
  FD_ZERO(&amp;read_set); /* Clear read set */
  FD_SET(STDIN_FILENO, &amp;read_set); /* Add stdin to read set */
  FD_SET(listenfd, &amp;read_set); /* Add listenfd to read set */

	while (1) {
    ready_set = read_set;
    Select(listenfd+1, &amp;ready_set, NULL, NULL, NULL);
    if (FD_ISSET(STDIN_FILENO, &amp;ready_set)) command(); /* Read command line from stdin */
    if (FD_ISSET(listenfd, &amp;ready_set)) {
      clientlen = sizeof(struct sockaddr_storage);
      connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);
      echo(connfd); /* Echo client input until EOF */
      Close(connfd);
    }
  }
}

void command(void) {
  char buf[MAXLINE];
  if (!Fgets(buf, MAXLINE, stdin)) exit(0); /* EOF */
  printf(&quot;%s&quot;, buf); /* Process the input command */
}</code></pre><ul id="8d4da3c7-9b32-4c8e-9fb9-fc783c3573a2" class="bulleted-list"><li style="list-style-type:circle">In the <strong>infinite server loop</strong>, instead of calling the <code>accept</code> function, we call the <strong><code>select</code></strong><strong> </strong>which <strong>blocks until either the listening descriptor or standard input is ready for reading</strong>.</li></ul><ul id="e2151907-8918-41ca-ae05-12a727710abb" class="bulleted-list"><li style="list-style-type:circle">Once this program connects to a client, it <strong>continues echoing</strong> input lines <strong>until the client closes</strong> <strong>its end of the connection</strong>. <p id="ec963954-80e3-4631-a115-054ea14c1aec" class="">→ If you type a command to standard input, you <strong>won’t get a response</strong> until the server is finished with the client. </p><p id="482867d9-4c64-4ed6-a202-9b4e029748a1" class="">→ <strong>Multiplex at a finer granularity</strong>, echoing at most <strong>one text line each time</strong> through the server loop.</p></li></ul></li></ul></details></li></ul><ul id="daa89c93-d41e-477a-9ea6-d401c775217b" class="toggle"><li><details open=""><summary><strong>A Concurrent Event-Driven Server Based on I/O Multiplexing</strong></summary><p id="e61f7279-4121-4765-9058-7e984741cb0c" class=""><strong>I/O multiplexing</strong> can be used as the basis for <strong>concurrent event-driven programs</strong>, which models logical flows as <strong>state machines</strong>.</p><ul id="16a1c6d2-94fe-47b5-bb84-bc8e2a28e91d" class="bulleted-list"><li style="list-style-type:disc"><strong>State Machine</strong><ul id="5496ee27-58a9-4aea-b05c-9951f3b843b0" class="bulleted-list"><li style="list-style-type:circle">A <strong>state machine</strong> is a collection of <strong>states, input events, and transitions</strong> that map (input state, input event) pair to an output state.</li></ul><ul id="ff7303dd-a8ce-4720-855b-b29e917282e0" class="bulleted-list"><li style="list-style-type:circle">Each <strong>input event</strong> triggers a <strong>transition </strong>from the current state to the next state.</li></ul></li></ul><ul id="3c3ae997-e4cc-4492-b784-c9aa4060c054" class="bulleted-list"><li style="list-style-type:disc"><strong>Concurrent server based on I/O multiplexing</strong><figure id="0f0f2596-ba91-4eb6-abdc-d4cf283affe8" class="image"><a href="/assets/images/CSAPP-12/Untitled.png"><img style="width:336px" src="/assets/images/CSAPP-12/Untitled.png"/></a></figure><ul id="870175c7-cdb8-48e9-984c-f9e668aa9c50" class="bulleted-list"><li style="list-style-type:circle">For each new client <em>k</em>, the server <strong>creates a new state machine </strong><strong><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">s_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span></strong><strong> </strong>and associates it with connected descriptor <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>.</li></ul><ul id="c2c8dd1d-1dae-4353-8479-151f17ae9568" class="bulleted-list"><li style="list-style-type:circle">The multiplexing to detect the occurrence of <strong>input events</strong>. - As each <strong>connected descriptor becomes ready</strong> for reading, the server executes the <strong>transition </strong>- <strong>reading and echoing a text line</strong> from the descriptor.</li></ul></li></ul><ul id="cd3d5263-f07e-4dac-91c2-5c34ae56febc" class="bulleted-list"><li style="list-style-type:disc"><strong>Example Code - Concurrent echo server based on I/O multiplexing</strong><ul id="b15a8fae-5fa4-4f03-95bf-379a8c66f086" class="bulleted-list"><li style="list-style-type:circle"><code>main</code><pre id="c58aaca5-140d-4d31-b206-623303ceb160" class="code"><code>#include &quot;csapp.h&quot;

typdef struct { /* Represents a pool of connected descriptors */
  int maxfd; /* Largest descriptor in read_set */
  fd_set read_set; /* Set of all active descriptors */
  fd_set ready_set; /* Subset of descriptor ready for reading */
  int nready; /* Number of ready descriptors from select */
  int maxi; /* High water index into client array */
  int clientfd[FD_SETSIZE]; /* Set of active descriptors */
  rio_t clientrio[FD_SETSIZE]; /* Set of active read buffers */
} pool;

int byte_cnt = 0; /* Counts total bytes received by server */

int main(int argc, char **argv) {
  int listenfd, connfd;
  socklen_t clientlen;
  struct sockaddr_storage clientaddr;
  static pool pool;

  if (argc != 2) {
    fprintf(stderr, &quot;usage: %s &lt;port&gt;\n&quot;, argv[0]);
    exit(0);
  }
  listenfd = Open_listenfd(argv[1]);
  init_pool(listenfd, &amp;pool);
  
  while(1) {
    /* Wait for listening/connected descriptor(s) to become ready */
    pool.ready_set = pool.read_set;
    pool.nready = Select(pool.maxfd+1, &amp;pool.ready_set, NULL, NULL, NULL);
    
    /* If listening descriptor ready, add new client to pool */
    if (FD_ISSET(listenfd, &amp;pool.ready_set)) {
      clientlen = sizeof(struct sockaddr_storage);
      connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);
      add_client(connfd, &amp;pool);
    }
    
    /* Echo a text line from each ready connected descriptor */
    check_clients(&amp;pool);
  }
}</code></pre></li></ul><ul id="d2b318d7-701c-499b-98f0-fdffa7a13ea1" class="bulleted-list"><li style="list-style-type:circle"><code>init_pool</code><pre id="e325c320-1195-4a7b-abad-55bc49afac89" class="code"><code>void init_pool(int listenfd, pool *p) {
  /* Initially, there are no connected descriptors */
  int i;
  p-&gt;maxi = -1;
  for (i=0; i&lt; FD_SETSIZE; i++) p-&gt;clientfd[i] = -1;
  
  /* Initially, listenfd is only member of select read set */
  p-&gt;maxfd = listenfd;
  FD_ZERO(&amp;p-&gt;read_set);
  FD_SET(listenfd, &amp;p-&gt;read_set);
}</code></pre><ul id="4a8e66b2-d1bb-408c-9fa0-cade4e83da4c" class="bulleted-list"><li style="list-style-type:square"><code>clientfd</code> represents a set of connected descriptors, with the integer -1 denoting an available slot.</li></ul></li></ul><ul id="2c34970f-3c48-4849-abab-863fab9e1a6f" class="bulleted-list"><li style="list-style-type:circle"><code>add_client</code><pre id="75180276-4ea4-41d2-bcfe-f875839cdde2" class="code"><code>void add_client(int connfd, pool *p) {
  int i;
  p-&gt;nready--;
  for (i = 0; i &lt; FD_SETSIZE; i++) /* Find an available slot */
    if (p-&gt;clientfd[i] &lt; 0) {
      /* Add connected descriptor to the pool */
			p-&gt;clientfd[i] = connfd;
			Rio_readinitb(&amp;p-&gt;clientrio[i], connfd);
			
			/* Add the descriptor to descriptor set */
			FD_SET(connfd, &amp;p-&gt;read_set);
			
			/* Update max descriptor and pool high water mark */
			if (connfd &gt; p-&gt;maxfd) p-&gt;maxfd = connfd;
			if (i &gt; p-&gt;maxi) p-&gt;maxi = i;
			break;
		}
	if (i == FD_SETSIZE) /* Couldn&#x27;t find an empty slot */
		app_error(&quot;add_client error: Too many clients&quot;);
}</code></pre><ul id="adf7a2d5-ad90-439b-a365-a5bbfb2a83a9" class="bulleted-list"><li style="list-style-type:square"><code>p-&gt;nready--</code> : <code>nready</code> includes <strong>listening descriptor</strong> as a descriptor ready for reading, which is actually <strong>not</strong>.</li></ul></li></ul><ul id="1a72def6-e8ed-42eb-9ec4-11d8a31a1b4d" class="bulleted-list"><li style="list-style-type:circle"><code>check_clients</code><pre id="1ad53297-c97b-4e79-a47d-16c6c9116292" class="code"><code>void check_clients(pool *p) {
  int i, connfd, n;
  char buf[MAXLINE];
  rio_t rio;
  
  for (i = 0; (i &lt;= p-&gt;maxi) &amp;&amp; (p-&gt;nready &gt; 0); i++) {
		connfd = p-&gt;clientfd[i];
		rio = p-&gt;clientrio[i];

		/* If the descriptor is ready, echo  text line from it */
		if ((connfd &gt; 0) &amp;&amp; (FD_ISSET(connfd, &amp;p-&gt;ready_set))) {
			p-&gt;nready--;
			if ((n = Rio_readlineb(&amp;rio, buf, MAXLINE)) != 0) {
				byte_cnt += n;
				printf(&quot;Server received %d (%d total) bytes on fd %d\n&quot;, n, byte_cnt, connfd);
				Rio_writen(connfd, buf, n);
			}

			/* EOF detected, remove descriptor from pool */
			else {
				Close(connfd);
				FD_CLR(connfd, &amp;p-&gt;read_set);
				p-&gt;clientfd[i] = -1;
			}
		}
	}
}</code></pre><ul id="09882e85-e452-4602-a869-27631b42a18e" class="bulleted-list"><li style="list-style-type:square"><code>check_clients</code> <strong>echoes a text line</strong> from <strong>each ready connected descriptor</strong>. </li></ul><ul id="c13550c1-a4ed-4cdc-93da-ea31cb68ae6d" class="bulleted-list"><li style="list-style-type:square">If we detect <strong>EOF </strong>because the client has closed its end of the connection, we <strong>close our end of the connection</strong> and <strong>remove the descriptor</strong> from the <strong>pool</strong>.</li></ul></li></ul><ul id="30e9dafb-a23d-42fa-a043-7763be50771c" class="bulleted-list"><li style="list-style-type:circle">In terms of the <strong>finite state model</strong>, <code>select</code> detects input events, and the <code>add_client</code> creates a new state machine. <code>check_clients</code> performs state transitions and deletes the state machine when the client has finished sending text lines.</li></ul></li></ul></details></li></ul><ul id="d2e68286-4719-46bf-8c2a-8fffdbe9a0fc" class="toggle"><li><details open=""><summary><strong>Pros and Cons of I/O Multiplexing</strong></summary><ul id="ceddac43-07f6-4131-a851-9ce28b33b554" class="bulleted-list"><li style="list-style-type:disc"><strong>Pros of I/O Multiplexing</strong><ul id="e65906ea-5fed-48f3-9282-09e180eb275d" class="bulleted-list"><li style="list-style-type:circle">Event-driven designs <strong>give programmers more control</strong> over the behavior of their programs than process-based designs.</li></ul><ul id="9ccf3ac4-ef33-44c5-af93-99143ed792d5" class="bulleted-list"><li style="list-style-type:circle">An event-driven server based on I/O multiplexing runs <strong>in the context of a single process.</strong><ul id="719f7e43-4ad8-4caf-b473-571f3923d21b" class="bulleted-list"><li style="list-style-type:square">→ <strong>every logical flow</strong> has <strong>access </strong>to the <strong>entire address space</strong> of the process. → Easy to <strong>share data</strong> between flows</li></ul><ul id="ea7794d3-771d-4205-becf-38b74728e2f1" class="bulleted-list"><li style="list-style-type:square">→ You can <strong>debug </strong>your concurrent server as you would any sequential program.</li></ul></li></ul><ul id="d0208dd0-f078-4137-b4e1-c0ccb51dfe54" class="bulleted-list"><li style="list-style-type:circle">Event-driven designs are often <strong>more efficient</strong> than process-based designs because they <strong>don’t require a process context switch</strong> to schedule a new flow.</li></ul></li></ul><ul id="1791f74e-cd4d-448c-b8b4-00db900087cb" class="bulleted-list"><li style="list-style-type:disc"><strong>Cons of I/O Multiplexing</strong><ul id="b2a20ee7-4300-49c2-a650-dd09f0aa2da1" class="bulleted-list"><li style="list-style-type:circle"><strong>Coding complexity</strong> increases as the <strong>granularity </strong>of the concurrency decreases.<ul id="0c5088a9-9092-4be4-b2ce-285997027e7b" class="bulleted-list"><li style="list-style-type:square"><strong>granularity </strong>= # of instructions that each logical flow executes per time slice. (<em>example : # of instructions required to read an entire text line</em>)</li></ul></li></ul><ul id="460f03d2-9e44-47ae-a21e-a1bac9f873a0" class="bulleted-list"><li style="list-style-type:circle">Can’t fully utilize <strong>multi-core processors</strong>.</li></ul></li></ul></details></li></ul></div><h2 id="6ff9579d-d901-4cd6-a63d-e4e3683cd857" class=""><details open=""><summary><mark class="highlight-blue">12.3</mark> Concurrent Programming with Threads</summary></details></h2><div class="indented"><ul id="ccd79b8a-0bd3-46ea-bdfb-e855d4a9e1e1" class="toggle"><li><details open=""><summary><strong>Thread</strong></summary><p id="07863a6e-0a42-4054-87b0-b3c5a98449a0" class="">A <strong>thread </strong>is a <strong>logical flow</strong> that runs <strong>in the context of a process.</strong></p><ul id="a11ef8ca-dbb4-420b-806f-8dc6c9f99ee6" class="bulleted-list"><li style="list-style-type:disc">The threads are <strong>scheduled </strong>automatically by the <strong>kernel</strong>.</li></ul><ul id="e4045780-1054-44b6-9749-c01850b940fd" class="bulleted-list"><li style="list-style-type:disc">Each thread has its own <strong>thread context </strong>- thread ID (TID), stack, stack pointer, program counter, general-purpose registers, and condition codes.</li></ul><ul id="4c6ceced-e202-4393-8fde-79c050293313" class="bulleted-list"><li style="list-style-type:disc">All threads running in a process<strong> share the entire VAS</strong> of that process.</li></ul></details></li></ul><ul id="b7d1e7db-b0bf-4cad-8507-5d18a40aa4fc" class="toggle"><li><details open=""><summary><strong>Thread Execution Model</strong></summary><ul id="098d306f-9e04-4f8f-9fd0-c6f58f7290dc" class="bulleted-list"><li style="list-style-type:disc">Each process begins life as a <strong>single thread</strong> called the <strong>main thread</strong>, which creates a <strong>peer thread</strong>.</li></ul><ul id="4d807493-2b06-44c2-a579-59e09b611a18" class="bulleted-list"><li style="list-style-type:disc">Control passes to the peer thread via a <strong>context switch</strong>, either because the <strong>main thread executes a slow system call</strong> or because it is <strong>interrupted by the system’s interval timer</strong>.</li></ul><ul id="49df7f7a-563e-47e9-a215-bba2ed6feda4" class="bulleted-list"><li style="list-style-type:disc"><strong>Thread execution vs. processes</strong><ul id="bf48c15f-9b81-47d7-8b80-fc9c7f395fb0" class="bulleted-list"><li style="list-style-type:circle">A <strong>thread context</strong> is much <strong>smaller </strong>→ a <strong>thread context switch</strong> is <strong>faster</strong>.</li></ul><ul id="d151241e-51cd-444d-84a8-f4a7eec38423" class="bulleted-list"><li style="list-style-type:circle">The threads are <strong>not </strong>organized in a <strong>rigid parent-child hierarchy</strong> - They form a <strong>pool of peers</strong>, independent of which threads were created by which other threads.<p id="ac0cc96e-ba26-451f-bd95-1bc5af40ceba" class="">→ A thread can <strong>kill any of its peers</strong> or <strong>wait for any of its peers</strong> to terminate.</p></li></ul><ul id="67621c9a-574a-403d-89f3-3a1410d7e334" class="bulleted-list"><li style="list-style-type:circle">Each peer can read and write the same <strong>shared data</strong>.</li></ul></li></ul></details></li></ul><ul id="f6a82e4b-8fa5-4f89-aaa4-38446600bf22" class="toggle"><li><details open=""><summary><strong>Posix Threads - Creating Threads</strong></summary><p id="1bb73c6e-f188-421e-838d-8273453abb46" class=""><strong>Posix threads (Pthreads)</strong> is a standard interface for manipulating threads from C programs.</p><pre id="e2bfe07e-7358-423b-96f7-b39a88be059a" class="code"><code>#include &lt;pthread.h&gt;
typedef void *(func)(void *);

int pthread_create(pthread_t *tid, pthread_attr_t *attr, func *f, void *arg);
pthread_t pthread_self(void);</code></pre><ul id="628b31a0-64cc-4667-9d3d-f8f1c9f79255" class="bulleted-list"><li style="list-style-type:disc"><code>pthread_create</code> <strong>creates a new thread</strong> and <strong>runs the thread routine </strong><strong><code>f</code></strong><strong> </strong>in the context of the new thread and with an <strong>input argument of </strong><strong><code>arg</code></strong>.</li></ul><ul id="357512ac-6d32-4814-970e-732d6f3f2cc4" class="bulleted-list"><li style="list-style-type:disc">Each thread routine takes as input <strong>a single generic pointer</strong> and returns<strong> a generic pointer</strong>. → Put the arguments into a <strong>structure </strong>to <strong>pass multiple arguments</strong> or let the routine <strong>return multiple arguments</strong>.</li></ul><ul id="2c597ffb-711c-40bf-8ef0-15f791e81a7a" class="bulleted-list"><li style="list-style-type:disc">When <code>pthread_create</code> returns, argument <strong><code>tid</code></strong><strong> </strong>contains the <strong>ID of the newly created thread</strong>.</li></ul><ul id="aa0504a9-bcb8-4482-9439-43481175c80c" class="bulleted-list"><li style="list-style-type:disc">The new thread can determine its own thread ID by calling the <code>pthread_self</code>.</li></ul></details></li></ul><ul id="a9034dc4-515a-4054-a760-29d2f1309e7f" class="toggle"><li><details open=""><summary><strong>Posix Threads - Terminating Threads</strong></summary><p id="101ded4e-5b2e-426d-9cae-cb827b669b00" class="">A thread <strong>terminates </strong>in one of the following ways:</p><ul id="47c2d466-30ed-429c-8371-76e0d4184bfd" class="bulleted-list"><li style="list-style-type:disc">The thread terminates <strong>implicitly </strong>when its <strong>top-level thread routine returns</strong>.</li></ul><ul id="ac73c0a9-9eb4-4c4a-b035-59a513e48fa1" class="bulleted-list"><li style="list-style-type:disc">The thread terminates <strong>explicitly </strong>by calling the <strong><code>pthread_exit</code></strong>.<pre id="44ec5926-9ffb-4878-bbee-4a7289e99e5a" class="code"><code>#include &lt;pthread.h&gt;

void pthread_exit(void *thread_return);</code></pre><p id="3a99444f-ec0d-420c-80a8-28dc4f59070f" class="">If the main thread calls <strong><code>pthread_exit</code></strong>, it <strong>waits </strong>for <strong>all other peer threads</strong> to <strong>terminate </strong>and then terminates the <strong>main thread </strong>and the <strong>entire process</strong> with a return value of <code>thread_return</code>.</p></li></ul><ul id="b032aef7-7a22-4ab7-b429-67ab4fcebd9c" class="bulleted-list"><li style="list-style-type:disc">The thread calls the <strong>Linux </strong><strong><code>exit</code></strong><strong> function</strong>, which terminates the process and all threads associated with the process.</li></ul><ul id="d619e9e4-9731-4777-9491-dbbfed9c50dc" class="bulleted-list"><li style="list-style-type:disc">The thread calls the <strong><code>pthread_cancel</code></strong> with the ID of the current thread.<pre id="b54a00a3-c40b-4ec0-afd5-87280426e507" class="code"><code>#include &lt;pthread.h&gt;

int pthread_cancel(pthread_t tid);</code></pre></li></ul></details></li></ul><ul id="0ddfc1f0-684f-46ce-95b6-efac7b1da085" class="toggle"><li><details open=""><summary><strong>Posix Threads - Reaping Terminated Threads</strong></summary><pre id="d285087b-f584-4624-8f44-92bfbf9f785a" class="code"><code>#include &lt;pthread.h&gt;

int pthread_join(pthread_t tid, void **thread_return);</code></pre><ul id="66384c74-d09a-4450-a1cf-b89b8438a1d3" class="bulleted-list"><li style="list-style-type:disc"><strong><code>pthread_join</code></strong><strong> blocks </strong>until thread <code>tid</code> terminates, assigns the generic (<code>void*</code>) pointer returned by the <strong>thread routine</strong> to the location pointed to by <code>thread_return</code>, and then <strong>reaps </strong>any memory resources held by the terminated thread.</li></ul><ul id="ad046a43-5c5c-4edf-9fda-026a9cde3546" class="bulleted-list"><li style="list-style-type:disc">Unlike Linux <code>wait</code>, <code>pthread_join</code> can only wait for a specific thread to terminate.</li></ul></details></li></ul><ul id="74557626-78a0-444a-9f36-76f06f07d293" class="toggle"><li><details open=""><summary><strong>Posix Threads - Detaching Threads</strong></summary><p id="f522941a-93d9-4a9a-9ba9-04b7a20d7140" class="">At any point in time, a thread is <strong>joinable </strong>or <strong>detached</strong>.</p><ul id="dc1bf9c9-f0ba-4aa1-bfdf-d99596fc5fc6" class="bulleted-list"><li style="list-style-type:disc"><strong>Joinable Thread</strong><ul id="c0fc338e-3865-4cc9-8252-26f634300934" class="bulleted-list"><li style="list-style-type:circle">A joinable thread <strong>can be reaped and killed</strong> by other threads.</li></ul><ul id="a64cdec1-ff7a-4177-9f17-3247b5f07eea" class="bulleted-list"><li style="list-style-type:circle">A joinable thread’s memory resources (such as stack) are <strong>not freed</strong> <strong>until it is reaped</strong> by another thread.</li></ul></li></ul><ul id="6e1180e6-f037-424e-a114-e0dd843f4047" class="bulleted-list"><li style="list-style-type:disc"><strong>Detached Thread</strong><ul id="ad36699d-c392-4450-b8c1-4875c4813ad3" class="bulleted-list"><li style="list-style-type:circle">A detached thread <strong>can’t be reaped or killed</strong> by other threads.</li></ul><ul id="bb99db1c-cbf7-430a-b7fd-986b23ac67bd" class="bulleted-list"><li style="list-style-type:circle">A detached thread’s memory resources are <strong>freed automatically by</strong> the system <strong>when it terminates</strong>.</li></ul></li></ul><ul id="5646ec30-4f78-4e87-aa9e-d61c0d0cb48e" class="bulleted-list"><li style="list-style-type:disc">By default, threads are <strong>created joinable</strong>. Joinable threads can be detached by a call to the <code>pthread_detach</code> function.<pre id="965a05be-2d51-4d16-8ddc-7c56c7450c8a" class="code"><code>#include &lt;pthread.h&gt;

int pthread_detach(pthread_t tid);</code></pre></li></ul></details></li></ul><ul id="eca806c2-38df-4f61-bacb-d6b188a0d2a9" class="toggle"><li><details open=""><summary><strong>Posix Threads - Initializing Threads</strong></summary><pre id="48d0b868-f45b-42ac-afc1-5d6ba278706e" class="code"><code>#include &lt;pthread.h&gt;

pthread_once_t once_control = PTHREAD_ONCE_INIT;

int pthread_once(pthread_once_t *once_control, void (*init_routine)(void));</code></pre><ul id="6fce7769-2378-4484-9c0a-7773b130f656" class="bulleted-list"><li style="list-style-type:disc"><code>once_control</code> is a global variable or static variable that is always initialized to PTHREAD_ONCE_INIT.</li></ul><ul id="545f5d03-5393-41da-9c7a-c0ce3ebeb52c" class="bulleted-list"><li style="list-style-type:disc">The first time you call <code>pthread_once</code> with an argument of <code>once_control</code>, it invokes <code>init_routine</code>, which is a function with no input arguments that returns nothing.</li></ul><ul id="6101cf70-a863-4662-aa09-c9f553cca725" class="bulleted-list"><li style="list-style-type:disc">Subsequent calls to <code>pthread_once</code> with the same <code>once_control</code> variable do nothing. </li></ul><ul id="58ca6081-2776-438c-ae57-a11e8992faec" class="bulleted-list"><li style="list-style-type:disc"><code>pthred_once</code> can used to dynamically initialize global variables that are shared by multiple threads.</li></ul></details></li></ul><ul id="00a98549-5bf6-4513-a60c-6d973cd25d0c" class="toggle"><li><details open=""><summary><strong>A Concurrent Server Based on Threads</strong></summary><pre id="41fec896-41dc-4ef0-b2a4-db0b8db1fa54" class="code"><code>#include &quot;csapp.h&quot;

void echo(int connfd);
void *thread(void *vargp);

int main(int argc, char **argv) {
  int listenfd, *connfdp;
  socklen_t clientlen;
  struct sockaddr_storage clientaddr;
  pthread_t tid;

  if (argc != 2) {
    fprintf(stderr, &quot;usage: %s &lt;port&gt;\n&quot;, argv[0]);
    exit(0);
  }
  listenfd = Open_listenfd(argv[1]);

  while (1) { 
    clientlen = sizeof(struct sockaddr_storage);
    connfdp = Malloc(sizeof(int));
    *connfdp = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);
    Pthread_create(&amp;tid, NULL, thread, connfdp);
  }
}

/* Thread routine */
void *thread(void *vargp) {
  int connfd = *((int *)vargp);
  Pthred_detach(pthread_self());
  Free(vargp);
  echo(connfd);
  Close(connfd);
  return NULL;
}</code></pre><ul id="a120e9e4-5808-457d-a4c2-682a88b494ae" class="bulleted-list"><li style="list-style-type:disc">If you write code as below to pass a pointer to the descriptor :<pre id="2424f0d2-97a0-47e3-ad23-e14c95beb07c" class="code"><code>//...
connfd = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);
Pthread_create(&amp;tid, NULL, thread, &amp;connfd);
//...
void *thread(void *vargp) {
  int connfd = *((int *)vargp);
  //...
}</code></pre><p id="80a7c38d-d318-4afd-81dd-20c2b6208108" class="">this code would introduce a <strong>race </strong>between the <strong>assignment statement in the peer thread</strong> and the <strong><code>accept</code></strong><strong> in the main thread</strong>.</p><p id="659c79fd-5d75-4076-982d-29e09f559c94" class="">If the assignment of <code>connfd</code> completes after the <code>accept</code>, then the local <code>connfd</code> variable in the peer threads gets the descriptor number of the next connection.</p><p id="b946ed4b-6b28-4e8a-9cc0-954437b67fa5" class="">⇒ We must <strong>assign each connected descriptor</strong> returned by <code>accept</code> to its <strong>own dynamically allocated memory block</strong>.</p></li></ul><ul id="85dd59a5-c9cb-4136-aba5-080030d293cb" class="bulleted-list"><li style="list-style-type:disc">We must <strong>detach each thread</strong> so that its memory resources will be reclaimed when it terminates.</li></ul><ul id="529ce0b3-2100-4c62-950e-e7f254c58ed9" class="bulleted-list"><li style="list-style-type:disc">We must <strong>free the memory block</strong> that was allocated by the main thread.</li></ul></details></li></ul></div><h2 id="5cdd056e-db13-4f4b-b8cf-91e0e4c4436a" class=""><details open=""><summary><mark class="highlight-blue">12.4</mark> Shared Variables in Threaded Programs</summary></details></h2><div class="indented"><ul id="ed26a78f-69fc-4a6f-8d2e-42285bdc3c03" class="toggle"><li><details open=""><summary><strong>Threads Memory Model</strong></summary><ul id="25d05bc2-df7c-4adb-954c-ed12552592c4" class="bulleted-list"><li style="list-style-type:disc">Each threads has its own separate <strong>thread context</strong>:<ul id="2b4a1e56-ca63-4c52-96a8-ef689a31b4ff" class="bulleted-list"><li style="list-style-type:circle">thread ID (TID)</li></ul><ul id="aea0fa05-bf99-41a6-846e-fbed24df7514" class="bulleted-list"><li style="list-style-type:circle">stack</li></ul><ul id="30635ddb-1743-4b08-8529-57d59e129270" class="bulleted-list"><li style="list-style-type:circle">stack pointer</li></ul><ul id="9dc6af28-ff6b-4277-82bb-7c3b16579f30" class="bulleted-list"><li style="list-style-type:circle">program counter</li></ul><ul id="5588c872-4c1b-4473-9cae-191c54daf587" class="bulleted-list"><li style="list-style-type:circle">condition codes</li></ul><ul id="a876831c-d704-4f92-b719-58ca565949ec" class="bulleted-list"><li style="list-style-type:circle">general-purpose register values</li></ul></li></ul><ul id="4d4801b8-09ae-4b06-b175-23e17d9960e4" class="bulleted-list"><li style="list-style-type:disc">Each threads shares the <strong>rest of the process context</strong> with the other threads:<ul id="eb5d89d6-efa0-484f-9816-47d4168fea8c" class="bulleted-list"><li style="list-style-type:circle">The <strong>entire user VAS</strong> - read-only text (code), read/write data, the heap, and any shared library code and data areas</li></ul><ul id="903669a1-2ac5-45af-8180-8d68d673b451" class="bulleted-list"><li style="list-style-type:circle">Open files</li></ul></li></ul><ul id="4c2ed158-9fcf-46ce-8f33-5c24589fc44f" class="bulleted-list"><li style="list-style-type:disc"><strong>⇒ Registers are never shared, whereas VM is always shared.</strong></li></ul><ul id="fbd5b6cc-d40d-4dad-8819-0d936b4de787" class="bulleted-list"><li style="list-style-type:disc"><strong>Thread stacks</strong> are contained in the <strong>stack area of VAS</strong>, and are usually <strong>accessed independently</strong> by their respective threads. <p id="db1f21d2-b1a3-4dea-b785-73b2c8367b15" class="">However, different thread stacks are <strong>not protected</strong> from other threads. - A thread can access any part of the stack if it manages to acquire a pointer to another thread’s stack.</p></li></ul></details></li></ul><ul id="6f7eb85e-4f66-4a73-be0b-47a9c5afb053" class="toggle"><li><details open=""><summary><strong>Mapping Variables to Memory</strong></summary><ul id="bc8f22be-41a3-4b38-b700-1fb0cccdec50" class="bulleted-list"><li style="list-style-type:disc"><strong>Global variables</strong><ul id="e1ade315-ea7b-4039-841d-ef719b617f56" class="bulleted-list"><li style="list-style-type:circle">Any variable declared <strong>outside of a function</strong>.</li></ul><ul id="df2c4416-284e-4628-a90d-a9633b23d2b4" class="bulleted-list"><li style="list-style-type:circle">At run time, the read/write area of VM contains exactly <strong>one instance</strong> of each global variable that <strong>can be referenced by any thread</strong>.</li></ul></li></ul><ul id="126d9371-2ecc-4a6c-9f67-5095545108c1" class="bulleted-list"><li style="list-style-type:disc"><strong>Local automatic variables</strong><ul id="c9a16baa-7575-449e-b380-a822cdcc8eb5" class="bulleted-list"><li style="list-style-type:circle">Variable that is declared <strong>inside a function</strong> <strong>without </strong>the <strong><code>static</code></strong><strong> </strong>attribute.</li></ul><ul id="2d4e8375-7269-4ad2-9956-3d98b5b0165c" class="bulleted-list"><li style="list-style-type:circle"><strong>Each thread’s stack</strong> contains its <strong>own instances</strong> of any local automatic variables. (Even if multiple threads execute the same thread routine.)</li></ul></li></ul><ul id="b1358604-f8bb-440d-85d5-d4393422efdb" class="bulleted-list"><li style="list-style-type:disc"><strong>Local static variables</strong><ul id="866dae46-df93-4fa8-b34b-caf5bde8dfa0" class="bulleted-list"><li style="list-style-type:circle">Variable that is declared <strong>inside a function</strong> <strong>with </strong>the <strong><code>static</code></strong><strong> </strong>attribute.</li></ul><ul id="1cd4990f-a53c-4afc-9832-5579d38d9f99" class="bulleted-list"><li style="list-style-type:circle">The read/write area of VM contains <strong>exactly one instance</strong> of each local static variable declared in a program.</li></ul></li></ul></details></li></ul><ul id="5c63de5a-2ca3-4a75-b537-8f40a461d4d4" class="toggle"><li><details open=""><summary>Shared Variables</summary><ul id="d090c09c-dd47-42b1-8a30-5c640c42d1c4" class="bulleted-list"><li style="list-style-type:disc"><strong>A variable </strong><strong><code>v</code></strong><strong> is shared</strong> = One of its instances is <strong>referenced by more than one thread</strong>.</li></ul><ul id="b8727dd4-f5fb-4b04-86e4-1ac14e89a047" class="bulleted-list"><li style="list-style-type:disc"><strong>Example Code</strong><pre id="4c12b9b3-458b-4c4d-9ace-cb7ae1061b5d" class="code"><code>#include &quot;csapp.h&quot;
#define N 2
void *thread(void *vargp);

char **ptr; /* Global variable */

int main() {
  int i;
  pthread_t tid;
  char *msgs[N] = {
    &quot;Hello from foo&quot;,
    &quot;Hello from bar&quot;
  };

  ptr = msgs;
  for (i = 0; i &lt; N; i++) 
    Pthread_create(&amp;tid, NULL, thread, (void *)i);
  Pthread_exit(NULL);
}

void *thread(void *vargp) {
  int myid = (int)vargp;
  static int cnt = 0;
  printf(&quot;[%d] : %s (cnt=%d)\n&quot;, myid, ptr[myid], ++cnt);
  return NULL;
}</code></pre><ul id="34c129aa-2718-4c7e-975d-be1eebd2f300" class="bulleted-list"><li style="list-style-type:circle"><strong>Global variables</strong> : <code>ptr</code></li></ul><ul id="76b9c455-67c5-481d-91b5-f25cc7fecd72" class="bulleted-list"><li style="list-style-type:circle"><strong>Local automatic variables</strong> : <code>tid</code>, <code>myid</code> → <code>tid.m</code>, <code>myid.p0</code>, <code>myid.p1</code></li></ul><ul id="c624f6ea-d9c8-49aa-8c39-58498a94b41f" class="bulleted-list"><li style="list-style-type:circle"><strong>Local static variables</strong> : <code>cnt</code></li></ul><ul id="e66a7ca1-7fce-43f4-b81b-03834fe11a7c" class="bulleted-list"><li style="list-style-type:circle">In line 26 (<code>printf(&quot;[%d] : %s (cnt=%d)\n&quot;, myid, ptr[myid], ++cnt);</code>), the <strong>peer threads</strong> reference the contents of the <strong>main thread’s stack</strong> indirectly through the global <code>ptr</code> variable. → <strong>Thread stacks are not protected</strong>!</li></ul><ul id="ed963184-645b-400d-8bd1-2aeeac2b4a83" class="bulleted-list"><li style="list-style-type:circle"><strong><code>cnt</code></strong><strong> </strong>is <strong>shared variable</strong> because it has only <strong>one run-time instance</strong> and this instance is <strong>referenced by both peer threads</strong>.</li></ul><ul id="f4fb1a13-6ede-40cd-ab47-02a9b8ebb187" class="bulleted-list"><li style="list-style-type:circle"><strong><code>myid</code></strong><strong> </strong>is <strong>not shared</strong> because each of its <strong>two instances</strong> is <strong>referenced by exactly one</strong> thread.</li></ul></li></ul></details></li></ul></div><h2 id="46cffebb-dca3-4c47-b49c-1453c2e572ad" class=""><details open=""><summary><mark class="highlight-blue">12.5</mark> Synchronizing Threads with Semaphores</summary></details></h2><div class="indented"><ul id="e5849c8b-37d9-46a3-a2a2-c85c9f64c12b" class="toggle"><li><details open=""><summary><strong>Shared Variable Introducing Synchronization Errors</strong></summary><p id="a95668c1-936e-4b9a-87e3-f51cbfa0eb26" class="">Shared variables can introduce the possibility of nasty <strong>synchronization errors</strong>. - Consider <code>badcnt.c</code></p><pre id="2e36613d-963d-4ba7-a0b4-e9b75a9c4372" class="code"><code>/* WARNING: This code is buggy! */
#include &quot;csapp.h&quot;

void *thread(void *vargp);  /* Thread routine prototype */

/* Global shared variable */
volatile long cnt = 0; /* Counter */

int main(int argc, char **argv) 
{
    long niters;
    pthread_t tid1, tid2;

    /* Check input argument */
    if (argc != 2) { 
			printf(&quot;usage: %s &lt;niters&gt;\n&quot;, argv[0]);
			exit(0);
    }
    niters = atoi(argv[1]);

    /* Create threads and wait for them to finish */
    Pthread_create(&amp;tid1, NULL, thread, &amp;niters);
    Pthread_create(&amp;tid2, NULL, thread, &amp;niters);
    Pthread_join(tid1, NULL);
    Pthread_join(tid2, NULL);

    /* Check result */
    if (cnt != (2 * niters))
			printf(&quot;BOOM! cnt=%ld\n&quot;, cnt);
    else
			printf(&quot;OK cnt=%ld\n&quot;, cnt);
    exit(0);
}

/* Thread routine */
void *thread(void *vargp) 
{
    long i, niters = *((long *)vargp);

    for (i = 0; i &lt; niters; i++)
			cnt++;

    return NULL;
}</code></pre><ul id="450b865c-04a5-4aa1-b8c7-71a0e515aca6" class="bulleted-list"><li style="list-style-type:disc">When we run this code, we get <strong>wrong answers</strong> &amp; <strong>different answers each time</strong>!</li></ul><pre id="db297056-d74d-4131-b184-79a061bed8b7" class="code"><code>linux&gt; ./badcnt 1000000
BOOM! cnt=1445085

linux&gt; ./badcnt 1000000
BOOM! cnt=1915220</code></pre><ul id="6995d8a5-5b20-4945-b469-ccf863312809" class="bulleted-list"><li style="list-style-type:disc">The <strong>assembly code</strong> for the counter loop<figure id="6e95c62a-ccd3-46ff-9a5a-83d23675af06" class="image"><a href="/assets/images/CSAPP-12/Untitled%201.png"><img style="width:480px" src="/assets/images/CSAPP-12/Untitled%201.png"/></a></figure><ul id="ff2fbf91-8845-47d4-839c-87b3ef741a4e" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> : <strong>loads</strong> the shared variable <code>cnt</code> into the %<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>d</mi><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">rdx_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> (value of register %rdx in thread i)</li></ul><ul id="2be9ee74-795b-492d-b3e7-12235b32a10a" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">U_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> : <strong>updates </strong>% <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>d</mi><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">rdx_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span></li></ul><ul id="2b98e4be-593c-498a-b4fb-ad13f3c33389" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> : <strong>stores </strong>the updated value of %<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>d</mi><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">rdx_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> back to the shared variable <code>cnt</code>.</li></ul></li></ul><ul id="c36d2127-25c9-4cf0-b711-2e23efd8f9cf" class="bulleted-list"><li style="list-style-type:disc"><strong>Each concurrent execution</strong> defines some <strong>total ordering of the instructions</strong> in the two threads. </li></ul><ul id="c221ba24-8c1e-4cae-a857-583940ec1f10" class="bulleted-list"><li style="list-style-type:disc">There is <strong>no way to predict</strong> whether the OS will choose a correct ordering for your threads.</li></ul></details></li></ul><ul id="0a5314bc-9bc0-4417-b4d4-9bb7505bde66" class="toggle"><li><details open=""><summary><strong>Progress Graphs</strong></summary><p id="a7d53b87-f82a-44fe-81c0-f043b79e1dd9" class="">A <strong>progress graph</strong> models the <strong>execution of </strong><strong><em>n </em></strong><strong>concurrent threads</strong> as a <strong>trajectory </strong>through an <strong><em>n</em></strong><strong>-dimensional Cartesian space</strong>.</p><figure id="5c57e8a6-15b8-46d2-9e06-a42c412beb6e" class="image"><a href="/assets/images/CSAPP-12/Untitled%202.png"><img style="width:336px" src="/assets/images/CSAPP-12/Untitled%202.png"/></a></figure><ul id="36ef8f3f-372b-4445-bcff-5f3b1dbb40d0" class="bulleted-list"><li style="list-style-type:disc">Each <strong>axis</strong> <em>k</em> = the <strong>progress </strong>of thread <em>k</em></li></ul><ul id="3f17508e-e332-4608-801d-c0a7adbc6d61" class="bulleted-list"><li style="list-style-type:disc">Each <strong>point </strong>(<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">I_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">I_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>, …, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">I_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>) = the <strong>state </strong>where thread <em>k</em> has completed instruction <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">I_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>.</li></ul><ul id="ae61a1dd-f51c-4374-af08-f86f6ba7ff7c" class="bulleted-list"><li style="list-style-type:disc">The <strong>origin </strong>= <strong>initial state</strong> where none of the threads has yet completed an instruction.</li></ul><ul id="078d54cb-a5ba-423c-8d10-5a563f2cc51f" class="bulleted-list"><li style="list-style-type:disc">A <strong>directed edge </strong>= <strong>Instruction execution</strong> = A <strong>transition </strong>from one state to another.</li></ul><ul id="d6b931c9-db96-4740-a9ab-6fd4aa011cde" class="bulleted-list"><li style="list-style-type:disc"><strong>Trajectory </strong>= The <strong>execution history</strong> of a program </li></ul><ul id="f59924e2-e188-4d8a-8465-36b6fd3b6bee" class="bulleted-list"><li style="list-style-type:disc"><strong>Critical Section</strong><ul id="aa1a7546-640d-46f8-8946-1157ded04d23" class="bulleted-list"><li style="list-style-type:circle">For thread <em>i</em>, the instructions (<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">U_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">S_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>) that <strong>manipulate the contents of the shared variable</strong> <code>cnt</code> constitute a <strong>critical section</strong>.</li></ul><ul id="d32a4110-aae4-46be-9f0f-1e3a4c03c868" class="bulleted-list"><li style="list-style-type:circle">Critical section of a thread <strong>should not be interleaved</strong> with the <strong>critical section of the other thread</strong>.</li></ul><ul id="6c094604-4c49-4139-b339-1097d562e1b1" class="bulleted-list"><li style="list-style-type:circle">⇒ Each thread must be ensured to have <strong>mutually exclusive access</strong> to the shared variable while it is executing the instructions in its critical section.</li></ul></li></ul><ul id="1ba01858-bfbf-4302-ac69-b20b0ca92163" class="bulleted-list"><li style="list-style-type:disc"><strong>Unsafe Region</strong><ul id="753a2ab9-57d4-4b72-b046-57bf95ee05da" class="bulleted-list"><li style="list-style-type:circle"><strong>Unsafe region </strong>= <strong>The intersection of the two critical sections</strong>.</li></ul><ul id="7cfea913-f083-4d8f-90f6-151cb0c7abc9" class="bulleted-list"><li style="list-style-type:circle">The unsafe region abuts, but <strong>doesn’t include</strong> the states along its <strong>perimeter</strong>. </li></ul></li></ul><ul id="88e6c0e4-fceb-4051-81c7-8222eb22d0ce" class="bulleted-list"><li style="list-style-type:disc"><strong>Safe trajectory</strong> = A <strong>trajectory </strong>that <strong>skirts the unsafe region</strong>. (↔ Unsafe trajectory)<ul id="5fcb4f42-4963-4096-be4c-b4ea09bdc6bb" class="bulleted-list"><li style="list-style-type:circle">Any safe trajectory will correctly update the shared counter.</li></ul><ul id="596f2f7a-e265-450c-8670-6149951681a8" class="bulleted-list"><li style="list-style-type:circle">⇒ We must synchronize the threads so that they always have a safe trajectory.</li></ul></li></ul></details></li></ul><ul id="c4b8b6f0-4441-446f-940d-499b20a36169" class="toggle"><li><details open=""><summary><strong>Semaphores</strong></summary><p id="3de7ed11-3518-4495-a845-87804e975261" class="">A <strong>semaphore </strong>is a global variable with a nonnegative integer value that can <strong>only be manipulated by two special operations</strong>, <strong>P and V</strong>:</p><ul id="11180e37-26b0-45fa-bbfb-92573fc94b9f" class="bulleted-list"><li style="list-style-type:disc"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> <ul id="1f74b625-dcfd-4f90-8e51-f1a61c9ea3f3" class="bulleted-list"><li style="list-style-type:circle">If <em>s </em>is <strong>nonzero</strong>, then <em>P</em> <strong>decrements </strong><strong><em>s</em></strong><em> </em>and returns immediately.</li></ul><ul id="6c1048c0-e171-4aec-9bb4-7b348db93112" class="bulleted-list"><li style="list-style-type:circle">If <em>s </em>is <strong>zero</strong>, then <strong>suspend the thread</strong> until <em>s</em> becomes nonzero and the thread is <strong>restarted by a </strong><strong><em>V</em></strong><strong> operation</strong>. After restarting, the <em>P</em> decrements <em>s</em> and returns.</li></ul></li></ul><ul id="ce7146e5-47ec-4635-b7ba-7de8f48cee0f" class="bulleted-list"><li style="list-style-type:disc"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span><ul id="02cf52b2-3062-4fde-8676-eb8793be0c1f" class="bulleted-list"><li style="list-style-type:circle"><strong>Increments </strong><strong><em>s</em></strong> by 1.</li></ul><ul id="0f5f7f4b-cd07-46cf-9938-5e5ae75193c1" class="bulleted-list"><li style="list-style-type:circle">If there are any threads <strong>blocked at a </strong><strong><em>P </em></strong>waiting for <em>s</em> to become nonzero, then <strong><em>V</em></strong><strong> restarts exactly one of these threads</strong>.</li></ul><ul id="f7edd831-1227-496b-882a-dbe7475a1731" class="bulleted-list"><li style="list-style-type:circle">When several threads are waiting at a semaphore, you <strong>can’t predict </strong>which one will be restarted as a result of <em>V</em>.</li></ul></li></ul><ul id="65b9cf9e-58a3-497b-9b25-443c8dd69ecd" class="bulleted-list"><li style="list-style-type:disc">The test, decrement in <em>P</em> and increment in <em>V</em> occurs <strong>indivisibly</strong>. (occurs <strong>without interruption</strong>)</li></ul><ul id="562e16a5-f17a-47cb-941b-7a8e4b53f674" class="bulleted-list"><li style="list-style-type:disc"><strong>Semaphore invariant</strong><ul id="c2b12bee-9cee-4cf5-836b-89d2ad6a53a4" class="bulleted-list"><li style="list-style-type:circle">The definitions of <em>P</em> and <em>V</em> ensure that a running program can <strong>never enter </strong>a state where a properly initialized <strong>semaphore has a negative value</strong>.</li></ul><ul id="70ef62c6-fcc9-4e60-a081-c51401d31145" class="bulleted-list"><li style="list-style-type:circle">→ can control the trajectories of concurrent programs.</li></ul></li></ul><ul id="d4eab1fd-36b1-4f99-9329-eb7627ba5ae4" class="bulleted-list"><li style="list-style-type:disc"><strong>Posix functions for manipulating semaphores</strong><pre id="edf18225-7c86-43fc-a8a4-9cc3b6bc4a96" class="code"><code>#include &lt;semaphore.h&gt;

int sem_init(sem_t *sem, 0, unsigned int value);
int sem_wait(sem_t *s); /* P(s) */
int sem_post(sem_t *s); /* V(s) */</code></pre><ul id="5562407a-abbf-425e-a0e3-7f42637d601d" class="bulleted-list"><li style="list-style-type:circle"><code>sem_init</code> initializes semaphore <code>sem</code> to <code>value</code>.</li></ul><ul id="2a09b01d-6592-40fe-ad74-f66a6d788d63" class="bulleted-list"><li style="list-style-type:circle">For conciseness, we use the following equivalent <em>P</em> and <em>V </em><strong>wrapper functions</strong> instead:</li></ul><pre id="a687b27a-541c-4147-bdfa-061d050086d6" class="code"><code>#include &quot;csapp.h&quot;

void P(sem_t *s); /* Wrapper function for sem_wait */
void V(sem_t *s); /* Wrapper function for sem_post */</code></pre></li></ul></details></li></ul><ul id="b6432f8c-11cb-4bc0-857c-47553f6e6119" class="toggle"><li><details open=""><summary><strong>Using Semaphores for Mutual Exclusion</strong></summary><p id="1762b3d1-7806-4042-8fab-446e2230900a" class="">Associate a semaphore <em>s</em>, initially 1, with <strong>each shared variable</strong> and then <strong>surround the corresponding critical section</strong> with <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> and <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> operations.</p><figure id="9fd69cb6-7534-4204-badf-0b9028c0f2e7" class="image"><a href="/assets/images/CSAPP-12/Untitled%203.png"><img style="width:432px" src="/assets/images/CSAPP-12/Untitled%203.png"/></a></figure><ul id="1a9ae65c-fc62-4d48-8750-88c01a794289" class="bulleted-list"><li style="list-style-type:disc"><strong>Mutex </strong>: Binary semaphores whose purpose is to provide mutual exclusion.</li></ul><ul id="c24867d5-04c0-45ed-9313-4fed7bfc6be1" class="bulleted-list"><li style="list-style-type:disc"><strong>Counting Semaphore</strong> : A semaphore that is used as a counter for a set of available resources.</li></ul><ul id="c510f145-6d78-43be-8997-0cf78abd4764" class="bulleted-list"><li style="list-style-type:disc">The combination of <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span><span>﻿</span></span> and <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span><span>﻿</span></span>creates a collection of states, called a <strong>forbidden region</strong>, where <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">s&lt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span><span>﻿</span></span>.</li></ul><ul id="afeffc18-241b-4db5-af82-047df25ee833" class="bulleted-list"><li style="list-style-type:disc">Because of <strong>semaphore invariant</strong> → No feasible trajectory can include one of the states in the forbidden region. &amp; The <strong>forbidden region</strong> <strong>completely encloses the unsafe region</strong>.</li></ul><ul id="e7765061-5e92-4037-849f-b5dd7b2d67e3" class="bulleted-list"><li style="list-style-type:disc">⇒ Every feasible trajectory is <strong>safe</strong>!!</li></ul><ul id="0c194215-0bee-4df8-81f0-e9c787f84daa" class="bulleted-list"><li style="list-style-type:disc"><strong>Synchronizing the example code</strong><pre id="5352ac9a-8c87-4843-ae16-07592bda7fdb" class="code"><code>volatile long cnt = 0; /* Counter */
sem_t mutex; /* Semaphore that protects counter */

//...

Sem_init(&amp;mutex, 0, 1); /* mutex = 1 */

//...

for (i = 0; i &lt; niters; i++) {
  P(&amp;mutex);
  cnt++;
  V(&amp;mutex);
}</code></pre></li></ul></details></li></ul><ul id="1c12bec4-44c1-4bb7-89e6-a69c217aa41b" class="toggle"><li><details open=""><summary><strong>Using Semaphores to Schedule Shared Resources - Producer-Consumer Problem</strong></summary><figure id="9218dc31-2f62-4e89-bf62-d13a6e7f686f" class="image"><a href="/assets/images/CSAPP-12/Untitled%204.png"><img style="width:432px" src="/assets/images/CSAPP-12/Untitled%204.png"/></a></figure><ul id="61e87f99-2f2f-44d1-8fdb-90542d061d4b" class="bulleted-list"><li style="list-style-type:disc">The <strong>producer thread</strong> repeatedly <strong>generates new items</strong> and <strong>inserts </strong>them into a bounded <strong>buffer </strong>with<strong> </strong><strong><em>n</em></strong><strong> slots</strong>.</li></ul><ul id="3ca092a6-809f-48c4-8369-a123902d5985" class="bulleted-list"><li style="list-style-type:disc">The <strong>consumer thread</strong> repeatedly <strong>removes items</strong> from the buffer and then consumes them.</li></ul><ul id="4707f114-b3c7-45f4-83dd-2376a7a0db91" class="bulleted-list"><li style="list-style-type:disc">We must guarantee <strong>mutually exclusive access</strong> to the buffer &amp; <strong>schedule accesses</strong> to the buffer. (If the buffer is full, then the producer must wait. &amp; If the buffer is empty, the consumer must wait.)</li></ul><ul id="4e8493e6-96da-443c-8ed3-b71ea1ed013c" class="bulleted-list"><li style="list-style-type:disc"><strong><code>SBUF</code></strong><strong> : A package for synchronizing concurrent access to bounded buffers.</strong><ul id="cb272036-a498-48ca-92a2-b5431c9d656d" class="bulleted-list"><li style="list-style-type:circle"><strong><code>sbuf_t</code></strong><strong> : Bounded buffer</strong><pre id="ad8ba243-4505-445a-b043-c7bca2124422" class="code"><code>typdef struct {
	int *buf; /* Buffer array */
  int n; /* Maximum number of slots */
  int front; /* buf[(front+1)%n] is first item */
  int rear; /* buf[rear%n] is last item */
  sem_t mutex; /* Protects accesses to buf */
  sem_t slots; /* Counts available slots */
  sem_t items; /* Countes available items */
} sbuf_t</code></pre><ul id="cff7a77e-dfb6-433b-ab52-9cd4bbc4693f" class="bulleted-list"><li style="list-style-type:square"><code>mutex</code> provides <strong>mutually exclusive</strong> buffer access.</li></ul><ul id="12cd468f-703d-4c93-acdc-728a46cf847d" class="bulleted-list"><li style="list-style-type:square"><code>slots</code> &amp; <code>items</code> are <strong>counting semaphores</strong> that count the number of empty slots &amp; available items, respectively.</li></ul></li></ul><ul id="15316278-f6fa-43d3-94c5-ada09485a6b9" class="bulleted-list"><li style="list-style-type:circle"><code>SBUF</code><pre id="351b886e-8fcc-474c-9b0b-e1afa6aff2fe" class="code"><code>#include &quot;csapp.h&quot;
#include &quot;sbuf.h&quot;

/* Create an empty, bounded, shared FIFO buffer with n slots */
void sbuf_init(sbuf_t *sp, int n) {
  sp-&gt;buf = Calloc(n, sizeof(int));
  sp-&gt;n = n; /* Buffer holds max of n items */
  sp-&gt;front = sp-&gt;rear = 0; /* Empty buffer iff front == rear */
  Sem_init(&amp;sp-&gt;mutex, 0, 1); /* Binary semaphore for locking */
	Sem_init(&amp;sp-&gt;slots, 0, n); /* Initially, buf has n empty slots */
	Sem_init(&amp;sp-&gt;items, 0, 0); /* Initially, buf has zero data items */
}

/* Clean up buffer sp */
void sbuf_deinit(sbuf_t *sp) {
  Free(sp-&gt;buf);
}

/* Insert item onto the rear of shared buffer sp */
void sbuf_insert(sbuf_t *sp, int item) {
  P(&amp;sp-&gt;slots); /* Wait for available slot */
  P(&amp;sp-&gt;mutex); /* Lock the buffer */
  sp-&gt;buf[(++sp-&gt;rear)%(sp-&gt;n)] = item; /* Insert the item */
  V(&amp;sp-&gt;mutex); /* Unlock the buffer */
  V(&amp;sp-&gt;items); /* Announce available item */
}

/* Remove and return the first item from buffer sp */
int sbuf_remove(sbuf_t *sp) {
  int item; 
  P(&amp;sp-&gt;items); /* Wait for available item */
  P(&amp;sp-&gt;mutex); /* Lock the buffer */
  item = sp-&gt;buf[(++sp-&gt;front)%(sp-&gt;n)]; /* Remove the item */
  V(&amp;sp-&gt;mutex); /* unlock the buffer */
  V(&amp;sp-&gt;slots); /* Announce available slot */
  return item;
}</code></pre></li></ul></li></ul></details></li></ul><ul id="ab2db554-2972-4ad5-b5bd-694e265372da" class="toggle"><li><details open=""><summary><strong>Using Semaphores to Schedule Shared Resources - Readers-Writers Problem</strong></summary><ul id="5d32d9ef-fd7b-4cdb-8549-db87ecc9e1d5" class="bulleted-list"><li style="list-style-type:disc"><strong>Writers </strong>(Threads that modify the shared object) must have <strong>exclusive access</strong> to the object.</li></ul><ul id="4832e87e-69fa-4af8-9051-77426638d729" class="bulleted-list"><li style="list-style-type:disc"><strong>Readers</strong>(Threads that only read the shared object) <strong>may share the object</strong> with an unlimited number of other readers.</li></ul><ul id="4ca52bf1-e875-4bdd-b89b-5b6278f32167" class="bulleted-list"><li style="list-style-type:disc"><strong>The first readers-writers problem</strong><ul id="c5c594c8-23a9-4943-b200-65064a72c620" class="bulleted-list"><li style="list-style-type:circle">No reader should be kept waiting unless a writer has already been granted permission to use the object.</li></ul><ul id="fd34b37a-2c10-412a-b0ae-2d4fe0ce2ca1" class="bulleted-list"><li style="list-style-type:circle">= No reader should wait simply because a writer is waiting.</li></ul></li></ul><ul id="96c6e514-d115-47a0-baa5-8ab52e5969a0" class="bulleted-list"><li style="list-style-type:disc"><strong>The second readers-writers problem</strong><ul id="d956a882-72c8-403f-a0e3-f2a4f01a15be" class="bulleted-list"><li style="list-style-type:circle">Once a writer is ready to write, it should perform its write ASAP.</li></ul></li></ul><ul id="d58560d0-4b04-4ab4-bf9b-c15e8c35beea" class="bulleted-list"><li style="list-style-type:disc"><strong>Solution to the first readers-writers problem</strong><pre id="a23d67bc-00c1-4313-8b84-176d2f897dcd" class="code"><code>/* Global variables */
int readcnt; /* Initially = 0; */
sem_t mutex, w; /* Both initially = 1 */

void reader(void) {
	while (1) {
    P(&amp;mutex);
    readcnt++;
    if (readcnt == 1) /* First in */
      P(&amp;w);
    V(&amp;mutex);
  
    /* Critical Section - Reading happens */

    P(&amp;mutex);
    readcnt--;
    if (readcnt == 0) /* Last out */
      V(&amp;w);
    V(&amp;mutex);
  }
}

void writer(void) {
  while (1) {
    P(&amp;w);

    /* Critical Section - Writing happens */
  
    V(&amp;w);
  }
}</code></pre></li></ul></details></li></ul><ul id="38ce4657-5b4b-471f-a9ed-1112821dbec7" class="toggle"><li><details open=""><summary><strong>Putting It Together: A Concurrent Server Based on Prethreading</strong></summary><ul id="4dc1f463-535a-48ca-8164-86cbf73d6c44" class="bulleted-list"><li style="list-style-type:disc"><strong>A prethreaded concurrent echo server</strong><ul id="ccbdde54-cb85-4f7d-92f3-4dce0f32d5cf" class="bulleted-list"><li style="list-style-type:circle">A server based on <strong>prethreading </strong>consists of a <strong>main thread</strong> and a set of <strong>worker threads</strong>.</li></ul><figure id="1b190a00-3e4f-420e-9d04-97aa0a0fdf14" class="image"><a href="/assets/images/CSAPP-12/Untitled%205.png"><img style="width:576px" src="/assets/images/CSAPP-12/Untitled%205.png"/></a></figure><ul id="d6ce785b-75c2-409b-a302-cbd55e323a41" class="bulleted-list"><li style="list-style-type:circle">The <strong>main thread</strong> repeatedly <strong>accepts connection requests</strong> from clients and <strong>places </strong>the resulting connected descriptors in a <strong>bounded buffer</strong>.</li></ul><ul id="3aa88755-d88a-4519-ab44-a59185d71bd8" class="bulleted-list"><li style="list-style-type:circle">Each <strong>worker thread</strong> repeatedly <strong>removes a descriptor</strong> from the buffer, <strong>services the client</strong>, and then waits for the next descriptor.</li></ul><pre id="6775a570-c6bd-4794-bbf0-b406bc573ea8" class="code"><code>#include &quot;csapp.h&quot;
#include &quot;sbuf.h&quot;
#define NTHREADS 4
#define SBUFSIZE 16

void echo_cnt(int connfd);
void *thread(void *vargp);

sbuf_t sbuf; /* Shared buffer of connected descriptors */

int main(int argc, char **argv) {
  int i, listenfd, connfd;
  socklen_t clientlen;
  struct sockaddr_storage clientaddr;
  pthread_t tid;
  
  if (argc != 2) {
    fprintf(stderr, &quot;usage: %s &lt;port&gt;\n&quot;, argv[0]);
    exit(0);
  }
  listenfd = Open_listenfd(argv[1]);

  sbuf_init(&amp;sbuf, SBUFSIZE);
  for(i = 0; i &lt; NTHREADS; i++) /* Create worker threads */
    Pthread_create(&amp;tid, NULL, thread, NULL);
  
  while (1) {
    clientlen = sizeof(struct sockaddr_storage);
    connfd = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);
    sbuf_insert(&amp;sbuf, connfd); /* Insert connfd in buffer */
  }
}

void *thread(void *vargp) {
  Pthread_detach(pthread_self());
  while (1) {
    int connfd = sbuf_remove(&amp;sbuf); /* Remove connfd from buffer */
    echo_cnt(connfd); /* Service client */
    Close(connfd);
  }
}</code></pre></li></ul><ul id="686234fb-ba96-414f-a49c-ba40a659d062" class="bulleted-list"><li style="list-style-type:disc"><code>echo_cnt</code><pre id="b83ae7bc-b120-43f8-afad-e259d2f6847f" class="code"><code>#include &quot;csapp.h&quot;

static int byte_cnt; /* Byte counter */
static sem_t mutex; /* and the mutex that protects it */

static void init_echo_cnt(void) {
  Sem_init(&amp;mutex, 0, 1);
  byte_cnt = 0;
}

void echo_cnt(int connfd) {
  int n;
  char buf[MAXLINE];
  rio_t rio;
  static pthread_once_t once = PTHREAD_ONCE_INIT;

  Pthread_once(&amp;once, init_echo_cnt); /* Initialization */
  Rio_readinitb(&amp;rio, connfd);
  while((n = Rio_readlineb(&amp;rio, buf, MAXLINE)) != 0) {
    P(&amp;mutex);
    byte_cnt += n;
    printf(&quot;server received %d (%d total) bytes on fd %d\n&quot;, n, byte_cnt, connfd);
    V(&amp;mutex);
    Rio_writen(connfd, buf, n);
  }
}</code></pre><ul id="98a67640-b669-4bff-8d86-98ecdbc7f7ce" class="bulleted-list"><li style="list-style-type:circle"><code>echo_cnt</code> uses the <strong><code>pthread_once</code></strong><strong> </strong>to call the <strong>initialization function</strong> the first time some thread calls the <code>echo_cnt</code> function.<ul id="2790c688-7060-4974-940c-a87894d80889" class="bulleted-list"><li style="list-style-type:square"><strong>Advantage </strong>: it makes the package <strong>easier </strong>to use. / <strong>Disadvantage </strong>: <strong>Every call </strong>to <code>echo_cnt</code> makes a call to <code>pthread_once</code>, which most times <strong>does nothing</strong> useful.</li></ul></li></ul><ul id="96011b75-b051-41af-924b-814ec5ffc30f" class="bulleted-list"><li style="list-style-type:circle">The access to the <strong>shared </strong><strong><code>byte_cnt</code></strong><strong> variable</strong> are <strong>protected </strong>by<strong> </strong><strong><em>P</em></strong><strong> and </strong><strong><em>V</em></strong><strong> </strong>operations.</li></ul></li></ul></details></li></ul></div><h2 id="1b545531-346c-49e6-8978-e4cc036c1064" class=""><details open=""><summary><mark class="highlight-blue">12.6</mark> Using Threads for Parallelism</summary></details></h2><div class="indented"><ul id="49404cbb-f8ed-4561-8b02-c045ee76cf09" class="toggle"><li><details open=""><summary><strong>Sequential, Concurrent, and Parallel Programs</strong></summary><ul id="9e02e704-b5f0-41dc-acc5-cf15f59f3155" class="bulleted-list"><li style="list-style-type:disc"><strong>Sequential Program</strong> : Written as a <strong>single logical flow</strong></li></ul><ul id="87b948a8-3fa9-4d61-a746-262676aabddd" class="bulleted-list"><li style="list-style-type:disc"><strong>Concurrent Program</strong> : Written as <strong>multiple concurrent flows</strong></li></ul><ul id="280ab2d8-4496-4044-a218-1f4fae03000b" class="bulleted-list"><li style="list-style-type:disc"><strong>Parallel Program</strong> : A <strong>concurrent program</strong> running on <strong>multiple processors</strong></li></ul></details></li></ul><ul id="a01b5091-3c68-4e6e-b3ac-dfac0391b526" class="toggle"><li><details open=""><summary><strong>Example Parallel Program - </strong><strong><code>psum-mutex.c</code></strong></summary><p id="cb81d521-1ff8-4ba5-a652-e01c4f709a44" class="">Purpose - To sum the sequence of integers 0, …, n - 1 in parallel</p><p id="006dd115-1602-43e7-849f-e30170754abf" class="">→ <strong>Partition </strong>the sequence into <em>t</em> disjoint regions and then <strong>assign </strong>each of <strong><em>t </em></strong><strong>different threads</strong> to work on its own region.</p><pre id="d74b37fd-6458-4290-90a4-bd197eb7ff4c" class="code"><code>#include &quot;csapp.h&quot;
#define MAXTHREADS 32

void *sum_mutex(void *vargp); /* Thread routine */

/* Global shared variables */
long gsum = 0; /* Global sum */
long nelems_per_thread; /* Number of elements to sum */
sem_t mutex; /* Mutex to protect global sum */

int main(int argc, char **argv) {
  long i, nelems, log_nelems, nthreads, myid[MAXTHREADS];
	pthread_t tid[MAXTHREADS];

  /* Get input arguments */
  if (argc != 3) {
    printf(&quot;Usage: %s &lt;nthreads&gt; &lt;log_nelems&gt;\n&quot;, argv[0]);
    exit(0);
  }
  nthreads = atoi(argv[1]);
  log_nelems = atoi(argv[2]);
  nelems = (1L &lt;&lt; log_nelems);
  nelems_per_thread = nelems / nthreads;
  sem_init(&amp;mutex, 0, 1);

	/* Create peer threads and wait for them to finish */
	for (i = 0; i &lt; nthreads; i++) {
	  myid[i] = i;
    Pthread_create(&amp;tid[i], NULL, sum_mutex, &amp;myid[i]);
  }
  for (i = 0; i &lt; nthreads; i++)
    Pthread_join(tid[i], NULL);
  
  /* Check final answer */
  if (gsum != (nelems * (nelems-1))/2) printf(&quot;Error: result=%ld\n&quot;, gsum);
  
  exit(0);
}

/* Thread routine for psum-mutex.c */
void *sum_mutex(void *vargp) {
  long myid = *((long *)vargp); /* Extract the thread ID */
  long start = myid * nelems_per_thread; /* Start element index */
  long end = start + nelems_per_thread; /* End element index */
  long i;
  
  for (i = start; i &lt; end; i++) {
    P(&amp;mutex);
    gsum += i; 
    V(&amp;mutex);
  }
  return NULL;
}</code></pre><ul id="0d249bef-87a6-411f-8528-a63288eb37a9" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance (running time in seconds)</strong><figure id="cced3070-0081-4a37-85d7-31f194d19908" class="image"><a href="/assets/images/CSAPP-12/Untitled%206.png"><img style="width:336px" src="/assets/images/CSAPP-12/Untitled%206.png"/></a></figure><ul id="1b7ff891-7185-44d7-b43e-3b6c3d4f69cb" class="bulleted-list"><li style="list-style-type:circle">Poor performance ← The synchronization operations (<em>P </em>and <em>V</em>) are very expensive relative to the cost of a single memory update.</li></ul><ul id="479fe184-0273-4c10-b3b8-82c840c1fa2c" class="bulleted-list"><li style="list-style-type:circle">⇒ Synchronization overhead is expensive and should be avoided if possible.</li></ul></li></ul></details></li></ul><ul id="6a120acf-64e9-47de-a5a5-a2a0c1e88ed0" class="toggle"><li><details open=""><summary><strong>Avoiding Synchronization - </strong><strong><code>psum-array.c</code></strong><strong>, </strong><code><strong>psum-local.c</strong></code></summary><p id="10e199a2-152c-4cb9-bf36-cbb8b0aec2ae" class="">To <strong>avoid synchronization</strong>, have each peer thread compute its partial sum in a <strong>private variable</strong> that isn’t shared with any other thread.</p><pre id="95ead2c2-b15a-40f2-85cf-4ade7c19624b" class="code"><code>/* Thread routine for psum_arrayc.c */
void *sum_array(void *vargp) {
  long myid = *((long *)vargp); /* Extract the thread ID */
  long start = myid * nelems_per_thread; /* Start element index */
  long end = start + nelems_per_thread; /* End element index */
  long i;
  
  for (i = start; i &lt; end; i++) {
    psum[myid] += i;
  }
  return NULL;
}</code></pre><ul id="88e60ed1-476a-48da-bb1a-419c94963675" class="bulleted-list"><li style="list-style-type:disc">Each peer thread has a <strong>unique memory location</strong> to update → it is <strong>not necessary to protect</strong> these updates with mutexes!</li></ul><ul id="459a1e3d-f7dc-4a5f-8cfa-f4664115231f" class="bulleted-list"><li style="list-style-type:disc">Only necessary synchronization : <strong>Main thread</strong> must <strong>wait for all of the children </strong>to finish. → Finally, the main thread <strong>sums up the elements of the </strong><strong><code>psum</code></strong><strong> vector</strong> to arrive at the final result.</li></ul><ul id="928d3531-18b8-48ce-ac76-b7bee10653bf" class="bulleted-list"><li style="list-style-type:disc"><strong>Further optimization - Eliminating unnecessary memory references (</strong><code><strong>psum-local.c</strong></code>)<pre id="103d084e-24b7-4ed3-8893-737f088fc5aa" class="code"><code>for(i = start; i &lt; end; i++) {
  sum += i;
}
psum[myid] = sum;</code></pre></li></ul><ul id="ec47ae71-1078-418c-9a74-dc9fbe1e1264" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance (running time in seconds)</strong><figure id="98a5d551-02bf-40a7-906e-b0972b43b95b" class="image"><a href="/assets/images/CSAPP-12/Untitled%207.png"><img style="width:432px" src="/assets/images/CSAPP-12/Untitled%207.png"/></a></figure></li></ul></details></li></ul><ul id="f91b3e81-9603-4113-97f4-3472080176f3" class="toggle"><li><details open=""><summary><strong>Characterizing the Performance of Parallel Programs</strong></summary><ul id="e89d4c06-3f2b-401a-85cb-463a656b6b12" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance of </strong><strong><code>psum-local.c</code></strong><figure id="09e312b2-fd6e-4e2c-9b48-7ef230371a9d" class="image"><a href="/assets/images/CSAPP-12/Untitled%208.png"><img style="width:288px" src="/assets/images/CSAPP-12/Untitled%208.png"/></a></figure><ul id="0ea875d0-807a-4734-b647-6281a4041438" class="bulleted-list"><li style="list-style-type:circle">Running time <strong>decreases </strong>as we increase the number of threads, <strong>up to 4 threads</strong>.</li></ul><ul id="46546f92-581c-47d8-8beb-d20e0732fd96" class="bulleted-list"><li style="list-style-type:circle">Running time <strong>increases </strong>a bit as we increase the number of threads because of the <strong>overhead of context switching multiple threads on the same core</strong>.</li></ul><ul id="fa20bcc2-3cd5-4bf7-b82d-ef0c473a3553" class="bulleted-list"><li style="list-style-type:circle">⇒ Parallel programs are often written so that <strong>each core runs exactly one thread</strong>.</li></ul></li></ul><ul id="e68c7558-5811-4b72-adf9-68f4207fba1d" class="bulleted-list"><li style="list-style-type:disc"><strong>Speedup </strong>of a parallel program <strong>(Strong Scaling)</strong><ul id="10392996-e32a-4b85-a5e9-42b87851fa10" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub><mo>=</mo><mfrac><msub><mi>T</mi><mn>1</mn></msub><msub><mi>T</mi><mi>p</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">S_p=\frac{T_1}{T_p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.4307509999999999em;vertical-align:-0.5423199999999999em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8884309999999999em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:-0.13889em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.13889em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5423199999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><span>﻿</span></span>  (<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span></span><span>﻿</span></span> = # of processor cores and <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">T_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> = the running time on <em>k</em> cores)</li></ul><ul id="de679644-a680-45ff-9cf2-a477097a7e7f" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> = Execution time of a <strong>sequential version</strong> of the program → <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> = <strong>Absolute speedup</strong></li></ul><ul id="bd73754e-1dff-4796-8455-8153128534d5" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">T_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> = Execution time of a <strong>parallel version</strong> of the program running <strong>on one core</strong> → <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">S_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> = <strong>Relative speedup</strong></li></ul><ul id="acb58545-f176-430c-ad8c-31ee1aca2a92" class="bulleted-list"><li style="list-style-type:circle"><strong>Absolute speedup</strong> is <strong>truer measure</strong> of the <strong>benefits of parallelism</strong>. (Synchronization overheads can artificially inflate the relative speedup.)</li></ul><ul id="6bc35b78-5277-41b8-8d07-d5925443dc85" class="bulleted-list"><li style="list-style-type:circle"><strong>Absolute speedup</strong> is <strong>more difficult</strong> to measure - it requires <strong>two different versions</strong> of the program.</li></ul></li></ul><ul id="e005d6ae-a282-49f5-9167-f1d9b0c6a1a4" class="bulleted-list"><li style="list-style-type:disc"><strong>Efficiency of a parallel program</strong><ul id="8253916e-7dfc-4e37-bae5-93f415e25e38" class="bulleted-list"><li style="list-style-type:circle"><strong>Efficiency </strong>is a <strong>measure of the overhead</strong> due to parallelization. Programs with <strong>higher efficiency</strong> are spending <strong>more time doing useful work</strong> and <strong>less time synchronizing and communicating</strong>.</li></ul><ul id="012edd5b-7342-42ef-baa9-029d98be747d" class="bulleted-list"><li style="list-style-type:circle"><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>p</mi></msub><mo>=</mo><mfrac><msub><mi>S</mi><mi>p</mi></msub><mi>p</mi></mfrac><mo>=</mo><mfrac><msub><mi>T</mi><mn>1</mn></msub><mrow><mi>p</mi><msub><mi>T</mi><mi>p</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">E_p=\frac{S_p}{p}=\frac{T_1}{pT_p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.4667590000000001em;vertical-align:-0.481108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.985651em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.50732em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:-0.05764em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.481108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.4307509999999999em;vertical-align:-0.5423199999999999em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8884309999999999em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285716em;"><span style="top:-2.357em;margin-left:-0.13889em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.13889em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5423199999999999em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><span>﻿</span></span> (typically reported as a percentage in the range (0, 100].)</li></ul></li></ul><ul id="92338628-187c-486f-a8f3-4cb6c8d6ca6d" class="bulleted-list"><li style="list-style-type:disc"><strong>Weak Scaling</strong><ul id="4069148c-7b53-4dcd-a797-4a0c7414cb18" class="bulleted-list"><li style="list-style-type:circle"><strong>Weak scaling</strong> increases the <strong>problem size </strong>along with the <strong># of processors</strong>, such that the <strong>amount of work performed on each processor is held constant</strong> as the # of processor increases.</li></ul><ul id="28db2416-ddd3-4a82-8a60-5c55059175ec" class="bulleted-list"><li style="list-style-type:circle"><strong>Speedup and efficiency</strong> are expressed in terms of the <strong>total amount of work accomplished per unit</strong>.</li></ul><ul id="c7120644-4a41-4e56-8361-68cee7054b29" class="bulleted-list"><li style="list-style-type:circle">A <strong>truer measure</strong> than strong scaling - it more accurately reflects our desire to use bigger machines to do more work.</li></ul><ul id="d7fb5bd5-9502-4f77-b1d1-fda9a0110b7c" class="bulleted-list"><li style="list-style-type:circle">For applications whose <strong>sizes are not so easily increased</strong>, <strong>strong scaling</strong> is more appropriate. </li></ul></li></ul></details></li></ul></div><h2 id="131788c2-4886-4a66-b216-446dce8dc512" class=""><details open=""><summary><mark class="highlight-blue">12.7</mark> Other Concurrency Issues</summary></details></h2><div class="indented"><ul id="2f850a97-24e7-45ac-9a27-1af94987a228" class="toggle"><li><details open=""><summary><strong>Threads Safety</strong></summary><p id="f1a90ed6-f7dc-46d5-99cd-0fc774b1ccd3" class=""><strong>Thread-safe</strong> ↔ The function will <strong>always </strong>produce <strong>correct results</strong> when called repeatedly from <strong>multiple concurrent threads</strong>.</p><p id="828374b5-3fbf-4950-b283-95ab7a251b9a" class=""><strong>Classes of thread-unsafe functions:</strong></p><ul id="ff398fb4-3f24-42fa-9736-92ce02403e97" class="bulleted-list"><li style="list-style-type:disc"><strong>Class 1: Functions that do not protect shared variables</strong><ul id="f464d2a7-bfc7-4ffa-a319-3573c4c7b761" class="bulleted-list"><li style="list-style-type:circle">To make this class of thread-unsafe functions thread-safe, <strong>protect the shared variables</strong> with synchronization operations such as <strong><em>P</em></strong><strong> &amp; </strong><strong><em>V</em></strong>.</li></ul></li></ul><ul id="b4ee4952-3b69-4086-bf7f-b7061ffb6d05" class="bulleted-list"><li style="list-style-type:disc"><strong>Class 2: Functions that keep state across multiple invocations</strong><pre id="6f0ecc69-04d3-4253-9ed8-56d81367c040" class="code"><code>unsigned next_seed = 1;

/* rand - return pseudorandom integer in the range 0..32767 */
unsigned rand(void) {
  next_seed = next_seed*1103515245 + 12543;
  return (unsigned)(next_seed&gt;&gt;16) % 32768;
}

/* srand - set the initial seed for rand() */
void srand(unsigned new_seed) {
  next_seed = new_seed;
}</code></pre><ul id="6def15a5-cc7e-4fc3-804f-c089925c34c5" class="bulleted-list"><li style="list-style-type:circle">The result of the <strong>current invocation</strong> of <code>rand</code> depends on an <strong>intermediate result from the previous iteration</strong>.<p id="3645750b-b6dc-4d20-bf93-cac70ee51f50" class="">→ <strong>Can’t predict the result</strong> when multiple threads are calling <code>rand</code>.</p></li></ul><ul id="84453fe1-5d0e-4666-aeec-f130f3ab37cf" class="bulleted-list"><li style="list-style-type:circle">To make this class of thread-unsafe functions thread-safe, <strong>rewrite</strong> it so that it <strong>doesn’t use any </strong><strong><code>static</code></strong><strong> data</strong>, relying instead on the <strong>caller </strong>to <strong>pass the state information in arguments</strong>.</li></ul></li></ul><ul id="26bc5e1e-853c-4d08-99fa-52333da0ae17" class="bulleted-list"><li style="list-style-type:disc"><strong>Class 3: Functions that return a pointer to a static variable</strong><ul id="df002809-f1da-494a-953a-1e6423f562e5" class="bulleted-list"><li style="list-style-type:circle">The <strong>results </strong>of the functions being used by one thread <strong>can be silently overwritten</strong> by another thread. (<em>example : </em><code><em>ctime</em></code><em><em>, </em></em><code><em><em>gethostbyname</em></em></code>)</li></ul><ul id="67dbe3ef-4665-4746-ac39-07943d5056c9" class="bulleted-list"><li style="list-style-type:circle">To make these functions thread-safe, <strong>rewrite </strong>the function so that the <strong>caller </strong>passes <strong>the address of the variable</strong> in which <strong>to store the results</strong>.</li></ul><ul id="8d232875-7db0-4f2a-b12c-34d633c17265" class="bulleted-list"><li style="list-style-type:circle">Or use the <strong>lock-and-copy</strong> technique: associate a <strong>mutex </strong>with the thread-unsafe function.<ul id="af0a16af-0a1a-4eca-a8d0-6f5324087d25" class="bulleted-list"><li style="list-style-type:square">At each call site, <strong>lock the mutex</strong> → call the thread-unsafe function → copy the result returned by the function to a <strong>private memory location</strong> → <strong>unlock the mutex</strong>.</li></ul><ul id="964cdba8-7fc2-486e-9d84-7a3c4994277a" class="bulleted-list"><li style="list-style-type:square">Define a <strong>thread-safe wrapper</strong> function that performs the <strong>lock-and-copy</strong>.</li></ul></li></ul><ul id="2bf588a1-486f-4755-b10f-5a3c67123730" class="bulleted-list"><li style="list-style-type:circle"><strong>Thread-safe wrapper</strong> function for the C standard library <code>ctime</code> function</li></ul><pre id="ec13008f-644c-432a-af7e-5ac178e3eb91" class="code"><code>char *ctime_ts(const time_t *timep, char *privatep) {
  char *sharedp;

  P(&amp;mutex);
  sharedp = ctime(timep);
  strcpy(privatep, sharedp); /* Copy string from shared to private */
  V(&amp;mutex);
  return privatep;
}</code></pre></li></ul><ul id="064cee89-72a3-473e-bbf3-e2d52235ca1d" class="bulleted-list"><li style="list-style-type:disc"><strong>Class 4: Functions that call thread-unsafe functions</strong><ul id="f1b9d902-2c25-439d-a227-e815367230b2" class="bulleted-list"><li style="list-style-type:circle">If a function calls <strong>class 2 function</strong> : The caller is also <strong>thread-unsafe</strong>.</li></ul><ul id="ba52a63b-e5c4-44b0-af93-2246be5b312d" class="bulleted-list"><li style="list-style-type:circle">If a function calls <strong>class 1 or class 3 function</strong> : The caller can still be thread-safe if you <strong>protect the call site</strong> and any <strong>resulting shared data</strong> with a <strong>mutex</strong>.</li></ul></li></ul></details></li></ul><ul id="8a933cd1-87cc-4248-8e3f-052df3b67105" class="toggle"><li><details open=""><summary><strong>Reentrancy</strong></summary><figure id="d89741a4-de38-453b-8ffb-c431b27b5246" class="image"><a href="/assets/images/CSAPP-12/Untitled%209.png"><img style="width:288px" src="/assets/images/CSAPP-12/Untitled%209.png"/></a></figure><p id="e91cc042-f815-41c8-88f6-bd805151596c" class=""><strong>Reentrant functions</strong> are functions that <strong>do not reference any shared data</strong> when they are called by <strong>multiple threads</strong>.</p><ul id="a08114ca-688d-4c9e-85b6-f5cc60589cd5" class="bulleted-list"><li style="list-style-type:disc">The set of reentrant functions is a <strong>proper subset of the thread-safe functions</strong>.</li></ul><ul id="4d202b05-de2e-4bff-9d8d-44686de6e06a" class="bulleted-list"><li style="list-style-type:disc">Reentrant functions are typically <strong>more efficient</strong> than non-reentrant thread-safe functions - they require <strong>no synchronization operations</strong>.</li></ul><ul id="c538e793-55fb-475a-8477-736b32d8bad2" class="bulleted-list"><li style="list-style-type:disc">The only way to convert a <strong>class 2 thread-unsafe function</strong> into a thread-safe one is to <strong>rewrite it so that it is reentrant</strong>.</li></ul><ul id="25d5bbb8-bd49-4d33-84fd-256290dba835" class="bulleted-list"><li style="list-style-type:disc"><strong>Example Code - Reentrant version of the </strong><strong><code>rand</code></strong><pre id="26de8c55-97fb-4e45-a8d4-1b529c517809" class="code"><code>/* rand_r - return a pseudorandom integer on 0..32767 */
int rand_r(unsigned int *nextp) {
  *nextp = *nextp * 1103515245 + 12345;
  return (unsigned int)(*nextp / 65536) % 32768;
}</code></pre></li></ul><ul id="530ea511-22e0-4074-9dac-e5b762ab29e6" class="bulleted-list"><li style="list-style-type:disc">If all function arguments are <strong>passed by value (= no pointers)</strong> &amp; all data references are to local automatic stack variables (= <strong>no references to static or global variables</strong>), the function is <strong>explicitly reentrant</strong>.</li></ul><ul id="3e0a278b-edcc-46c5-8ce7-e9232b299855" class="bulleted-list"><li style="list-style-type:disc">If some <strong>parameters </strong>in otherwise explicitly reentrant function are <strong>passed by reference</strong> (= <strong>passing pointers</strong>), the function is <strong>implicitly reentrant</strong> - it is <strong>only reentrant</strong> if the calling threads are careful to <strong>pass pointers to nonshared data</strong>.</li></ul></details></li></ul><ul id="1223195b-632e-44ec-984c-410077b039fc" class="toggle"><li><details open=""><summary><strong>Using Existing Library Functions in Threaded Programs</strong></summary><ul id="f04c7abf-a18a-4076-9ea8-762c4fd4c92e" class="bulleted-list"><li style="list-style-type:disc"><strong>Common thread-unsafe library functions</strong><figure id="d7fe627c-ee1a-4c16-a546-173f00b2913e" class="image"><a href="/assets/images/CSAPP-12/Untitled%2010.png"><img style="width:528px" src="/assets/images/CSAPP-12/Untitled%2010.png"/></a></figure></li></ul><ul id="eb15e5a7-1e30-4ef9-9d17-cb37b759a983" class="bulleted-list"><li style="list-style-type:disc">To call one of these functions, use <strong>lock and copy</strong> technique.</li></ul><ul id="605c23ca-e82a-438c-828a-13949aafefa5" class="bulleted-list"><li style="list-style-type:disc"><strong>Lock and copy</strong> approach’s <strong>disadvantages</strong><ul id="7bfddc83-52e8-46f4-8a6c-b1aadb5978ca" class="bulleted-list"><li style="list-style-type:circle">Additional synchronization <strong>slows down </strong>the program.</li></ul><ul id="c504c56a-da2d-4031-8b7c-1fb664fecde8" class="bulleted-list"><li style="list-style-type:circle">Functions that <strong>return pointers to complex structures of structures</strong> require a <strong>deep copy</strong> of the structures to copy the entire structure hierarchy.</li></ul><ul id="c101cec8-5081-4abe-8050-9ecfb2ea0dd4" class="bulleted-list"><li style="list-style-type:circle">Lock-and-copy approach <strong>won’t work</strong> for a <strong>class 2 thread-unsafe function</strong>.</li></ul></li></ul></details></li></ul><ul id="84f05387-3eed-455a-8497-e5fc8224ecca" class="toggle"><li><details open=""><summary><strong>Races</strong></summary><p id="2e2c286f-c17e-4be6-8132-e784ffa023dc" class="">A <strong>race </strong>occurs when the <strong>correctness of a program</strong> depends on <strong>one thread reaching point x</strong> in its control flow before <strong>another thread reaches point y.</strong></p><ul id="12a28984-2e41-4704-879c-7462136e09b9" class="bulleted-list"><li style="list-style-type:disc"><strong>Example Code - A program with a race</strong><pre id="3e64ba66-1335-462e-bb2a-ed90766297f8" class="code"><code>/* WARNING: This code is buggy! */
#include &quot;csapp.h&quot;
#define N 4

void *thread(void *vargp);

int main() 
{
    pthread_t tid[N];
    int i;

    for (i = 0; i &lt; N; i++)
			Pthread_create(&amp;tid[i], NULL, thread, &amp;i);
    for (i = 0; i &lt; N; i++) 
			Pthread_join(tid[i], NULL);
    exit(0);
}

/* Thread routine */
void *thread(void *vargp) 
{
    int myid = *((int *)vargp);
    printf(&quot;Hello from thread %d\n&quot;, myid);
    return NULL;
}</code></pre><ul id="8b3d37c8-9dc2-44e9-83f4-4eadb941d678" class="bulleted-list"><li style="list-style-type:circle">A <strong>race </strong>is between each peer thread’s <strong>dereferencing and assignment of the argument</strong> and the main thread’s <strong>next increment of </strong><strong><code>i</code></strong>.</li></ul><ul id="060d10f6-0bcc-4776-94c4-0ba21c01cd6e" class="bulleted-list"><li style="list-style-type:circle">If the main thread increments <code>i</code> before the peer thread dereference and assign <code>vargp</code> to <code>myid</code>, <code>myid</code> will contain the ID of some other thread.</li></ul><ul id="eeeb34c8-86eb-48b8-a9e3-eb3d519ae5ff" class="bulleted-list"><li style="list-style-type:circle">To eliminate the race, <strong>dynamically allocate a separate block</strong> for each integer ID and pass the thread routine a pointer to this block.</li></ul><pre id="9d043f81-d084-4121-971a-5c7414d4d29c" class="code"><code>#include &quot;csapp.h&quot;
#define N 4

void *thread(void *vargp);

int main() 
{
    pthread_t tid[N];
    int i, *ptr;

    for (i = 0; i &lt; N; i++) {
			ptr = Malloc(sizeof(int));
			*ptr = i;
			Pthread_create(&amp;tid[i], NULL, thread, ptr);
		}
    for (i = 0; i &lt; N; i++) 
			Pthread_join(tid[i], NULL);
    exit(0);
}

/* Thread routine */
void *thread(void *vargp) 
{
    int myid = *((int *)vargp);
		Free(vargp);
    printf(&quot;Hello from thread %d\n&quot;, myid);
    return NULL;
}</code></pre></li></ul></details></li></ul><ul id="847271ca-c53e-4fdf-b082-47b55b07a05a" class="toggle"><li><details open=""><summary><strong>Deadlocks</strong></summary><p id="27d68f50-0895-428b-b7ff-8a566c2e45d3" class=""><strong>Deadlock </strong>is a kind of run-time error, where a <strong>collection of threads is blocked</strong>, waiting for a condition that will <strong>never be true</strong>.</p><figure id="7710e9bd-93b8-4f4c-ba09-5aa79e5f2697" class="image"><a href="/assets/images/CSAPP-12/Untitled%2011.png"><img style="width:432px" src="/assets/images/CSAPP-12/Untitled%2011.png"/></a></figure><ul id="07895286-1b1c-46c6-a47d-84b6cf37aee6" class="bulleted-list"><li style="list-style-type:disc">The programmer has <strong>incorrectly ordered the P &amp; V operations</strong> → The <strong>forbidden regions</strong> for the two semaphores <strong>overlap</strong>. → The <strong>deadlock region</strong> is created.</li></ul><ul id="9f31ed1d-6363-4eaa-ae94-9489e8bbf2f1" class="bulleted-list"><li style="list-style-type:disc">If a trajectory touch a state in the <strong>deadlock region</strong>, deadlock is <strong>inevitable</strong>: <strong>No further progress is possible</strong> because the overlapping forbidden regions block progress in every legal direction.</li></ul><ul id="9224f06d-53db-4148-9fc7-f4b6cf06a038" class="bulleted-list"><li style="list-style-type:disc">Deadlock is <strong>not always predictable</strong> - It doesn’t happen every time, or in every machine.</li></ul><ul id="de71a92e-8949-4314-84f3-530ada0163c2" class="bulleted-list"><li style="list-style-type:disc">When <strong>binary semaphores</strong> are used for <strong>mutual exclusion</strong>, apply the <strong>Mutex lock ordering rule</strong> to prevent deadlocks:<p id="c620e815-894e-4a61-b536-e0d687fe1c1d" class=""><strong>Mutex lock ordering rule </strong>: Given a total ordering of all mutexes, a program is deadlock-free if each thread acquires its mutexes in order and releases them in reverse order.</p></li></ul></details></li></ul></div></div></article></body></html>