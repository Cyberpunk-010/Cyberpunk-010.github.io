---
title:  "CS:APP Chapter 5 Summary ⚡"
excerpt: "Chatper 5 - Optimizing Program Performance"
toc: true
classes: wide

categories:
  - CSAPP

---
Recently, I've been studying CS:APP - I'm posting my own summary of chapter 5 that I wrote up using [Notion](https://cw00h.notion.site/CS-APP-6d3c5c01e6e1456ca51f594a80b5c1f0).

<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Chapter 5 : Optimizing Program Performance</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */

.Notion a,
.Notion a.visited {
	color: inherit;
	text-decoration: underline;
}

.Notion .pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

.Notion strong {
    font-weight: 600;
}

.Notion h1,
.Notion h2,
.Notion h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
    display: flex;
}

.Notion .page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

.Notion h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

.Notion h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

.Notion h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.Notion .source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.Notion .callout {
	border-radius: 3px;
	padding: 1rem;
}

.Notion figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

.Notion figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

.Notion mark {
	background-color: transparent;
}

.Notion .indented {
	padding-left: 1.5em;
}

.Notion hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

.Notion img {
	max-width: 100%;
    margin-bottom: 0;
}

@media only print {
	.Notion img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.Notion .collection-content {
	font-size: 0.875rem;
}

.Notion .column-list {
	display: flex;
	justify-content: space-between;
}

.Notion .column {
	padding: 0 1em;
}

.Notion .column:first-child {
	padding-left: 0;
}

.Notion .column:last-child {
	padding-right: 0;
}

.Notion .table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.Notion .table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.Notion .table_of_contents-indent-2 {
	margin-left: 3rem;
}

.Notion .table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.Notion .table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

.Notion table,
.Notion th,
.Notion td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

.Notion table {
	border-left: none;
	border-right: none;
}

.Notion th,
.Notion td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

.Notion th {
	color: rgba(55, 53, 47, 0.6);
}

.Notion ol,
.Notion ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

.Notion li > ol:first-child,
.Notion li > ul:first-child {
	margin-block-start: 0.6em;
}

.Notion ul > li {
	list-style: disc;
}

.Notion ul.to-do-list {
	text-indent: -1.7em;
}

.Notion ul.to-do-list > li {
	list-style: none;
}

.Notion .to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

.Notion ul.toggle > li {
	list-style: none;
}

.Notion ul {
	padding-inline-start: 1.7em;
}

.Notion ul > li {
	padding-left: 0.1em;
}

.Notion ol {
	padding-inline-start: 1.6em;
}

.Notion ol > li {
	padding-left: 0.2em;
}

.Notion .mono ol {
	padding-inline-start: 2em;
}

.Notion .mono ol > li {
	text-indent: -0.4em;
}

.Notion .toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.Notion .toggle > li > details {
	padding-left: 1.7em;
}

.Notion .toggle > li > details > summary {
	margin-left: -1.1em;
}

.Notion .selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.Notion .collection-title {
	display: inline-block;
	margin-right: 1em;
}

.Notion .simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
}

.Notion .simple-table-header {
	background: rgb(247, 246, 243);
	color: black;
	font-weight: 500;
}

.Notion time {
	opacity: 0.5;
}

.Notion .icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

.Notion img.icon {
	border-radius: 3px;
}

.Notion .user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.Notion .user-icon-inner {
	font-size: 0.8em;
}

.Notion .text-icon {
	border: 1px solid #000;
	text-align: center;
}

.Notion .page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.Notion .page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.Notion .page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.Notion .page-header-icon img {
	border-radius: 3px;
}

.Notion .link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

.Notion p > .user {
	opacity: 0.5;
}

.Notion td > .user,
.Notion td > time {
	white-space: nowrap;
}

.Notion input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

.Notion p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.Notion .image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.Notion .code,
.Notion code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

.Notion code {
	color: #eb5757;
}

.Notion .code {
	padding: 1.5em 1em;
}

.Notion .code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.Notion .code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

.Notion blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.Notion .bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.Notion .bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.Notion .bookmark-text {
	display: flex;
	flex-direction: column;
}

.Notion .bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.Notion .bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.Notion .bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="f377f94d-dbe9-4649-bbe1-2f323517cd30" class="page sans Notion" style="width: 100%; padding: 0px;"><div class="page-body"><h2 id="3aac175c-36e3-4eae-98d2-f552f3b01408" class=""><details open=""><summary><mark class="highlight-blue">5.1</mark> Capabilities and Limitations of Optimizing Compilers</summary></details></h2><div class="indented"><h3 id="72cf51f8-aaab-4703-bc06-ca794003103d" class=""><details open=""><summary><strong>Safe Optimizations</strong></summary></details></h3><div class="indented"><ul id="d92d052f-01ce-4930-9da0-eeb113821a51" class="bulleted-list"><li style="list-style-type:disc">Compilers must apply only <strong>safe optimization</strong>s to a program.</li></ul><ul id="103220e4-4407-4ab8-af4f-2d38f8283a11" class="bulleted-list"><li style="list-style-type:disc">Safe optimization means that resulting program will <strong>have the exact same behavior </strong>as would an unoptimized version for all possible cases the program may encounter.</li></ul></div><h3 id="809d81ff-07e3-43bc-95bb-33e98f2c1997" class=""><details open=""><summary><strong>Optimization blockers</strong></summary></details></h3><div class="indented"><ul id="80bbc961-7e1b-486f-a548-f428bb26443f" class="toggle"><li><details open=""><summary><strong>Optimization blockers</strong></summary><p id="7b448a68-ee07-4bb0-9b30-838f6f3059a5" class="">Optimization blockers are aspects of programs that can severely <strong>limit the opportunities for a compiler to generate optimized code</strong>.</p></details></li></ul><ul id="23d985fa-09a8-47d7-9455-7c3876b16c91" class="toggle"><li><details open=""><summary><strong>Memory Aliasing</strong></summary><p id="12f00f89-586b-47bf-9161-ae8b8ccf08b6" class="">Two pointers may <strong>designate the same memory location</strong>.</p><pre id="f79bd253-e743-40bf-b33e-24d6ffee27c9" class="code"><code>void twiddle1(long *xp, long *yp){ //requires 6 memory references
	*xp += *yp;
  *xp += *yp;
}

void twiddle2(long *xp, long *yp){ //requiers only 3 memory references
	*xp += 2 * *yp;
}</code></pre><p id="8a68de55-0b75-4068-b99f-285759fa9186" class="">If <strong>xp and yp are equal</strong>, function <code>twiddle1</code> and <code>twiddle2</code> will have different result.</p><p id="b9d8d270-a80c-4c64-a924-81df4628ea08" class="">In performing only safe optimizations, the compiler must <strong>assume that different pointers may be aliased</strong>.</p></details></li></ul><ul id="1ef18d28-a305-41b2-8478-8607d26c6b94" class="toggle"><li><details open=""><summary><strong>Function calls</strong></summary><p id="1e71b077-d145-4b4a-a14b-00df5891df31" class="">Functions have a <strong>side effect </strong>if it <strong>modifies some part of the global program state</strong>.<em> </em></p><pre id="932a73ca-afba-4ad7-b812-1c553e33b3d2" class="code"><code>long f();

long func1(){
	return f() + f() + f() + f();
}

long func2(){
  return f() * 4;
}</code></pre><p id="984758d7-b2ad-4784-aa7a-046edff10356" class="">It seems like func1 and <em>func2</em> would have identical results, but if <em>f</em> has a side effect, two functions will work differently.</p><pre id="736aceb7-15fd-4787-a01f-3bbf81d2eb23" class="code"><code>long counter = 0;

long f(){
	return counter++;
}</code></pre><p id="42f84fea-8eea-431e-bb04-cf1bd3b78d94" class="">Most compilers don’t try to determine whether a function is free of side effects. Instead, compilers assumes the worst case and <strong>leaves function calls intact</strong>.</p><p id="87f333ce-cc5f-496f-b420-242e82ccbf23" class="">
</p></details></li></ul></div></div><h2 id="4ae4976c-df51-44ac-a34b-99ec164c2510" class=""><details open=""><summary><mark class="highlight-blue">5.2</mark> Expressing Program Performance</summary></details></h2><div class="indented"><ul id="861bc599-75d2-44fa-93ee-b7a4b02285e5" class="toggle"><li><details open=""><summary><strong>CPE</strong></summary><p id="67332c74-c1a8-4437-8680-21db0d8214e8" class="">CPE, <strong><em>cycles per element</em></strong><em>, </em>is the metric we use to express program performance.</p><p id="e0415348-c1cf-4238-b20d-a124c726f2b2" class="">Many procedures contain a loop that <strong>iterates over a set of elements</strong>.</p><p id="51759ec7-c367-4095-bc80-69653dfd29cd" class="">The time required by such a procedure can be characterized as a <strong>constant + a factor proportional to the number of elements processed</strong>.</p><p id="c5183248-a8e6-4f69-94b0-6f97824f965a" class="">We refer to the <strong>coefficients </strong>in the terms as the effective number of cycles per element<em>.</em></p><p id="b0d9980e-f95f-4967-9309-14874e593c4f" class=""><em>example : If run time is approximated by 60 + 35n, CPE is 35.</em></p></details></li></ul><p id="5f75450f-7085-4ec7-a135-d6a13bba0eae" class="">
</p></div><h2 id="4947c7aa-c20a-4207-8365-0feadcaab95e" class=""><details open=""><summary><mark class="highlight-blue">5.3</mark> Program Example</summary></details></h2><div class="indented"><ul id="840259c8-d723-4d81-9669-e961c3de591a" class="toggle"><li><details open=""><summary><strong>Vector Data Structure</strong></summary><figure id="0d5d43db-300d-4818-9568-723430c21851" class="image"><a href="/assets/images/CSAPP-5/Untitled.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled.png"/></a></figure><p id="1d21452d-a4a5-4518-81a5-2096609afac0" class="">We will use a running example based on the <strong>vector data structure</strong> shown below.</p><pre id="589f6168-3c0c-49eb-ae89-815cd04a7972" class="code"><code>/*Create abstract data type for vector */
typedef struct {
	long len;
	data_t *data; //data_t can be either int, long, float, or double.
} vec_rec, *vec_ptr;</code></pre></details></li></ul><ul id="b4110fad-834b-43fe-9093-c2ec85df417c" class="toggle"><li><details open=""><summary><strong>Basic Procedures</strong></summary><p id="3d49f627-cfd4-4bfa-8e93-0bcbe0d2461a" class="">We use some basic procedures shown below for generating vectors, accessing vector elements, and determining the length of a vector.</p><ul id="80a006ba-c8b9-48d7-a6ca-87a64f1236c9" class="bulleted-list"><li style="list-style-type:disc">Generating vectors</li></ul><pre id="360f070a-5276-4099-b6d9-268588d92f44" class="code"><code>/* Create vector of specified length */
vec_ptr new_vec(long len){
	/* Allocate header structure */
	vec_ptr result = (vec_ptr) malloc(sizeof(vec_rec));
  data_t *data = NULL;
	if (!result) return NULL; //Couldn&#x27;t allocate storage
	result-&gt;len = len;
	
	/* Allocate array */
	if (len &gt; 0){
		data = (data_t *) calloc(len, sizeof(data_t));
		if(!data){
			free((void*) result);
			return NULL; //Couldn&#x27;t allocate storage
		}
	}
	/* Data will be NULL or allocated array */
	result-&gt;data = data;
	return result;
}</code></pre><ul id="dc5b7e3e-678e-41bf-a98e-469d300281d8" class="bulleted-list"><li style="list-style-type:disc">Accessing vector elements</li></ul><pre id="7926c775-bea0-4a77-899d-5c0c9c23896b" class="code"><code>/* Retrieve vector element and store at dest. */
/* Return 0 (out of bounds) or 1 (successful) */
int get_vec_element(vec_ptr v, long index, data_t *dest){
	if(index &lt; 0 || index &gt;= v-&gt;len) return 0; //bounds checking
	*dest = v-&gt;data[index];
	return 1;
}</code></pre><ul id="89203434-b795-45bc-bf7b-06cd6171c98f" class="bulleted-list"><li style="list-style-type:disc">Determining the length of a vector</li></ul><pre id="7d56fe22-766b-48d3-ab94-fd1fdd4de0b7" class="code"><code>long vec_length(vec_ptr v){
	return v-&gt;len;
}</code></pre></details></li></ul><ul id="ea45432e-17f0-440a-acc8-6ead727b7d70" class="toggle"><li><details open=""><summary><code><strong>Combine1</strong></code></summary><p id="2e1cff61-6a5c-454d-9fff-e5296916f032" class=""><code><strong>combine1</strong></code><strong> </strong>combines all of the elements in a vector into a single value according to some operation. </p><pre id="b0b0c939-59f5-46db-89a6-a922afc4651c" class="code"><code>void combine1(vec_ptr v, data_t *dest){
	long i;

	*dest = IDENT;
	for (i = 0; i &lt; vec_length(v); i++){
		data_t val;
		get_vec_element(v, i, &amp;val);
		*dest = *dest OP val;
	}
}</code></pre><p id="79f6c7fd-c543-4a2c-a696-fbccbd0d64e2" class=""><code>OP</code> and <code>IDENT</code> are compile-time constants. <code>combine1</code> can compute different values as <code>OP</code> and <code>IDENT</code> are defined differently.</p><pre id="a6550e52-d96b-476d-a126-b6a6fd7bca87" class="code"><code>#define IDENT 0
#define OP +
//combine1 will sum the elements of the vector.

#define IDENT 1
#define OP *
//combine1 will product the elements of the vector.</code></pre><p id="ad0bf84f-4371-46d5-89a4-cfba8ceb59d2" class="">We will proceed through a series of transformations of the code, writing different versions of the combining function.</p></details></li></ul><ul id="c916e506-a291-414e-bb7d-5a87bc1cf7b3" class="toggle"><li><details open=""><summary><strong>Measuring CPE performance</strong></summary><p id="f6c9f26c-fc2b-40bd-8d38-e9f753c2dd4f" class="">We measured the <strong>CPE performance</strong> of the functions on a machine with an <em>Intel Core i7 Haswell processor</em>, which we refer to as our reference machine.</p><ul id="a175c899-5bce-41ae-95c2-ad5410533114" class="bulleted-list"><li style="list-style-type:disc">CPE measurements for <code>combine1</code> running on our reference machine.</li></ul><table id="ed963f96-621d-43d7-b3c5-a761975d1045" class="simple-table"><tbody><tr id="08df0a72-90b1-423d-bed8-fdfdda8ba75f"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="4d1e3199-13ac-42d2-91ea-adb525bcb0e7"><td id="~PDO"><code>combine1</code></td><td id="be\]">Abstract unoptimized</td><td id="G_ZI">22.68</td><td id="zW_I">20.02</td><td id="\VI}">19.98</td><td id="mW|u">20.18</td></tr><tr id="1c975cb4-57c6-4426-a4a6-eae0e73f6b1a"><td id="~PDO"><code>combine1</code></td><td id="be\]">Abstract <code>-O1</code></td><td id="G_ZI">10.12</td><td id="zW_I">10.12</td><td id="\VI}">10.17</td><td id="mW|u">11.14</td></tr></tbody></table><p id="34a2a59d-7215-41bc-8ac2-818672947150" class="">As we can see, by simply <strong>giving the command-line option </strong><strong><code>-O1</code></strong>, enabling a basic set of optimizations, we can improve the program performance significantly.</p><p id="b409f415-8e84-489f-8216-92994f36ca2f" class="">
</p></details></li></ul></div><h2 id="db171108-b0ed-402f-804e-2071087e8451" class=""><details open=""><summary><mark class="highlight-blue">5.4</mark> Eliminating Loop Inefficiencies</summary></details></h2><div class="indented"><ul id="6c90f608-4cc9-45b8-b151-9dd3d8a32c03" class="toggle"><li><details open=""><summary><strong><code>combine2</code></strong> : <strong>Improving the inefficiency of the loop test</strong></summary><p id="4479e57a-8073-47ef-a5ae-4aa6035aa738" class=""><code>combine1</code> calls function <code>vec_length</code> as the test condition of the for loop.</p><p id="60c838c7-ba49-4f66-afaf-ac6488d5a669" class="">The test condition must be<strong> evaluated on every iteration of the loop</strong>, whereas<strong> the length of the vector doesn’t change</strong> as the loop proceeds.</p><p id="4fe57872-88fe-46e4-bf4b-23a0811de194" class="">We could therefore <strong>compute the vector length only once and use this value in the test condition.</strong></p><pre id="26900d82-df1d-430c-99e3-70b53281c963" class="code"><code>void combine2(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); //compute vector length only once
	
	*dest = IDENT;
	for(i = 0; i &lt; length; i++){
		data_t val;
		get_vec_element(v, i, &amp;val);
		*dest = *dest OP val;
  }
}</code></pre><ul id="d51a3788-54d9-495f-a441-8aefa6b2a43d" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance Improvement</strong></li></ul><p id="a1d2817d-0c38-49c8-a172-69e92e47229a" class="">This transformation has noticeable effect on the overall performance for some data types and operations, and minimal or even none for others.</p><table id="bacf66fa-18c4-4072-83d2-cab873f466a0" class="simple-table"><tbody><tr id="adc7f615-7edd-4693-a0f9-1d00c3f8c8c3"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="5f70c36b-9ae1-4c97-95e8-e82f927d918e"><td id="~PDO"><code>combine1</code></td><td id="be\]">Abstract <code>-O1</code></td><td id="G_ZI">10.12</td><td id="zW_I">10.12</td><td id="\VI}">10.17</td><td id="mW|u">11.14</td></tr><tr id="0ede9967-1d98-4aba-b9ae-d2bc010e8fdb"><td id="~PDO"><code>combine2</code></td><td id="be\]">Move <code>vec_length</code></td><td id="G_ZI">7.02</td><td id="zW_I">9.04</td><td id="\VI}">9.02</td><td id="mW|u">11.03</td></tr></tbody></table><p id="9b66abcd-29aa-4b73-a0b1-c7a9bef6c6a1" class="">
</p></details></li></ul><ul id="fa4c0a4c-e993-4ce2-ac87-edf8c6862f4b" class="toggle"><li><details open=""><summary><strong>Code Motion</strong></summary><ul id="3903db70-98b8-4002-9cf8-418f994a4682" class="toggle"><li><details open=""><summary><strong>Code motion</strong></summary><p id="224fa842-b294-4895-a601-5d6ab146bd05" class=""><strong>Code motion</strong> involves identifying a computation that is <strong>performed multiple times</strong>, but such that the<strong> result of the computation will not change</strong>.</p><p id="fd0fd182-ce82-41a8-90a4-745546505aff" class="">We can <strong>move the computation to an earlier section </strong>of the code that doesn’t get evaluated as often.</p></details></li></ul><ul id="9def4400-495a-4967-a599-5f3f767d395e" class="toggle"><li><details open=""><summary><strong>Code motion and compiler</strong></summary><p id="4850d534-407f-4641-91d2-7990bbbbb0fe" class="">Compilers can’t reliably detect whether or not a function will have <strong>side effects</strong>, so they are typically very <strong>cautious </strong>about making transformations that change <strong>where or how many times a procedure is called</strong>.</p><p id="4054eb2e-fd29-42fd-956a-5aabaa8394c9" class="">Therefore, the programmer must often help the compiler by <strong>explicitly performing code motion.</strong></p></details></li></ul></details></li></ul><ul id="37b44a57-b2a9-4790-9e7b-4ff363c206d0" class="toggle"><li><details open=""><summary><strong>Another Example of Loop Inefficiency</strong> : <code>lower1</code> and <code>lower2</code></summary><pre id="dcca835a-d5a4-47d9-aafc-4b8bc4b9d897" class="code"><code>void lower1(char *s){
	long i;
	for(i = 0; i &lt; strlen(s); ++i)
		if (s[i] &gt;= &#x27;A&#x27; &amp;&amp; s[i] &lt;= &#x27;Z&#x27;) s[i] -= (&#x27;A&#x27; - &#x27;a&#x27;);
}

void lower2(char *s){
	long i;
	long len = strlen(s); //compute length of string only once
	for(i = 0; i &lt; len; ++i)
		if (s[i] &gt;= &#x27;A&#x27; &amp;&amp; s[i] &lt;= &#x27;Z&#x27;) s[i] -= (&#x27;A&#x27; - &#x27;a&#x27;);
}</code></pre><p id="3d862c70-06c5-417a-b049-c306697c84f2" class=""><code>strlen</code> takes time proportional to the length of string. (<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span>)</p><p id="21f53815-4562-413f-9295-3230faee3c56" class="">Since <code>strlen</code> is called in each of the <em>n</em> iterations of <code>lower1</code>, the overall run time of <code>lower1</code> is proportional to <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>n</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">n^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>. (<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span>)</p><p id="6512e5cc-f496-4701-96ec-e818b741ad6a" class="">On the other hand, since <code>lower2</code> only calls <code>strlen</code> once, the overall run time of <code>lower2</code> is proportional to <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span></span><span>﻿</span></span>. (<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span>)</p><p id="895a155d-a8d1-4e2a-80fc-d275771c060f" class="">
</p></details></li></ul></div><h2 id="65574919-84f1-4cd8-8f0b-b4269c46b56d" class=""><details open=""><summary><mark class="highlight-blue">5.5</mark> Reducing Procedure Calls</summary></details></h2><div class="indented"><ul id="27182245-7e7a-48f1-b1a0-ab40bec02451" class="toggle"><li><details open=""><summary><strong>Reducing Procedure Calls</strong></summary><p id="341ee644-c556-4f32-a155-3ecc1197a72c" class="">Procedure calls can incur overhead and also block most forms of program optimization. We can<strong> reduce unnecessary procedure calls</strong> to optimize the overall performance.</p></details></li></ul><ul id="c7569d1c-4d09-45e9-aea6-a529ea507883" class="toggle"><li><details open=""><summary><strong><code>combine3</code></strong><strong> : Eliminating function calls within the loop</strong></summary><pre id="dac0aa39-9149-4d9a-b7dd-1a0ec45cf26b" class="code"><code>data_t *get_vec_start(vec_ptr v){
	return v-&gt;data;
}

void combine3(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); 
	data_t *data = get_vec_start(v); // get starting address of data array

	*dest = IDENT;
	for(i = 0; i &lt; length; i++){
		*dest = *dest OP data[i]; // access directly to the element
  }
}</code></pre><p id="117be40b-20c6-44f1-8985-18a74258341c" class="">Since all references of data array in <code>combine</code> are valid, we can <strong>eliminate the function calls in the inner loop</strong>.</p><ul id="54fde61e-87e1-49a9-9dab-22cbfc753bff" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance Improvement</strong></li></ul><p id="35ec1b32-4d93-4a74-98e9-e2d3d3c756bd" class="">Surprisingly, there is <strong>no apparent performance improvement</strong>. (Check <strong><mark class="highlight-blue">5.11</mark></strong>)</p><table id="e5564f93-9f58-4260-832f-9ea6533c2d91" class="simple-table"><tbody><tr id="ef3f3ca7-38ba-44e9-9740-7f4f928b2ce9"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="30daf925-b45c-44a3-9c9c-0f4df16ae12d"><td id="~PDO"><code>combine2</code></td><td id="be\]">Move <code>vec_length</code></td><td id="G_ZI">7.02</td><td id="zW_I">9.04</td><td id="\VI}">9.02</td><td id="mW|u">11.03</td></tr><tr id="d8eb0ad3-3d10-49e7-8d94-75bd8c555cba"><td id="~PDO"><code>combine3</code></td><td id="be\]">Direct data access</td><td id="G_ZI">7.17</td><td id="zW_I">9.02</td><td id="\VI}">9.02</td><td id="mW|u">11.03</td></tr></tbody></table><p id="03bc066f-3392-4d1a-a7a3-a31d258e101b" class="">
</p></details></li></ul></div><h2 id="f3fc3f58-b80a-4695-a727-f7061ed3a067" class=""><details open=""><summary><mark class="highlight-blue">5.6</mark> Eliminating Unneeded Memory References</summary></details></h2><div class="indented"><ul id="95729554-7d0d-491d-8401-84f243033bec" class="toggle"><li><details open=""><summary><strong>Unnecessary Memory references in </strong><strong><code>combine3</code></strong></summary><ul id="a2661d6f-fc1a-4f97-9973-19449030ebea" class="bulleted-list"><li style="list-style-type:disc">x86-64 code of inner loop of <code>combine3</code> (<code>data_t</code> = <code>double</code>, <code>OP</code> = <code>*</code>)</li></ul><figure id="2f85321b-c951-4549-9ca6-7a77f378d620" class="image"><a href="/assets/images/CSAPP-5/Untitled 1.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled 1.png"/></a></figure><p id="2b0ef32a-0751-4134-89f7-e223ca59a2e4" class="">Accumulated value is <strong>read from and written to memory on each iteration</strong>. (Line 2, 4)</p><p id="4deeea36-9b37-490b-a925-193242991e12" class="">Since the value read from <code>dest</code> at the beginning of each iteration should simply be the value written at the end of the previous iteration, this reading and writing is <strong>wasteful.</strong></p></details></li></ul><ul id="3483577a-1d71-4609-bbae-56eb0c45bd38" class="toggle"><li><details open=""><summary><strong><code>combine4</code></strong><strong> : Accumulating result in temporary</strong></summary><pre id="bb641608-96c3-45a6-84d3-2e76ffd8e73f" class="code"><code>void combine4(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); 
	data_t *data = get_vec_start(v);
	data_t acc = IDENT;	// hold accumulated value in local var acc

	for(i = 0; i &lt; length; i++){
		acc = acc OP data[i]; // accumulate result in acc
  }
}</code></pre><p id="45677dd0-86c3-4648-9591-646f4b3b9ee8" class="">By eliminating unneeded memory reference in <code>combine3</code>, we have reduced the memory operations per iteration <strong>from 2 reads and 1 write to just a single read</strong>.</p><figure id="f119d487-c9b9-4e44-902d-5eee7f87fef7" class="image"><a href="/assets/images/CSAPP-5/Untitled%202.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled%202.png"/></a></figure><ul id="28a5af7f-0dad-4989-ac96-0998e1a9a5b2" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance Improvement</strong></li></ul><p id="a96e30eb-7183-45f1-919f-dfe9bf656ebd" class="">There is a <strong>significant improvement</strong> in program performance.</p><table id="0400a49d-fdb5-498a-9520-21134ed69f10" class="simple-table"><tbody><tr id="45d9012a-06eb-4b30-a1b0-adefc18d09ac"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="a595e0a3-a07e-4914-927d-b7c8fa9d2730"><td id="~PDO"><code>combine3</code></td><td id="be\]">Direct data access</td><td id="G_ZI">7.17</td><td id="zW_I">9.02</td><td id="\VI}">9.02</td><td id="mW|u">11.03</td></tr><tr id="1d96bca3-41bc-4bcd-9ffb-008691e46495"><td id="~PDO"><code>combine4</code></td><td id="be\]">Accumulate in temporary</td><td id="G_ZI">1.27</td><td id="zW_I">3.01</td><td id="\VI}">3.01</td><td id="mW|u">5.01</td></tr></tbody></table></details></li></ul><ul id="da1328cc-42ad-4bf4-8c83-c417543a578a" class="toggle"><li><details open=""><summary><strong>Different behaviors between </strong><strong><code>combine3</code></strong><strong> and </strong><strong><code>combine4</code></strong></summary><p id="7c6176be-1820-4464-880a-59a16c64c6ca" class=""><code>combine3</code> and <code>combine4</code> can behave differently due to <strong>memory aliasing</strong>.</p><ul id="c3563859-a9ea-424f-b85f-abeb618220ff" class="bulleted-list"><li style="list-style-type:disc">Example of memory aliasing</li></ul><p id="dece4d90-c7e9-47d5-a5b6-c552dfc9e1b7" class="">Let <code>v = [2, 3, 5]</code>, and consider following two function calls :</p><pre id="62704a05-e663-429e-8dc3-a8a3c3713b54" class="code"><code>combine3(v, get_vec_start(v) + 2);
combine4(v, get_vec_start(v) + 2);</code></pre><p id="cb494abf-d7d9-444e-9e58-29312f9ac0f8" class="">We create an<strong> alias between the last element of the vector and the destination for storing the result</strong>. The two functions would execute as follows :</p><figure id="a4ebda08-390f-4700-8c48-7ea5f6f05178" class="image"><a href="/assets/images/CSAPP-5/Untitled%203.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled%203.png"/></a></figure><p id="1e0a6ee7-7e40-49e8-84d2-e92ed97b9efd" class="">Since <code>combine3</code> and <code>combine4</code> can behave differently in corner cases like this, compiler can’t automatically transform <code>combine3</code> to accumulate the value in a register. </p></details></li></ul><ul id="4c2acdc7-c246-4de4-b1f7-1031b954eaa7" class="toggle"><li><details open=""><summary><strong><code>combine3w</code></strong><strong> : compiler’s optimization for </strong><code><strong>combine3</strong></code></summary><pre id="419ac8dd-cb66-4bbd-9393-f701e23ef2d4" class="code"><code>void combine3w(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); 
	data_t *data = get_vec_start(v);
	data_t acc = IDENT;

	/* Initialize in event length &lt;= 0 */
	*dest = acc;

	for(i = 0; i &lt; length; i++){
		acc = acc OP data[i];
		*dest = acc; // make sure dest updated on each iteration
  }
}</code></pre><p id="dca717fe-c73d-485e-9d63-753efc96c0f0" class="">When we use <code>GCC</code> to compile <code>combine3</code> with command-line option <code>-O2</code>, we get x86-64 code of optimized version that operates much like the C code above. </p><p id="35b3d4ae-2a4d-424a-826a-19d1dd67dd63" class="">In this optimization, <code>combine3w</code> will operate same even when memory aliasing occurs because<strong> location </strong><strong><code>dest</code></strong><strong> is updated on each iteration</strong>. </p></details></li></ul></div><h2 id="7c6e52e4-7a1e-42d9-a5ef-f1ef7848d396" class=""><details open=""><summary><mark class="highlight-blue">5.7</mark> Understanding Modern Processors</summary></details></h2><div class="indented"><ul id="01beca6d-8a16-4b15-9d6b-21a1a28b758c" class="toggle"><li><details open=""><summary><strong>Overall Operation</strong></summary><figure id="cabdbb74-c061-4902-9d37-10d6a298f9c0" class="image"><a href="/assets/images/CSAPP-5/Untitled%204.png"><img style="width:432px" src="/assets/images/CSAPP-5/Untitled%204.png"/></a></figure><ul id="41b663ce-b496-457d-b1cf-297b1f7aa3e9" class="toggle"><li><details open=""><summary><strong>Superscalar &amp; Out of Order</strong></summary><p id="8aa77ac4-cde0-4354-a867-76d5e305c4b4" class="">Our hypothetical processor are <strong>superscalar </strong>and <strong>out of order</strong>.</p><p id="0812f8b5-892c-4294-869b-f4120e027b08" class=""><strong>Superscalar </strong>processors can <strong>perform multiple operations on every clock cycle</strong>.</p><p id="1855f121-415b-4b24-ac7b-8dc42e4bc2ff" class="">For processors that are <strong>out of order</strong>, the order in which instructions execute need <strong>not correspond to their ordering in the machine-level program</strong>. </p></details></li></ul><ul id="e840af4a-917a-4f4b-b79f-55a441a91ae3" class="toggle"><li><details open=""><summary><strong>ICU(Instruction Control Unit)</strong></summary><p id="daa8efa5-c360-4511-a39b-4066e4652361" class=""><strong>ICU </strong>is responsible for <strong>reading a sequence of instructions</strong> from memory and <strong>generating</strong> <strong>a set of primitive operations</strong> from the instructions to perform on program data.</p><ul id="d0320e42-8269-44b9-b412-61d9ccae8103" class="bulleted-list"><li style="list-style-type:disc"><strong>Instruction Cache</strong></li></ul><p id="5effc477-29c2-4599-8935-e5111bf3b420" class="">ICU reads the instructions from an instruction cache - a special high-speed memory<strong> containing the most recently accessed instructions</strong>.</p><ul id="79cf42fa-d540-4708-b326-412deb461522" class="bulleted-list"><li style="list-style-type:disc"><strong>Fetch Control</strong></li></ul><p id="535ea551-bf15-4ff1-a76f-7df24bde908c" class="">Modern processors employ <strong>branch prediction</strong> - they <strong>guess whether or not a branch will be taken</strong> and also predict <strong>the target address for the branch</strong>.</p><p id="48a94741-e514-4cde-95d7-164508b1a021" class="">Using a technique known as <strong>speculative execution</strong>, the processor begins fetching, decoding instructions, and executing these operations at where it predicts the branch will go,<strong> before it has been determined whether or not the branch prediction was correct</strong>.</p><p id="32bf8884-b4bb-4e17-b0a0-7ff974f77923" class="">The block labeled “<strong>Fetch Control</strong>” incorporates branch prediction.</p><ul id="45610bf3-2399-4b88-b596-a499e9543767" class="bulleted-list"><li style="list-style-type:disc"><strong>Instruction Decode</strong></li></ul><p id="6133e56f-cb45-425a-9beb-ce1f8ea3989c" class="">The <strong>instruction decoding logic</strong> takes the actual program instructions and <strong>converts them into a set of primitive operations</strong>.</p><p id="795b4087-25f8-4573-9556-8689df70c792" class="">For example, in a typical x86 implementation, an instruction <code>addq %rax, 8(%rdx)</code> yields multiple operations. - one to load a value from memory into the processor, one to add the loaded value to the value in <code>%eax</code>, and one to store the result back to memory.</p><ul id="410f56ed-bdd9-4aa8-9a1c-a9a5e718cd4f" class="bulleted-list"><li style="list-style-type:disc"><strong>Retirement Unit</strong></li></ul><p id="13bb3eb8-0af8-4d09-9d04-67909b453cba" class="">The <strong>retirement unit</strong> keeps track of the ongoing processing and <strong>makes sure that it obeys the sequential semantics of the machine-level program</strong>. The retirement unit <strong>controls the updating of register file</strong>.</p><p id="1f4352f9-297d-43cc-9d51-a61cb8eb22fc" class="">The detailed description of retirement unit will be discussed below.</p></details></li></ul><ul id="cfc5a302-0f43-4a87-833d-123bf54d6a1f" class="toggle"><li><details open=""><summary><strong>EU (Execution Unit)</strong></summary><p id="6eae5481-b299-4e28-9e1a-e7302e7775ca" class=""><strong>EU </strong>receives a number of <strong>operations from the instruction fetch unit</strong> on each clock cycle, then <strong>executes the primitive operations</strong>.</p><ul id="07da1a07-8a5d-4282-b87a-051737d19968" class="bulleted-list"><li style="list-style-type:disc"><strong>Functional Units</strong></li></ul><p id="3cee13f0-4213-47da-86e0-bd501488182f" class="">Received operations are dispatched to a set of <strong>functional units</strong> that <strong>perform the actual operations.</strong></p><ul id="9555d8f7-3d3f-4a9c-9c2b-4d2f1f14955c" class="bulleted-list"><li style="list-style-type:disc"><strong>Functional Units - Load and store units</strong></li></ul><p id="9a2472f6-440c-4c19-8f5b-2554d55fb0d2" class=""><strong>Load and store </strong>units handle operations that <strong>read data from memory into the processor</strong>, and operations that <strong>write data from the processor to the memory</strong> respectively. </p><p id="0e43f3c5-b70e-4bf9-90d0-b48744874bd2" class="">Load and store units have an <strong>adder</strong> to perform address computations. </p><p id="24fb252e-64d0-4646-8f72-23a2335ba76d" class="">Load and store units access memory via a <strong>data cache</strong>, a high speed memory containing the <strong>most recently accessed data values</strong>.</p><ul id="2f8a58fb-2aaa-4e1a-849d-2dfc06797ef6" class="bulleted-list"><li style="list-style-type:disc"><strong>Functional Units - Branch unit</strong></li></ul><p id="d7100a8c-ae99-4dd8-9c9b-a70eb28415df" class="">Branch operations are sent to EU, to <strong>determine whether or not the prediction was correct</strong>. </p><p id="d364e676-833c-4447-ab89-be0b9637a385" class="">If prediction was <strong>incorrect →</strong> EU will <strong>discard the computed results</strong> beyond the branch point, signal the branch unit that the prediction was incorrect, and <strong>indicate the correct branch destination</strong>. → <strong>Branch unit</strong> begins <strong>fetching at the new location</strong>.</p><p id="28a4a311-fb7b-469b-bc7a-a11926d6f70b" class="">Such a <strong>misprediction </strong>incurs a <strong>significant cost in performance</strong>. </p><ul id="0e29bb50-e191-4ee4-825b-3b665c2f3a7c" class="bulleted-list"><li style="list-style-type:disc"><strong>Functional Units - Arithmetic units</strong></li></ul><p id="75a68a59-a39c-417c-a9c2-db96a98d946f" class="">The <strong>arithmetic units</strong> perform different combinations of <strong>integer and floating point operations.</strong></p><p id="ce00bcde-0a3d-4dc6-b0ca-5129e906f248" class="">The arithmetic units are intentionally designed to be able to <strong>perform a variety of different operations</strong>, since the <strong>required operations vary</strong> widely across different programs. </p><p id="eec0227c-c10d-4866-952f-ac7b98d479c7" class="">For example, Intel Core i7 Haswell reference machine has 8 functional units. Here is a partial list of each one’s capabilities:</p><hr id="52238055-2092-4dc5-98d0-da4d5d2cb95f"/><p id="c0f9e400-102d-4f92-bb58-d11400784897" class=""><mark class="highlight-gray"><em>0. Integer arithmetic, floating-point multiplication, integer and floating-point
division, branches</em></mark></p><p id="676b6116-3f30-43dc-9139-7a9524a778f7" class=""><mark class="highlight-gray"><em>1. Integer arithmetic, floating-point addition, integer multiplication, floating point multiplication</em></mark></p><p id="1a59e6f3-8e07-48eb-b5d3-e903c99befad" class=""><mark class="highlight-gray"><em>2. Load, address computation</em></mark></p><p id="80d90f88-f2ff-4bee-a7f2-9c8e2de7a3a8" class=""><mark class="highlight-gray"><em>3. Load, address computation</em></mark></p><p id="1e3e2e6a-5c42-4ef3-a64e-fdcff25060c0" class=""><mark class="highlight-gray"><em>4. Store</em></mark></p><p id="3070e759-f4e6-4398-b0c7-bd3a8a2de65d" class=""><mark class="highlight-gray"><em>5. Integer arithmetic</em></mark></p><p id="fb69bf67-8a98-4920-9ef5-54dd063c9f73" class=""><mark class="highlight-gray"><em>6. Integer arithmetic, branches</em></mark></p><p id="dbc690a6-3ca7-4732-b106-9d6e8ab86549" class=""><mark class="highlight-gray"><em>7. Store address computation</em></mark></p><hr id="9fc9b5ad-1f61-4f8b-8171-4082a00a115b"/><p id="a46c090f-4312-456f-b356-8f60ecdf3f15" class="">This combination of functional units has the potential to <strong>perform multiple operations of the same type simultaneously</strong>. (For example, it has 4 units capable of performing integer operations.)</p></details></li></ul><ul id="e40c682e-6617-489f-b7f7-6e1f2859ec8c" class="toggle"><li><details open=""><summary><strong>Retirement &amp; Flush</strong></summary><p id="9ec486b9-11a9-4b92-bd08-2fcdc88ad4d8" class="">As an instruction is decoded in ICU, information about it is placed into a queue. This information remains in the queue until 2 outcomes occurs :</p><ul id="a2a4588a-1d5e-4184-a2f1-8b626c430bc1" class="bulleted-list"><li style="list-style-type:disc"><strong>Retirement</strong></li></ul><p id="ad047e31-2b81-43e7-ace3-b8acb366e415" class="">The operations have completed and any branch points leading to this instruction are confirmed as being <strong>correctly predicted </strong>→<strong> </strong>The instruction can be <strong>retired</strong>, <strong>with any updates to the program registers being made</strong>.</p><ul id="af3d8509-5b5d-4108-a2da-6ec2b954c13a" class="bulleted-list"><li style="list-style-type:disc"><strong>Flush</strong></li></ul><p id="8d7b3a1f-2599-4ccd-b7dd-7690049e38e8" class="">Some branch point leading to this instruction was <strong>mispredicted →</strong> The instruction will be <strong>flushed</strong>, <strong>discarding any results</strong> that may have been computed.</p></details></li></ul><ul id="bcb32ca5-22bd-4c28-94a7-5d4853de8247" class="toggle"><li><details open=""><summary><strong>Exchanging Operation results</strong></summary><p id="f79f43c9-d360-4c95-956b-634c8c65935e" class="">To expedite the communication of results from one instruction to another, much of this information is <strong>exchanged among the execution units</strong>, shown in the figure as <strong>Operation results. </strong>This is a more elaborate form of the <strong>data-forwarding technique</strong>.</p><ul id="33a573b3-dc1c-49d6-a951-a86ab02b75f4" class="bulleted-list"><li style="list-style-type:disc"><strong>Register Renaming</strong></li></ul><p id="701fcad1-6de2-4578-8531-560f78544c00" class=""><strong>Register renaming</strong> is one of the most common mechanism for controlling the communication of operands among the execution. </p><p id="aa432785-03fd-40a7-88f3-3ebaff76af72" class="">When an instruction that <strong>updates register </strong><strong><em>r </em></strong>is decoded, a <strong>tag </strong><strong><em>t</em></strong><strong> </strong>is generated giving a unique identifier to the result of the operation. An entry<strong> </strong><strong><em>(r, t)</em></strong><strong> </strong>is added to a table maintaining the association between program register <em>r</em> and tag <em>t </em>for an operation that will update register <em>r</em>. When a <strong>subsequent instruction using register </strong><strong><em>r</em></strong> as an operand is decoded, the operation sent to the execution unit will <strong>contain </strong><strong><em>t</em></strong><strong> as the source</strong> for the operand value. </p><p id="449d5736-21b8-41b6-9476-2dc42b233fcf" class="">When some execution unit completes the first operation, it generates a result <strong><em>(v, t)</em></strong>, indicating that the <strong>operation with tag </strong><strong><em>t </em></strong><strong>produced value </strong><strong><em>v</em></strong>. <strong>Any operation waiting for </strong><strong><em>t</em></strong><strong> as source will then use </strong><strong><em>v</em></strong><strong> as the source value</strong>, a form of data forwarding.</p><p id="97f7bb76-c0c3-46c3-b863-e2e8bbb7195f" class="">Using register renaming, values can be <strong>forwarded directly from one operation to another</strong>, rather than being written to and read from the register file. Also, an entire sequence of operations can be performed <strong>speculatively</strong>, even though <strong>the</strong> <strong>registers are updated only after the processor is certain of the branch outcomes</strong>.</p><p id="c552e52a-a395-4adc-b434-dc7c5610c260" class="">
</p></details></li></ul></details></li></ul><ul id="b87d7418-83fd-4993-88e0-b3b4eba96082" class="toggle"><li><details open=""><summary><strong>Functional Unit Performance - Latency bound and Throughput bound</strong></summary><figure id="92870776-f326-4f80-8daa-4c37576f7db4" class="image"><a href="/assets/images/CSAPP-5/Untitled%205.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled%205.png"/></a></figure><ul id="51743b55-ea4a-44c9-b80e-c019a828f718" class="bulleted-list"><li style="list-style-type:disc"><strong>Latency </strong>: the total time required to perform the operation</li></ul><ul id="875c4430-1c61-4cdd-ae95-86535354c25d" class="bulleted-list"><li style="list-style-type:disc"><strong>Issue time </strong>: the minimum number of clock cycles between two independent operations of the same type</li></ul><ul id="2a96b895-d41e-4729-b085-bac17cf22aba" class="bulleted-list"><li style="list-style-type:disc"><strong>Capacity </strong>: the number of functional units capable of performing that operation</li></ul><p id="06d5fa94-dbe4-4bc9-a3e7-1cf729b35f3d" class="">The addition and multiplication operations all have<strong> issue times of 1</strong> → The processor can <strong>start a new one of these operations on each clock cycle</strong>. This short issue time is achieved through the use of <strong>pipelining</strong>. Functional units with issue times of 1 cycle are said to be<strong> fully pipelined</strong>.</p><p id="31629874-7deb-4aff-976d-0464048a7ab9" class="">Divider is <strong>not pipelined</strong>(its issue time equals its latency) → the divider must perform a complete division before it can begin a new one.</p><ul id="6d8ad830-d7f5-4e70-b78f-82694bbf064f" class="bulleted-list"><li style="list-style-type:disc"><strong>Throughput </strong>: reciprocal of the issue time, the number of operations executed on each clock cycle</li></ul><p id="76578440-afb9-4305-9b3c-cdb7bfbdcefc" class="">For an operation with <strong>capacity </strong><strong><em>C</em></strong> and<strong> issue time </strong><strong><em>I</em></strong>, the processor can achieve a<strong> throughput</strong> of<strong> </strong><strong><em>C/I</em></strong><strong> </strong>operations per clock cycle. <em>(example : our reference machine can perform floating-point multiplication at a rate of 2 per clock cycle.)</em></p><figure id="4048519c-e351-466c-b480-3631e6a63394" class="image"><a href="/assets/images/CSAPP-5/Untitled%206.png"><img style="width:288px" src="/assets/images/CSAPP-5/Untitled%206.png"/></a></figure><ul id="8cc1cabf-b698-4d7c-bb27-559f437eb160" class="bulleted-list"><li style="list-style-type:disc"><strong>Latency bound</strong></li></ul><p id="fb5a6f54-79a5-4ee5-abf4-b0177496704c" class=""><strong>Latency bound</strong> gives a <strong>minimum value</strong> for the CPE for any function that must <strong>perform the combining operation in a strict sequence</strong>. </p><ul id="3d67cd84-5068-4ede-ad12-88cd5a5d7222" class="bulleted-list"><li style="list-style-type:disc"><strong>Throughput bound</strong></li></ul><p id="32831860-885a-4a14-81e9-318a4f163a9a" class=""><strong>Throughput bound</strong> gives a <strong>minimum bound</strong> for the CPE <strong>based on the maximum rate at which the functional units can produce results</strong>. </p><ul id="14f628d0-f9d6-4894-b548-b9c367b0305a" class="bulleted-list"><li style="list-style-type:disc"><strong>Examples</strong></li></ul><p id="7ab50d7a-281a-4ece-9bc4-f3a1f2d40fd0" class="">There is only <strong>one integer multiplier</strong> having an issue time of 1 clock cycle → the processor can’t sustain a rate of more than <strong>1</strong> <strong>multiplication per clock cycle</strong>. </p><p id="bef90fac-3a32-4d5e-a897-b3403e8fb450" class="">With <strong>four integer adder</strong>, the processor can sustain a rate of 4 operations per cycle. However, <strong>two load units</strong> limit the processor to reading <strong>at most 2 data values per clock cycle → </strong>yields throughput bound of <strong>0.5</strong>. </p></details></li></ul><ul id="f20e9807-a1d6-4e95-a386-f6b07bfae705" class="toggle"><li><details open=""><summary><strong>An Abstract Model of Processor Operation</strong></summary><figure id="a0993871-6caa-40be-a99e-668a8b924ad2" class="image"><a href="/assets/images/CSAPP-5/Untitled%207.png"><img style="width:576px" src="/assets/images/CSAPP-5/Untitled%207.png"/></a></figure><p id="35740880-4710-4689-98d5-ec83a5f34f38" class="">CPE measurements obtained for <code>combine4</code> match the <strong>latency bound</strong> for the processor, except for the case of integer addition. → The performance of these functions is<strong> dictated by the latency of the sum or product computation</strong>.</p><ul id="924e412d-cb47-4b5a-9b45-31f44fbc38c6" class="bulleted-list"><li style="list-style-type:disc"><strong>From Machine-Level Code to Data-Flow Graphs</strong></li></ul><p id="253e93ea-07d5-4268-bb41-19b147b3d478" class="">We will visualize how the data dependencies in a program dictate its performance using <strong>data-flow graph</strong> of <code>combine4</code>. Since the <strong>computation performed by the loop is the dominating factor in performance</strong> for large vectors, we focus just on this.</p><figure id="6b6b9c65-1749-49d0-a3ee-6c04787deb36" class="image"><a href="/assets/images/CSAPP-5/Untitled%208.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled%208.png"/></a></figure><figure id="3c88fe42-8419-42ea-b861-586026ba1b12" class="image"><a href="/assets/images/CSAPP-5/Untitled%209.png"><img style="width:192px" src="/assets/images/CSAPP-5/Untitled%209.png"/></a></figure><p id="1474824f-c25f-4335-b354-938788cec7f5" class=""><strong>Four instructions</strong> are expanded into a series of<strong> 5 operations</strong>, with the initial <strong>multiplication instruction being expanded into a </strong><strong><code>load</code></strong><strong> operation and a </strong><strong><code>mul</code></strong><strong> operation</strong>.</p><p id="56d2681e-e104-419c-9f0c-afd5beed5749" class="">Some of the operations in data-flow graph produce <strong>values that</strong> <strong>do not correspond to registers</strong> - <code>load</code> reads a value from memory and passes it directly to <code>mul</code>, and <code>cmp</code> updates the condition codes, which are then tested by <code>jne</code>.</p><p id="df575f29-c144-4d09-ad98-a491e00e7082" class="">For a code segment forming a loop, we can classify the registers that are accessed into 4 categories:</p><hr id="9f39e07c-6e03-4a15-9628-6e482ec99447"/><ul id="bd53bffd-f800-427d-95c6-a520b7feafa0" class="bulleted-list"><li style="list-style-type:disc"><strong>Read-only </strong></li></ul><p id="7488f87c-3825-47c1-a442-31e7650ad578" class="">These are used as source values, either as data or to compute memory addresses, but they are <strong>not modified within the loop</strong>. <em>(example : </em><code><em>%rax</em></code><em> in </em><code><em>combine4</em></code><em><em>)</em></em></p><ul id="621e5226-3213-4759-b207-a70f31448afd" class="bulleted-list"><li style="list-style-type:disc"><strong>Write-only</strong></li></ul><p id="bb73fecb-d61a-4b1d-b8f0-8b5c43d844f0" class="">These are used as the <strong>destinations of data-movement operations</strong>.</p><ul id="12e29923-66ab-4e94-b591-b31bf92fd9f5" class="bulleted-list"><li style="list-style-type:disc"><strong>Local</strong></li></ul><p id="a40f5c96-7833-4a26-b425-b72c86cbebe6" class="">These are updated and used within the loop, but there is <strong>no dependency from one iteration to another</strong>. <em>(example : condition code registers in </em><code><em>combine4</em></code><em>)</em></p><ul id="55c504bd-0d31-49f7-b937-92a2d3e84381" class="bulleted-list"><li style="list-style-type:disc"><strong>Loop</strong></li></ul><p id="f3189461-0b36-4054-a537-7fdc99998f04" class="">These are used <strong>both as source values and as destinations</strong> for the loop, with the value generated in one iteration being used in another. <em>(example : </em><code><em>%rdx</em></code><em>, </em><code><em>%xmm0</em></code><em> in </em><code><em>combine4</em></code><em>)</em></p><p id="49737827-6ce5-44a3-a1a9-8e5b448720d4" class=""><strong>The chains of operations between loop registers</strong> determine the performance-limiting data dependencies.</p><hr id="3dc953e1-b1db-4505-96fb-205bb4c78427"/><p id="30d7e151-014d-4a20-953c-f5cb11f841c2" class="">In data-flow graph, <strong>white colored operators</strong> indicate that they are<strong> not part of some dependencies</strong> between loop registers.</p><p id="c75757c8-e014-4dbc-9d43-dfb73b33e09b" class=""><em>(example : </em><em><code>cmp</code></em><em> and </em><em><code>jne</code></em><em> operations in </em><em><code>combine4</code></em><em>. We assume that checking branch condition can be done quickly enough that it doesn’t slow down the processor.)</em></p><figure id="5e3a2653-c8c2-437c-b8e5-5823507f5fc3" class="image"><a href="/assets/images/CSAPP-5/Untitled%2010.png"><img style="width:336px" src="/assets/images/CSAPP-5/Untitled%2010.png"/></a></figure><p id="db3501fe-a6be-4d89-9cb6-bbbc2f681ba8" class="">In more simplified data-flow graph, the operators that were colored white are eliminated, <strong>retaining only the loop registers</strong>. </p><p id="5b029a0a-cf8b-4cf7-a113-817bed99a8b2" class="">Along one side, we see the <strong>dependencies between successive values of program value </strong><strong><code>acc</code></strong>, stored in register <code>%xmm0</code>. The loop computes a new value for <code>acc</code> by <strong>multiplying </strong>the old value by a data element, generated by the <strong><code>load</code></strong><strong> </strong>operation.</p><p id="f5e796ee-ed92-42e0-9f6f-fb897f9ec6c2" class="">Along the other side, we see the <strong>dependencies between successive values of the pointer to the </strong><strong><em>i</em></strong><strong>th data element</strong>. On each iteration, the old value is used as the address for the <strong><code>load</code></strong><strong> </strong>operation, and it is also incremented by the <strong><code>add</code></strong><strong> </strong>operation to compute its new value.</p><p id="67eb2152-4248-4ac4-9690-de5b8cd8b649" class="">As we see the data-flow representation of <em>n</em> iterations by the inner loop of <code>combine4</code>, we can see that the program has <strong>two chains of data dependencies</strong>, corresponding to the <strong>updating of </strong><strong><code>acc</code></strong> <strong>and </strong><strong><code>data+i</code></strong><strong> with operations </strong><strong><code>mul</code></strong><strong> and </strong><strong><code>add</code></strong>.</p><p id="d8ca4dd3-d02c-4842-a6aa-2baed44db260" class=""><strong>Floating-point multiplication has a latency of 5 cycles</strong>, while <strong>integer addition has a latency of 1 cycle →</strong> <strong>The chain on the left will form a critical path</strong>, requiring <strong><em>5n</em></strong><strong> </strong>cycles to execute.</p><p id="384c2711-2f39-470c-a4ec-824b22ccfdd1" class="">The other operations required during the loop proceed in parallel with the multiplication.</p><p id="fe52d9f1-77a1-4774-8edf-32099e292336" class="">For other combinations of data type and operation where the operations has a <strong>latency </strong><strong><em>L</em></strong><strong> greater than 1</strong>, the measured <strong>CPE is simply </strong><strong><em>L →</em></strong> <strong>This chain forms the performance-limiting critical path</strong>.</p><ul id="5651f41b-0fff-4bb0-b4f0-de194c656e33" class="bulleted-list"><li style="list-style-type:disc"><strong>Other Performance Factors</strong></li></ul><p id="91592a6d-5d04-4741-800f-6c0105e0b398" class="">For <strong>integer addition</strong>, our measurements of <code>combine4</code> show a CPE of <strong>1.27</strong>, slower than the 1.00 → The <strong>critical paths</strong> in a data-flow representation provide <strong>only a lower bound</strong> on how many cycles a program will require. </p><p id="0c5a5546-6c90-4240-aefe-2085d33fa667" class=""><strong>Other factors</strong> can also limit performance, including the total number of functional units available, and the number of data values that can be passed among the functional units</p><p id="4385a3c8-9443-4d87-92d6-f31d68a6c2fe" class="">We can restructure the operations to enhance <strong>instruction-level parallelism</strong>, so that our only limitation becomes the throughput bound.</p></details></li></ul></div><h2 id="10b18d42-4afe-4239-8c99-920f9d4ad0c5" class=""><details open=""><summary><mark class="highlight-blue">5.8</mark> Loop Unrolling</summary></details></h2><div class="indented"><ul id="a0971658-4a52-4ec1-b3d2-3e779ae2a106" class="toggle"><li><details open=""><summary><strong>Loop Unrolling</strong></summary><p id="f8fcddb7-a57c-45d7-b264-476260690c12" class=""><strong>Loop unrolling </strong>is a program transformation that <strong>reduces the number of iterations </strong>for a loop by <strong>increasing the number of elements computed on each iteration.</strong></p><p id="93022c57-9384-48f4-8d35-37bd21c4b416" class="">Loop unrolling improves performance by <strong>reducing the number of operations that do not contribute directly to the program result</strong>, <em>(example : loop indexing, conditional branching)</em> and <strong>exposing ways to further transform the code </strong>to reduce the number of operations in critical path.</p><p id="6a2e090f-a236-43b8-b08d-f35c4e3d1d1a" class="">To do <strong>k * 1 loop unrolling, </strong>we do following things :</p><ul id="410967a6-8cbe-4e39-aad8-fcb333001fa9" class="bulleted-list"><li style="list-style-type:disc">Set the <strong>upper limit </strong>to be <strong><em>n - k + 1.</em></strong></li></ul><ul id="15806c04-7480-4336-97e8-aff3fafe9365" class="bulleted-list"><li style="list-style-type:disc">Within the loop, apply the <strong>combining operation </strong>to elements <strong><em>i </em></strong><strong>through </strong><strong><em>i + k - 1.</em></strong></li></ul><ul id="0d77a4bb-49c4-4f46-b26c-e268ef166a09" class="bulleted-list"><li style="list-style-type:disc"><strong>Loop index </strong><strong><em>i</em></strong> is <strong>incremented by </strong><strong><em>k </em></strong>in each iteration. </li></ul><ul id="3ea7d113-b4de-440b-930b-00021a39d2cd" class="bulleted-list"><li style="list-style-type:disc">Include <strong>second loop </strong>to step through the final few elements of the vector.</li></ul><p id="ed33693d-abeb-4428-a05e-c215b2cd554f" class="">Since this transformation unrolls <strong>by a factor of </strong><strong><em>k</em></strong><strong> </strong>but accumulate values in a <strong>single </strong>variable <code>acc</code>, it’s called <strong>k * 1 loop unrolling</strong>.</p></details></li></ul><ul id="04c399d5-2ebe-436d-a4b8-38dd19634277" class="toggle"><li><details open=""><summary><code><strong>combine5</strong></code><strong><strong> : Applying 2 * 1 Loop Unrolling</strong></strong></summary><pre id="19acd7fa-8b75-4100-ab54-f8eac678cb98" class="code"><code>/* 2 X 1 loop unrolling */
void combine5(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); 
	long limit = length - 1;
	data_t *data = get_vec_start(v);
	data_t acc = IDENT;

	/* Combine 2 elements at a time */
	for(i = 0; i &lt; limit; i+=2){
		acc = (acc OP data[i]) OP data[i+1]; // accumulate result in acc
  }

	/* Finish any remaining elements */
	for (; i &lt; length; i++){
		acc = acc OP data[i];
	}
	*dest = acc;
}</code></pre><ul id="5f10c58a-0c40-42a1-a6e9-7f9216c45499" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance Improvement</strong></li></ul><table id="86cec0b9-1950-4865-80ca-b708d4d60dbc" class="simple-table"><tbody><tr id="662dbb0a-c44b-4c0a-803c-6b34242c5f0a"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="2d6ad202-b575-4943-9a89-0019b006b3d2"><td id="~PDO"><code>combine4</code></td><td id="be\]">No unrolling</td><td id="G_ZI">1.27</td><td id="zW_I">3.01</td><td id="\VI}">3.01</td><td id="mW|u">5.01</td></tr><tr id="59e5c76f-7208-4170-8afe-5616e7208d85"><td id="~PDO"><code>combine5</code></td><td id="be\]">2 * 1 unrolling</td><td id="G_ZI">1.01</td><td id="zW_I">3.01</td><td id="\VI}">3.01</td><td id="mW|u">5.01</td></tr><tr id="97767286-4a1c-47c3-8dc6-8c719ee3c2a5"><td id="~PDO"></td><td id="be\]">3 * 1 unrolling</td><td id="G_ZI">1.01</td><td id="zW_I">3.01</td><td id="\VI}">3.01</td><td id="mW|u">5.01</td></tr></tbody></table><p id="37046904-78ab-404e-a399-f2b55ce9036b" class="">Loop unrolling <strong>reduced the number of overhead operations </strong>relative to the number of additions for computing vector sum → Integer addition reached its <strong>latency bound </strong>too.</p></details></li></ul><ul id="805dde35-619a-494d-880a-0ee04fa0b605" class="toggle"><li><details open=""><summary><strong>Why k * 1 Loop Unrolling Can’t Improve Performance Beyond the Latency Bound</strong></summary><figure id="477ba62d-e604-44ce-a73d-421611478b72" class="image"><a href="/assets/images/CSAPP-5/Untitled%2011.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled%2011.png"/></a></figure><figure id="d0ecc7e5-de32-46c3-bf6c-9e03b0aa38f4" class="image"><a href="/assets/images/CSAPP-5/Untitled%2012.png"><img style="width:528px" src="/assets/images/CSAPP-5/Untitled%2012.png"/></a></figure><p id="c5e021e2-c9df-4374-a9d0-66ecdc92d519" class="">The loop unrolling leads to<strong> two </strong><strong><code>vmulsd</code></strong><strong> instructions</strong> - one to add <code>data[i]</code> to <code>acc</code>, and the second to add <code>data[i+1]</code> to <code>acc</code>. </p><p id="d35d54d9-2027-425d-a9ee-76602f08611c" class="">We see that <code>%xmm0</code> gets read and written twice in each execution of the loop. → If we <strong>execute one iteration </strong><strong><em>n/2</em></strong><strong> times</strong>, there is still a<strong> critical path of </strong><strong><em>n </em></strong><strong><code>mul</code></strong><strong> operations</strong>.</p></details></li></ul></div><h2 id="e1977142-7d23-49b4-b596-f90da62dcefd" class=""><details open=""><summary><mark class="highlight-blue">5.9</mark> Enhancing Parallelism</summary></details></h2><div class="indented"><ul id="dca8cdae-604e-4059-b46f-67aa6cc70e21" class="toggle"><li><details open=""><summary><code>combine6</code> : <strong>Multiple Accumulators - 2 * 2 Loop Unrolling</strong></summary><p id="25a17418-0eae-4da4-a49b-56b01a926562" class="">We can improve performance by <strong>splitting the set of combining operations </strong>and combining the results at the end for a operation that is<strong> associative </strong>and <strong>commutative</strong>.</p><p id="6efce65f-e895-43ed-a48a-ebb5a65f30b2" class="">For example, let <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">P_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> denote the product of elements of <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> : <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>n</mi></msub><mo>=</mo><msubsup><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_n=\prod_{i=1}^{n-1}{a_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span></p><p id="7ab79882-1bee-4ba6-ab81-f1192938b574" class="">Then, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>n</mi></msub><mo>=</mo><mi>P</mi><msub><mi>E</mi><mi>n</mi></msub><mo>×</mo><mi>P</mi><msub><mi>O</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">P_n=PE_n\times PO_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>, where <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mi>n</mi></msub><mo>=</mo><msubsup><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>n</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>a</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_n=\prod_{i=0}^{n/2-1}{a_{2i}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.32761em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0278999999999998em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mtight">/2</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> and <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>O</mi><mi>n</mi></msub><mo>=</mo><msubsup><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>n</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn></mrow></msubsup><msub><mi>a</mi><mrow><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">PO_n=\prod_{i=0}^{n/2-1}{a_{2i+1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.32761em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0278999999999998em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mtight">/2</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>.</p><p id="1a750a30-6cdd-4f19-b61c-89747d3cfa82" class=""><strong><code>combine6</code></strong><strong> </strong>uses both <strong>two-way loop unrolling</strong> to combine more elements per iteration, and <strong>two-way parallelism</strong> by accumulating elements with even indices in <strong><code>acc0</code></strong><strong> </strong>and elements with odd indices in <strong><code>acc1</code></strong>. → <strong>2 * 2 Loop Unrolling</strong></p><pre id="f7a02874-1b22-48a9-b2ee-f3e5834aadbd" class="code"><code>/* 2 X 2 loop unrolling */
void combine6(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); 
	long limit = length - 1;
	data_t *data = get_vec_start(v);
	data_t acc0 = IDENT;
	data_t acc1 = IDENT;

	/* Combine 2 elements at a time */
	for(i = 0; i &lt; limit; i+=2){
		acc0 = acc0 OP data[i];
		acc1 = acc1 OP data[i+1];
  }

	/* Finish any remaining elements */
	for (; i &lt; length; i++){
		acc0 = acc0 OP data[i];
	}
	*dest = acc0 OP acc1;
}</code></pre><ul id="0cb63327-edff-49e8-ac9d-723ee71d8c3b" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance Improvement</strong></li></ul><table id="0fc73f75-5d28-426e-9b22-1e7843a53b9f" class="simple-table"><tbody><tr id="542d1d32-12a0-4b1f-bf5f-ec2c596b62f8"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="261f2124-2527-43d5-b4a7-b1b159b89a43"><td id="~PDO"><code>combine5</code></td><td id="be\]">2 * 1 unrolling</td><td id="G_ZI">1.01</td><td id="zW_I">3.01</td><td id="\VI}">3.01</td><td id="mW|u">5.01</td></tr><tr id="742b5abe-0c1e-4c26-b16b-05a988231b55"><td id="~PDO"><code>combine6</code></td><td id="be\]">2 * 2 unrolling</td><td id="G_ZI">0.81</td><td id="zW_I">1.51</td><td id="\VI}">1.51</td><td id="mW|u">2.51</td></tr></tbody></table><p id="9afeea2a-b4c4-469c-8336-c93edaa3d3ee" class="">The barrier imposed by the <strong>latency bound</strong> is <strong>broken!</strong></p><ul id="a671d7d1-04cb-4e02-8c40-4086687a87a6" class="bulleted-list"><li style="list-style-type:disc"><strong>Data-flow graph of </strong><strong><code>combine6</code></strong></li></ul><figure id="3ec9781e-6d19-495a-a353-503df5384cce" class="image"><a href="/assets/images/CSAPP-5/Untitled%2013.png"><img style="width:624px" src="/assets/images/CSAPP-5/Untitled%2013.png"/></a></figure><p id="9fd3e185-b715-4ed7-80f4-0f3704158680" class="">As with <code>combine5</code>, <code>combine6</code> contains <strong>two </strong><strong><code>vmulsd</code></strong><strong> operations</strong>, but there is <strong>no dependency between them</strong>. → We now have <strong>two critical paths</strong>, one corresponding to computing the product of <code>acc0</code> and one for <code>acc1</code>.</p><p id="22fed6ea-cfdc-4073-ab71-e86737e6baaa" class="">If we execute one iteration <em>n/2</em> times, <strong>each of these critical paths contains only </strong><strong><em>n/2</em></strong><strong> operations</strong>, leading to a CPE of around 5.00/2 = 2.50.</p><p id="f9b47fd5-79b8-49b1-8a3d-3cba6b796a54" class="">A similar analysis explains our observed CPE of around <strong><em>L/2</em></strong> for operations with latency <em>L.</em></p><p id="ac54b417-d665-48de-9878-a3715d3457ba" class="">Programs are <strong>exploiting the capabilities of the functional units</strong> to increase their utilization by a factor of 2.</p></details></li></ul><ul id="a950c319-5375-4408-ab19-c679730da670" class="toggle"><li><details open=""><summary><strong>k * k Loop Unrolling</strong></summary><p id="24424326-e236-4fdd-8d81-0dcc06da44a5" class="">We can generalize the transformation to <strong>unroll the loop by a factor of </strong><strong><em>k</em></strong><strong> </strong>and <strong>accumulate </strong><strong><em>k</em></strong><strong> values in parallel</strong>, yielding <strong>k * k loop unrolling</strong>.</p><figure id="2cdef58b-ec5b-400b-9762-71bb688c6eec" class="image"><a href="/assets/images/CSAPP-5/Untitled%2014.png"><img style="width:559px" src="/assets/images/CSAPP-5/Untitled%2014.png"/></a></figure><p id="b1465750-c8ae-41ab-b73b-7b5907d1289b" class="">All of the CPEs improve with this transformation, achieving near their <strong>throughput bounds</strong>.</p><p id="bafb941c-fbff-4851-9231-e9d29701969a" class="">In general, a program achieve the throughput bound only when it can <strong>keep the pipelines filled for all functional units</strong> capable of performing that operation - For an operation with latency <em>L</em> and capacity<em> C</em>, this requires an unrolling factor <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>≥</mo><mi>C</mi><mo>∗</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">k \ge C*L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83041em;vertical-align:-0.13597em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span></span></span></span></span><span>﻿</span></span>.</p><ul id="cbf4fe5c-ef7e-4035-91d3-ea8084385568" class="bulleted-list"><li style="list-style-type:disc"><strong>k * k Loop Unrolling’s Side effect</strong></li></ul><p id="c2f1d046-3bef-4410-a05e-9004a3743d35" class="">Integer addition and multiplication is commutative and associative - The result computed by <code>combine6</code> will be identical to that computed by <code>combine5</code> for all possible conditions.</p><p id="2f36d5a9-9d34-45d2-9aa6-4604bb84be58" class="">Floating-point multiplication and addition are not associative - <code>combine6</code> could produce different results with <code>combine5</code>.</p><p id="9a8976ce-083a-451b-be99-46356f46eaa0" class="">For example, if <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>’s element with even indices are very large, and those with odd indices are very close to 0.0, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">PE_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> might <strong>overflow </strong>or <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>O</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">PO_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> might <strong>underflow</strong>, even though computing <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">P_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> proceeds normally.</p><p id="0ad29a13-617e-4e4c-a896-1fd560520a64" class="">Therefore, some compilers do k * k loop unrolling or similar transformation on integer operations, while most compilers <strong>don’t attempt such transformations with floating-point code</strong>.</p></details></li></ul><ul id="68f2c4cd-4470-4de4-9f99-80be641cfa9c" class="toggle"><li><details open=""><summary><code>combine7</code> : <strong>Reassociation Transformation - 2 * 1a Loop Unrolling</strong></summary><pre id="7f06b50f-6d93-4fe0-b54b-cf4d5ba32e98" class="code"><code>/* 2 X 1a loop unrolling */
void combine7(vec_ptr v, data_t *dest){
	long i;
	long length = vec_length(v); 
	long limit = length - 1;
	data_t *data = get_vec_start(v);
	data_t acc = IDENT;
	
	/* Combine 2 elements at a time */
	for(i = 0; i &lt; limit; i+=2){
		acc = acc OP (data[i] OP data[i+1]);
  }

	/* Finish any remaining elements */
	for (; i &lt; length; i++){
		acc = acc OP data[i];
	}
	*dest = acc;
}</code></pre><p id="f3c73776-693e-46bc-b293-93fed1635134" class=""><code>combine7</code> differs from <code>combine5</code> only in the way the elements are combined in inner loop : <code>acc = (acc OP data[i]) OP data[i+1];</code> to <code>acc = acc OP (data[i] OP data[i+1]);</code>.</p><p id="9c28315e-9359-4c28-b060-f27479aa8c97" class="">We call this transformation as <strong>reassociation transformation</strong>, since the parentheses <strong>shift the order the vector elements are combined with </strong><strong><code>acc</code></strong>, yielding <strong>2 * 1a loop unrolling</strong>. </p><ul id="d9bd92bd-5d5e-4bc1-826f-91d8409cf2a0" class="bulleted-list"><li style="list-style-type:disc"><strong>Performance Improvement</strong></li></ul><table id="8fc1a2c0-db25-4f4b-84b0-fe3ab90ba062" class="simple-table"><tbody><tr id="614cb67e-f7dc-4c48-b480-51740d4e25f8"><td id="~PDO">Function</td><td id="be\]">Method</td><td id="G_ZI">Integer +</td><td id="zW_I">Integer *</td><td id="\VI}">Floating Point +</td><td id="mW|u">Floating Point *</td></tr><tr id="b18cff9f-8f3a-4b11-88b6-53985376864d"><td id="~PDO"><code>combine5</code></td><td id="be\]">2 * 1 unrolling</td><td id="G_ZI">1.01</td><td id="zW_I">3.01</td><td id="\VI}">3.01</td><td id="mW|u">5.01</td></tr><tr id="470d743c-9f5b-477a-be39-642b7977ab2b"><td id="~PDO"><code>combine6</code></td><td id="be\]">2 * 2 unrolling</td><td id="G_ZI">0.81</td><td id="zW_I">1.51</td><td id="\VI}">1.51</td><td id="mW|u">2.51</td></tr><tr id="5eeb8912-baf6-4a88-b9ed-7f6cb286811f"><td id="~PDO"><code>combine7</code></td><td id="be\]">2 * 1a unrolling</td><td id="G_ZI">1.01</td><td id="zW_I">1.51</td><td id="\VI}">1.51</td><td id="mW|u">2.51</td></tr></tbody></table><p id="a606f918-23c7-4471-be19-66ef160312b1" class="">Most cases match the performance of <code>combine6</code>, breaking through the barrier imposed by the latency bound.</p><ul id="c2f9d138-fbf0-49be-8c95-789482109f30" class="bulleted-list"><li style="list-style-type:disc"><strong>Data-flow graph of </strong><strong><code>combine7</code></strong></li></ul><figure id="5e340fe3-b8ba-4dfa-8694-e74c64a60b1f" class="image"><a href="/assets/images/CSAPP-5/Untitled%2015.png"><img style="width:528px" src="/assets/images/CSAPP-5/Untitled%2015.png"/></a></figure><p id="b249384b-f5e1-4f27-9581-3e65d13fe844" class="">As with <code>combine5</code>, <code>combine6</code> contains two <code>vmulsd</code> operations - the first <code>mul</code> multiplies <code>data[i]</code> and <code>data[i+1]</code>, and the second multiplies the result by <code>acc</code>.</p><p id="d7fb4c1c-0043-4658-8d47-e26545c7c313" class="">However, <strong>only one of the </strong><strong><code>mul</code></strong><strong> operations forms a data-dependency chain between loop registers </strong>- the first multiplication within each iteration can be performed without waiting for the <code>acc</code> from the previous iteration. → We reduce the minimum CPE by a factor of 2.</p><p id="ec939f67-608d-4883-9f2e-ca6ca8175fba" class="">
</p></details></li></ul><ul id="5f801b10-7456-45ab-a185-814d54644220" class="toggle"><li><details open=""><summary><strong>k * 1a Loop Unrolling</strong></summary><figure id="b7018c7b-6848-485f-8349-47f1c6db0053" class="image"><a href="/assets/images/CSAPP-5/Untitled%2016.png"><img style="width:552px" src="/assets/images/CSAPP-5/Untitled%2016.png"/></a></figure><p id="9bc981b8-8235-476c-94d5-ba90e55b439a" class=""><strong>k * 1a loop unrolling</strong> yields performance results similar to k * k loop unrolling, all of CPEs achieving near their <strong>throughput bounds</strong>.</p><ul id="a51d83fa-ed6a-4d70-b7a2-878b2093497c" class="bulleted-list"><li style="list-style-type:disc"><strong>k * 1a Loop Unrolling’s Side effect</strong></li></ul><p id="0f7cdc48-80b6-4637-b28d-02ece1289ae6" class="">Since reassociation transformation changes the order of operations, k * 1a loop unrolling might have a <strong>different result for non-associative operations</strong>. <em>(example : float-point codes)</em></p><p id="9ee996ca-8a61-4c5e-8246-3aba24732fe4" class="">Therefore, most compilers won’t attempt any reassociations of <strong>floating-point</strong> operations.</p><ul id="81e613c5-2766-4f06-a5a4-31a0aa302b67" class="bulleted-list"><li style="list-style-type:disc"><strong>k * 1a Loop Unrolling vs. k * k Loop Unrolling</strong></li></ul><p id="e5005860-b1e2-4fa5-b214-4ece55eeb5a3" class="">In general, <strong>k * k loop unrolling</strong> is a <strong>more reliable</strong> way to achieve improved program performance.</p><p id="edf686b1-2e19-42e9-bb4b-5ba0725826b7" class="">
</p></details></li></ul></div><h2 id="310f5d63-298c-46d5-af47-0b67c5f36535" class=""><details open=""><summary><mark class="highlight-blue">5.10</mark> Summary of Results for Optimizing Combining Code</summary></details></h2><div class="indented"><p id="19a5a493-5873-413b-8a0f-4934eb46de12" class="">By using multiple optimizations, we have been able to achieve CPEs close to the <strong>throughput bounds</strong> of 0.5 and 1.00, <strong>limited only by the capacities</strong> of the functional units.</p><p id="1a71f518-ddbb-44eb-a949-2c7ae7d6322a" class="">
</p></div><h2 id="67c28300-dd5b-43f9-9c13-763aeb2f78f8" class=""><details open=""><summary><mark class="highlight-blue">5.11</mark> Some Limiting Factors</summary></details></h2><div class="indented"><ul id="4ed1404d-18fd-4211-b0eb-92810ced13c9" class="toggle"><li><details open=""><summary><strong>Register Spilling</strong></summary><p id="df4564dd-295d-42b3-9913-8978fc5a7f2e" class="">If a program has a degree of parallelism <em>P</em> that <strong>exceeds the number of available registers</strong>, then the compiler will resort to <strong>spilling</strong>, storing some temporary values in <strong>run-time stack</strong>.</p><ul id="99c2d842-0cc4-4ea4-9583-28f18b519ffc" class="bulleted-list"><li style="list-style-type:disc">Example : 10 * 10 loop unrolling &amp; 20 * 20 loop unrolling</li></ul><figure id="c63125da-2812-43f2-bb98-c59d93fddd17" class="image"><a href="/assets/images/CSAPP-5/Untitled%2017.png"><img style="width:480px" src="/assets/images/CSAPP-5/Untitled%2017.png"/></a></figure><figure id="ad80aa3b-2596-4618-ab32-a902e08830d8" class="image"><a href="/assets/images/CSAPP-5/Untitled%2018.png"><img style="width:432px" src="/assets/images/CSAPP-5/Untitled%2018.png"/></a></figure><p id="ffcee128-6986-490f-af57-6e3c64a5cf70" class="">Once a compiler must resort to register spilling, the advantage of maintaining multiple accumulators will most likely to be <strong>lost</strong>.</p></details></li></ul><ul id="355aa75c-6687-43ff-9743-11770523361a" class="toggle"><li><details open=""><summary><strong>Branch Prediction and Misprediction Penalties</strong></summary><p id="e69155db-7c0a-490c-b309-b2328e220ee6" class=""><strong>Misprediction penalty</strong> is incurred when the processor <strong>discard all of the speculatively executed results</strong> and <strong>restart the instruction fetch</strong> process at the correct location.</p><p id="e7907b46-08da-4956-ad91-7ab1be857096" class="">How can a C programmer <strong>reduce branch misprediction penalties</strong>?</p><ol type="1" id="cf36822e-0f5a-47c3-bd94-f4e910499f66" class="numbered-list" start="1"><li><strong>Do Not Be Overly Concerned about Predictable Branches</strong></li></ol><p id="a24a4d46-0657-47fd-8557-7526ab02555e" class="">The branch prediction logic of modern processors is very good at <strong>discerning regular patterns and long-term trends</strong> for the different branch instructions.</p><p id="91f0f0ef-be51-4c93-9a65-e982e1733c63" class=""><em>(example : </em><em><mark class="highlight-blue"><strong>5.5</strong></mark></em><em>’s </em><em><code>combine3</code></em><em> has no apparent performance improvement because processor is already able to predict outcomes of the branch.)</em></p><ol type="1" id="8425a2ef-f2f4-4403-8198-f07fa34e0cdf" class="numbered-list" start="2"><li><strong>Write Code Suitable for Implementation with Conditional Moves</strong></li></ol><p id="26cbfda7-284c-41e8-95c2-b55f27138d61" class="">For <strong>unpredictable cases</strong>, program performance can be enhanced if the compiler can generate code using <strong>conditional data transfers</strong>, rather than conditional control transfers.</p><p id="02ac0dc9-e2cc-46cc-99d9-66792d828643" class="">GCC<strong> </strong>can generate conditional moves for code written in a more <strong>functional style </strong>- use conditional operations to <strong>compute values </strong>and then <strong>update the program state</strong> with these values. (↔<strong>imperative style</strong> - use conditionals to <strong>selectively update program state</strong>) </p><ul id="11cef7af-c009-439b-bb6c-1bd15856ac8f" class="bulleted-list"><li style="list-style-type:disc">example : <code>minmax1</code>(imperative) vs. <code>minmax2</code>(functional)</li></ul><pre id="4a773353-eba1-4f6a-91e7-8d447ce54d1f" class="code"><code>/* Rearrange two vectors so that for each i, b[i] &gt;= a[i] */
void minmax1(long a[], long b[], long n){
	long i;
	for (i = 0; i &lt; n; i++){
		if(a[i] &gt; b[i]){
			long t = a[i];
			a[i] = b[i];
			b[i] = t;
		}
	}
}

void minmax2(long a[], long b[], long n){
	long i;
	for (i = 0; i &lt; n; i++){
		long min = a[i] &lt; b[i] ? a[i] : b[i];
		long max = a[i] &lt; b[i] ? b[i] : a[i];
		a[i] = min;
		b[i] = max;
	}
}</code></pre><p id="ce076009-dae8-4bb3-afcc-8a51eef879a9" class="">Not all conditional behavior can be implemented with conditional data transfers, however, programmers can sometimes <strong>make code more amenable to translation into conditional data transfers</strong>.</p><p id="3ad206f0-e368-4ad4-ad41-f2c7f7ecea8b" class="">
</p></details></li></ul></div><h2 id="a9364031-94c3-4eaf-90dd-99c1ae4b5ba3" class=""><details open=""><summary><mark class="highlight-blue">5.12</mark> Understanding Memory Performance</summary></details></h2><div class="indented"><ul id="2b725f74-55a5-40ff-8361-7f148b08994a" class="toggle"><li><details open=""><summary><strong>Load / Store Functional Unit</strong></summary><p id="f6c1f333-0d1e-47a8-a878-7b3a257557d9" class="">Modern processor’s functional units for load and store operations have <strong>internal buffers</strong> to <strong>hold sets of requests</strong> for memory operations.</p><p id="ca74e772-b7d1-4c56-ad50-ebc1aea03f78" class="">Our reference machine has <strong>two load units</strong>, each of which can hold up to <strong>72 pending read requests</strong>, and <strong>one store unit</strong> with a store buffer containing up to <strong>42 write requests</strong>. </p></details></li></ul><ul id="11c41f64-c81e-47d6-b5a9-789e0ab9a9ae" class="toggle"><li><details open=""><summary><strong>Load Performance</strong></summary><p id="195a6e3a-33cc-427c-8a2e-bb9d3d35b1b6" class="">To determine the latency of the load operation on a machine, we set up a computation with a sequence of load operations as below :</p><pre id="3c940d47-f959-4f68-b06a-5fd9e3c98673" class="code"><code>/* Linked List */
typedef struct ELE { 
	struct ELE *next;
	long data;
} list_ele, *list_ptr;
/* Return Length of Linked List */
long list_len(list_ptr ls){
	long len = 0;
	while (ls) {
		len++;
		ls = ls-&gt;next;
	}
	return len;
}</code></pre><ul id="6df82639-3095-4993-bc94-0307621b1bf9" class="bulleted-list"><li style="list-style-type:disc">Assembly code for the loop</li></ul><figure id="63df5402-b99e-49c9-9c2b-2daaec38e2ef" class="image"><a href="/assets/images/CSAPP-5/Untitled%2019.png"><img style="width:432px" src="/assets/images/CSAPP-5/Untitled%2019.png"/></a></figure><p id="77cbb352-42f0-4eb9-a16d-87cffebb236a" class="">The load operation on line 3 forms the<strong> critical bottleneck</strong> in the loop - the load operation for one iteration <strong>can’t begin until one for the previous iteration has completed</strong>.</p><p id="2ccd5571-9a47-4576-8019-85ce511b9eb9" class="">The <strong>measured CPE</strong> of <code>list_len</code> is 4.00 - matches the documented access time of 4 cycles for the reference machine’s <strong>L1 cache</strong>. </p><p id="87e7cdf9-6ee0-4251-b1c7-45dcd034e97a" class="">
</p></details></li></ul><ul id="b5b0e275-45a8-4f46-896f-a74eb674a6bf" class="toggle"><li><details open=""><summary><strong>Store Performance</strong></summary><p id="35ee0bc2-fc65-49a2-8262-9edc27af004f" class="">In most cases, store operation can operate in a <strong>fully pipelined mode</strong>, and doesn’t affect any register values - Only a <strong>load operation </strong>is affected by the result of a store operation.</p><pre id="9b1440cf-f922-45f9-89fc-b25a1ed363f0" class="code"><code>/* Write to dest, read from src */
void write_read(long* src, long *dst, long n){
	long cnt = n;
	long val = 0;
	
	while(cnt) {
		*dst = val;
		val = (*src) + 1;
		cnt--;
	}
}</code></pre><p id="87c0d0cf-5859-47c5-8741-8ef12e72566c" class="">If <code>src</code> and <code>dst</code> <strong>point to same memory space</strong>, each load by <code>*src</code> will yield the value stored by the previous execution of <code>*dst</code>. <em>(example : </em><code><em>write_read(&amp;a[0], &amp;a[0], 3)</em></code><em>)</em></p><p id="5b50d828-f9c0-4a18-98e5-91ad0f8f5083" class="">This example illustrates <strong>write/read dependency</strong> - <strong>the outcome of a memory read depends on a recent memory write.</strong></p><p id="b677161f-85e1-4b98-bc0c-690e4cca19de" class="">Write/read dependency leads to <strong>significant loss of performance</strong> - <code>write_read(&amp;a[0], &amp;a[1], 3)</code>&#x27;s CPE is measured as 1.3, while <code>write_read(&amp;a[0], &amp;a[0], 3)</code>&#x27;s CPE is measured as 7.3.</p><ul id="607d514a-5ce9-453c-9153-e61ba91abf9b" class="bulleted-list"><li style="list-style-type:disc"><strong>Detail of load and store units</strong></li></ul><figure id="86985a12-0fe4-4556-904b-17ccff1e9482" class="image"><a href="/assets/images/CSAPP-5/Untitled%2020.png"><img style="width:384px" src="/assets/images/CSAPP-5/Untitled%2020.png"/></a></figure><p id="e73393f2-f07e-4c92-895f-40b2f2340e90" class="">The store unit includes a <strong>store buffer</strong> containing the <strong>address </strong>and <strong>data </strong>of the store operations that have been issued to the store unit, but have not yet been completed.</p><p id="3950f5cd-e4bb-4c33-a46e-205fd25e973b" class="">When a <strong>load operation</strong> occurs, it must <strong>check the entries in the store buffer for matching addresses</strong> - If it finds a match, it <strong>retrieves the corresponding data entry as the result of the load operation</strong>. </p><ul id="1fc9d242-7d2a-45b1-8c4a-a14dc9993755" class="bulleted-list"><li style="list-style-type:disc"><strong>Data-flow graph of </strong><code><strong>write_read</strong></code></li></ul><figure id="23c46580-af20-48a3-9264-0379fbd65d91" class="image"><a href="/assets/images/CSAPP-5/Untitled%2021.png"><img style="width:1235px" src="/assets/images/CSAPP-5/Untitled%2021.png"/></a></figure><p id="b46b872e-f3e7-4a8f-b190-73810f7ee144" class=""><code>movq %rax, (%rsi)</code> is translated into two operations: <strong><code>s_addr</code></strong><strong> </strong>computes the <strong>address </strong>for the store operation, creates an entry in the store buffer, and sets the <strong>address field</strong> for that entry. <strong><code>s_data</code></strong><strong> </strong>sets the <strong>data field</strong> for the entry.</p><p id="480b1f8d-2957-4e74-8c6f-6fff82a1e8b1" class="">There can be <strong>3 data dependencies</strong> between operations within inner loop of <code>write_read</code> :</p><ol type="1" id="fc4718fa-1e84-4237-8547-e3360c59eff8" class="numbered-list" start="1"><li><strong><code>s_addr</code></strong><strong> → </strong><strong><code>s_data</code></strong></li></ol><p id="31c79247-9914-46ea-b25f-af9281139205" class="">The address computation of the <code>s_addr</code> must precede <code>s_data</code>.</p><ol type="1" id="704484d1-42a4-4bd6-88d4-b4ec04d5f754" class="numbered-list" start="2"><li><strong><code>s_addr</code></strong><strong> → </strong><strong><code>load</code></strong></li></ol><p id="0aeaa2a7-37a8-4d81-a8bb-4ca2ca883113" class=""><code>load</code> generated by decoding <code>movq (%rdi), %rax</code> must <strong>check the addresses of any pending store operations</strong>.</p><ol type="1" id="a78cd7d5-8fa6-4c5f-8a63-ae458245216c" class="numbered-list" start="3"><li><strong><code>s_data</code></strong><strong> → </strong><strong><code>load</code></strong> (<strong>only when load and store addresses match</strong>)</li></ol><p id="7483a7dc-8b82-439b-8e5d-ef0b23c887f3" class="">If two addresses match, <code>load</code> must <strong>wait until </strong><strong><code>s_data</code></strong><strong> has deposited its result into the store buffer</strong>.</p><figure id="69a93b2a-0c46-401e-9a6a-72048f88fea8" class="image"><a href="/assets/images/CSAPP-5/Untitled%2022.png"><img style="width:1280px" src="/assets/images/CSAPP-5/Untitled%2022.png"/></a></figure><p id="361d08cb-5fea-4e6f-8063-f432eef19cc2" class="">Data-flow graph of <code>write_read</code> shows two chains of dependencies : one with data values being <strong>stored, loaded, and incremented</strong> (only for the case of <strong>matching addresses</strong>); and the one <strong>decrementing variable </strong><strong><code>cnt</code></strong><strong>.</strong></p><p id="76c84128-f158-45bd-b71c-1548f5614d7e" class="">With <strong>differing source and destination addresses</strong>, <code>load</code> and <code>store</code> can proceed independently → only critical path is formed by the <strong>decrementing of </strong><strong><code>cnt</code></strong><strong>,</strong> resulting in a CPE bound for <strong>1.0</strong>.</p><p id="9b34855c-fdd7-4e2e-afdb-2068208ac6b1" class="">With <strong>matching source and destination addresses</strong>, data dependency between <strong><code>s_data</code></strong><strong> and </strong><strong><code>load</code></strong><strong> causes a critical path</strong> → these <strong>three operations</strong> in sequence require a total of around <strong>7 clock cycles</strong>.</p><p id="6772dc66-bb7a-4b39-ac92-692cab3139cb" class="">
</p></details></li></ul></div><h2 id="d27de2e1-a15b-47ff-adfc-72323d042a5e" class=""><details open=""><summary><mark class="highlight-blue">5.13</mark> Life in the Real World: Performance Improvement Techniques</summary></details></h2><div class="indented"><p id="31de47e3-93e7-47df-94f0-5fae6674604a" class="">Basic strategies for <strong>optimizing program performance</strong></p><ul id="e7567aeb-497e-4335-8d40-692bd0737ab5" class="bulleted-list"><li style="list-style-type:disc">High-level design</li></ul><p id="ceed5a5b-ad22-42f6-9d9d-961be4d2563b" class="">Choose <strong>appropriate algorithms and data structures</strong>.</p><ul id="b9cf0f08-6b77-461c-ada7-771de49679e1" class="bulleted-list"><li style="list-style-type:disc">Basic coding principles : Avoid <strong>optimization blockers</strong><ul id="e5ec3220-b460-4d78-a2f8-d78ee6e3e300" class="bulleted-list"><li style="list-style-type:circle">Eliminate <strong>excessive function calls.</strong></li></ul><ul id="8736ae7f-ca28-4c62-a42a-f4f782a03973" class="bulleted-list"><li style="list-style-type:circle"><strong>Move computations out of loops</strong> when possible.</li></ul><ul id="fbeabe8b-fd66-4ac7-85f6-8a1821fef1d8" class="bulleted-list"><li style="list-style-type:circle">Eliminate <strong>unnecessary memory references</strong>.</li></ul></li></ul><ul id="0ef82a01-bc4f-40b7-9662-6d9aea80bb9b" class="bulleted-list"><li style="list-style-type:disc">Low-level optimizations<ul id="d5360a5b-ff67-4501-b3ca-b5ded8ca7bba" class="bulleted-list"><li style="list-style-type:circle"><strong>Unroll loops</strong> to reduce overhead and to enable further optimizations.</li></ul><ul id="0691df59-4bd1-468a-916f-f541a23dc9d5" class="bulleted-list"><li style="list-style-type:circle">Find ways to increase instruction-level parallelism by <strong>multiple accumulators</strong> and <strong>reassociation</strong>.</li></ul><ul id="a7e53ac0-b67f-4000-be3b-5bbb326a2f9a" class="bulleted-list"><li style="list-style-type:circle">Rewrite conditional operations in a <strong>functional style</strong> to enable compilation via <strong>conditional data transfers</strong>.</li></ul></li></ul><ul id="2985be98-150c-4830-9fd5-baecfa127928" class="bulleted-list"><li style="list-style-type:disc"><strong>Avoid introducing errors </strong>as you rewrite programs in the interest of inefficiency.</li></ul></div><h2 id="12426e20-371c-49bc-8886-ccab550eb4a8" class=""><details open=""><summary><mark class="highlight-blue">5.14</mark> Identifying and Eliminating Performance Bottlenecks</summary></details></h2><div class="indented"><p id="29ebcfaf-63ef-4fe6-904e-c5131bab961f" class="">When working with large programs, even knowing <strong>where to focus our optimization efforts</strong> can be difficult → use <strong>code profilers</strong>, analysis tools that collect performance data about a program as it executes!</p><p id="ff172818-8631-470a-8779-ae8643c76ea0" class=""><strong>Profiler </strong>helps us focus our attention on <strong>the most time-consuming parts</strong> of the program and also provides useful information about the <strong>procedure call structure</strong>.</p><p id="3ccee851-6489-403c-b0f3-4e96266edb7a" class="">In general, profiling can help us optimize for <strong>typical cases</strong>, assuming <strong>we run the program on representative data</strong>, but we should also make sure the program will have respectable performance <strong>for all possible cases</strong>.</p></div><p id="6817ddb9-b5de-41ad-945d-651f6fc8fcbf" class="">
</p></div></article></body></html>